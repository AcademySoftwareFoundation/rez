<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>rez.solver &mdash; Rez 2.112.0 documentation</title><link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> Rez
          </a>
              <div class="version">
                2.112
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/modules.html">1. API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../one-liners.html">2. One-Liners</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Rez</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">rez.solver</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for rez.solver</h1><div class="highlight"><pre>
<span></span><span class="c1"># SPDX-License-Identifier: Apache-2.0</span>
<span class="c1"># Copyright Contributors to the Rez Project</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The dependency resolving module.</span>

<span class="sd">This gives direct access to the solver. You should use the resolve() function</span>
<span class="sd">in resolve.py instead, which will use cached data where possible to provide you</span>
<span class="sd">with a faster resolve.</span>

<span class="sd">See SOLVER.md for an in-depth description of how this module works.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">from</span> <span class="nn">rez.config</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">rez.packages</span> <span class="kn">import</span> <span class="n">iter_packages</span>
<span class="kn">from</span> <span class="nn">rez.package_repository</span> <span class="kn">import</span> <span class="n">package_repo_stats</span>
<span class="kn">from</span> <span class="nn">rez.utils.logging_</span> <span class="kn">import</span> <span class="n">print_debug</span>
<span class="kn">from</span> <span class="nn">rez.utils.data_utils</span> <span class="kn">import</span> <span class="n">cached_property</span>
<span class="kn">from</span> <span class="nn">rez.vendor.pygraph.classes.digraph</span> <span class="kn">import</span> <span class="n">digraph</span>
<span class="kn">from</span> <span class="nn">rez.vendor.pygraph.algorithms.cycles</span> <span class="kn">import</span> <span class="n">find_cycle</span>
<span class="kn">from</span> <span class="nn">rez.vendor.pygraph.algorithms.accessibility</span> <span class="kn">import</span> <span class="n">accessibility</span>
<span class="kn">from</span> <span class="nn">rez.exceptions</span> <span class="kn">import</span> <span class="n">PackageNotFoundError</span><span class="p">,</span> <span class="n">ResolveError</span><span class="p">,</span> \
    <span class="n">PackageFamilyNotFoundError</span><span class="p">,</span> <span class="n">RezSystemError</span>
<span class="kn">from</span> <span class="nn">rez.vendor.version.version</span> <span class="kn">import</span> <span class="n">VersionRange</span>
<span class="kn">from</span> <span class="nn">rez.vendor.version.requirement</span> <span class="kn">import</span> <span class="n">VersionedObject</span><span class="p">,</span> <span class="n">Requirement</span><span class="p">,</span> \
    <span class="n">RequirementList</span>
<span class="kn">from</span> <span class="nn">rez.vendor.enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span><span class="p">,</span> <span class="n">chain</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>


<span class="c1"># a hidden control for forcing to non-optimized solving mode. This is here as</span>
<span class="c1"># first port of call for narrowing down the cause of a solver bug if we see one</span>
<span class="c1">#</span>
<span class="n">_force_unoptimised_solver</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;_FORCE_REZ_UNOPTIMISED_SOLVER&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">)</span>


<span class="c1"># the &#39;solver version&#39; is an internal version number that changes if the</span>
<span class="c1"># behaviour of the solver changes in a way that potentially changes the result</span>
<span class="c1"># of a solve.</span>
<span class="c1">#</span>
<span class="c1"># Solves are deterministic - given a known request and set of package repositories,</span>
<span class="c1"># the result should always be the same. However, bugfixes or intentional changes</span>
<span class="c1"># to solver behaviour might change the solve result. In  this case, there&#39;s a good</span>
<span class="c1"># chance that the benchmark.yaml workflow will fail, since it expects the same</span>
<span class="c1"># results as the previous workflow run.</span>
<span class="c1">#</span>
<span class="c1"># If the benchmark.yaml workflow fails, and you determine that the solver behaviour</span>
<span class="c1"># change is intentional and expected, then you need to update this version. The</span>
<span class="c1"># workflow will then succeed on its next run, because it will skip the check</span>
<span class="c1"># against the previous results, if the solver version differs.</span>
<span class="c1">#</span>
<span class="n">SOLVER_VERSION</span> <span class="o">=</span> <span class="mi">2</span>


<div class="viewcode-block" id="VariantSelectMode"><a class="viewcode-back" href="../../api/rez.html#rez.solver.VariantSelectMode">[docs]</a><span class="k">class</span> <span class="nc">VariantSelectMode</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Variant selection mode.&quot;&quot;&quot;</span>
    <span class="n">version_priority</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">intersection_priority</span> <span class="o">=</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="SolverStatus"><a class="viewcode-back" href="../../api/rez.html#rez.solver.SolverStatus">[docs]</a><span class="k">class</span> <span class="nc">SolverStatus</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Enum to represent the current state of a solver instance.  The enum</span>
<span class="sd">    also includes a human readable description of what the state represents.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">pending</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;The solve has not yet started.&quot;</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">solved</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;The solve has completed successfully.&quot;</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">exhausted</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;The current solve is exhausted and must be split to continue further.&quot;</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">failed</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;The solve is not possible.&quot;</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">cyclic</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;The solve contains a cycle.&quot;</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">unsolved</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;The solve has started, but is not yet solved.&quot;</span><span class="p">,</span> <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span></div>


<div class="viewcode-block" id="SolverCallbackReturn"><a class="viewcode-back" href="../../api/rez.html#rez.solver.SolverCallbackReturn">[docs]</a><span class="k">class</span> <span class="nc">SolverCallbackReturn</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Enum returned by the `callback` callable passed to a `Solver` instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">keep_going</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Continue the solve&quot;</span><span class="p">,)</span>
    <span class="n">abort</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Abort the solve&quot;</span><span class="p">,)</span>
    <span class="n">fail</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Stop the solve and set to most recent failure&quot;</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">_Printer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbosity</span><span class="p">,</span> <span class="n">buf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">suppress_passive</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">=</span> <span class="n">verbosity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suppress_passive</span> <span class="o">=</span> <span class="n">suppress_passive</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pending_sub</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pending_br</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_pr</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">txt</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="n">txt</span> <span class="o">%</span> <span class="n">args</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">subheader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">txt</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pending_sub</span> <span class="o">=</span> <span class="n">txt</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">txt</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_sub</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_pr</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pending_sub</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pending_sub</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_br</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="n">txt</span> <span class="o">%</span> <span class="n">args</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_pr</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pending_br</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">passive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">txt</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">suppress_passive</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">br</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pending_br</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">pr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">txt</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">txt</span> <span class="o">%</span> <span class="n">args</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">buf</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__nonzero__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="fm">__bool__</span> <span class="o">=</span> <span class="n">__nonzero__</span>  <span class="c1"># py3 compat</span>


<div class="viewcode-block" id="SolverState"><a class="viewcode-back" href="../../api/rez.html#rez.solver.SolverState">[docs]</a><span class="k">class</span> <span class="nc">SolverState</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represent the current state of the solver instance for use with a</span>
<span class="sd">    callback.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_solves</span><span class="p">,</span> <span class="n">num_fails</span><span class="p">,</span> <span class="n">phase</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_solves</span> <span class="o">=</span> <span class="n">num_solves</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_fails</span> <span class="o">=</span> <span class="n">num_fails</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;solve #</span><span class="si">%d</span><span class="s2"> (</span><span class="si">%d</span><span class="s2"> fails so far): </span><span class="si">%s</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_solves</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_fails</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="p">)))</span></div>


<span class="k">class</span> <span class="nc">_Common</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>


<div class="viewcode-block" id="Reduction"><a class="viewcode-back" href="../../api/rez.html#rez.solver.Reduction">[docs]</a><span class="k">class</span> <span class="nc">Reduction</span><span class="p">(</span><span class="n">_Common</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A variant was removed because its dependencies conflicted with another</span>
<span class="sd">    scope in the current phase.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">variant_index</span><span class="p">,</span> <span class="n">dependency</span><span class="p">,</span>
                 <span class="n">conflicting_request</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variant_index</span> <span class="o">=</span> <span class="n">variant_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dependency</span> <span class="o">=</span> <span class="n">dependency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conflicting_request</span> <span class="o">=</span> <span class="n">conflicting_request</span>

<div class="viewcode-block" id="Reduction.reducee_str"><a class="viewcode-back" href="../../api/rez.html#rez.solver.Reduction.reducee_str">[docs]</a>    <span class="k">def</span> <span class="nf">reducee_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="n">VersionedObject</span><span class="o">.</span><span class="n">construct</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
        <span class="n">idx_str</span> <span class="o">=</span> <span class="s2">&quot;[]&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant_index</span> <span class="ow">is</span> <span class="kc">None</span> \
            <span class="k">else</span> <span class="s2">&quot;[</span><span class="si">%d</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant_index</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span> <span class="o">+</span> <span class="n">idx_str</span></div>

<div class="viewcode-block" id="Reduction.involved_requirements"><a class="viewcode-back" href="../../api/rez.html#rez.solver.Reduction.involved_requirements">[docs]</a>    <span class="k">def</span> <span class="nf">involved_requirements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">range_</span> <span class="o">=</span> <span class="n">VersionRange</span><span class="o">.</span><span class="n">from_version</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">Requirement</span><span class="o">.</span><span class="n">construct</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">range_</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">req</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependency</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conflicting_request</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">version</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant_index</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">variant_index</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependency</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">dependency</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">conflicting_request</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">conflicting_request</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> (dep(</span><span class="si">%s</span><span class="s2">) &lt;--!--&gt; </span><span class="si">%s</span><span class="s2">)&quot;</span> \
            <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reducee_str</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependency</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conflicting_request</span><span class="p">)</span></div>


<div class="viewcode-block" id="DependencyConflict"><a class="viewcode-back" href="../../api/rez.html#rez.solver.DependencyConflict">[docs]</a><span class="k">class</span> <span class="nc">DependencyConflict</span><span class="p">(</span><span class="n">_Common</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A common dependency shared by all variants in a scope, conflicted with</span>
<span class="sd">    another scope in the current phase.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dependency</span><span class="p">,</span> <span class="n">conflicting_request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            dependency (`Requirement`): Merged requirement from a set of variants.</span>
<span class="sd">            conflicting_request (`Requirement`): The request they conflict with.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dependency</span> <span class="o">=</span> <span class="n">dependency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conflicting_request</span> <span class="o">=</span> <span class="n">conflicting_request</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dependency</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">dependency</span><span class="p">)</span> \
            <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conflicting_request</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">conflicting_request</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> &lt;--!--&gt; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dependency</span><span class="p">),</span>
                                  <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conflicting_request</span><span class="p">))</span></div>


<div class="viewcode-block" id="FailureReason"><a class="viewcode-back" href="../../api/rez.html#rez.solver.FailureReason">[docs]</a><span class="k">class</span> <span class="nc">FailureReason</span><span class="p">(</span><span class="n">_Common</span><span class="p">):</span>
<div class="viewcode-block" id="FailureReason.involved_requirements"><a class="viewcode-back" href="../../api/rez.html#rez.solver.FailureReason.involved_requirements">[docs]</a>    <span class="k">def</span> <span class="nf">involved_requirements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="FailureReason.description"><a class="viewcode-back" href="../../api/rez.html#rez.solver.FailureReason.description">[docs]</a>    <span class="k">def</span> <span class="nf">description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span></div></div>


<div class="viewcode-block" id="TotalReduction"><a class="viewcode-back" href="../../api/rez.html#rez.solver.TotalReduction">[docs]</a><span class="k">class</span> <span class="nc">TotalReduction</span><span class="p">(</span><span class="n">FailureReason</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;All of a scope&#39;s variants were reduced away.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reductions</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reductions</span> <span class="o">=</span> <span class="n">reductions</span>

<div class="viewcode-block" id="TotalReduction.involved_requirements"><a class="viewcode-back" href="../../api/rez.html#rez.solver.TotalReduction.involved_requirements">[docs]</a>    <span class="k">def</span> <span class="nf">involved_requirements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pkgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">red</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reductions</span><span class="p">:</span>
            <span class="n">pkgs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">red</span><span class="o">.</span><span class="n">involved_requirements</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">pkgs</span></div>

<div class="viewcode-block" id="TotalReduction.description"><a class="viewcode-back" href="../../api/rez.html#rez.solver.TotalReduction.description">[docs]</a>    <span class="k">def</span> <span class="nf">description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;A package was completely reduced: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reductions</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">reductions</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reductions</span><span class="p">)</span></div>


<div class="viewcode-block" id="DependencyConflicts"><a class="viewcode-back" href="../../api/rez.html#rez.solver.DependencyConflicts">[docs]</a><span class="k">class</span> <span class="nc">DependencyConflicts</span><span class="p">(</span><span class="n">FailureReason</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A common dependency in a scope conflicted with another scope in the</span>
<span class="sd">    current phase.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conflicts</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conflicts</span> <span class="o">=</span> <span class="n">conflicts</span>

<div class="viewcode-block" id="DependencyConflicts.involved_requirements"><a class="viewcode-back" href="../../api/rez.html#rez.solver.DependencyConflicts.involved_requirements">[docs]</a>    <span class="k">def</span> <span class="nf">involved_requirements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pkgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">conflict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conflicts</span><span class="p">:</span>
            <span class="n">pkgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conflict</span><span class="o">.</span><span class="n">dependency</span><span class="p">)</span>
            <span class="n">pkgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conflict</span><span class="o">.</span><span class="n">conflicting_request</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pkgs</span></div>

<div class="viewcode-block" id="DependencyConflicts.description"><a class="viewcode-back" href="../../api/rez.html#rez.solver.DependencyConflicts.description">[docs]</a>    <span class="k">def</span> <span class="nf">description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;The following package conflicts occurred: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conflicts</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">conflicts</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conflicts</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cycle"><a class="viewcode-back" href="../../api/rez.html#rez.solver.Cycle">[docs]</a><span class="k">class</span> <span class="nc">Cycle</span><span class="p">(</span><span class="n">FailureReason</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The solve contains a cyclic dependency.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">packages</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">packages</span> <span class="o">=</span> <span class="n">packages</span>

<div class="viewcode-block" id="Cycle.involved_requirements"><a class="viewcode-back" href="../../api/rez.html#rez.solver.Cycle.involved_requirements">[docs]</a>    <span class="k">def</span> <span class="nf">involved_requirements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pkgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">packages</span><span class="p">:</span>
            <span class="n">range_</span> <span class="o">=</span> <span class="n">VersionRange</span><span class="o">.</span><span class="n">from_version</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
            <span class="n">stmt</span> <span class="o">=</span> <span class="n">Requirement</span><span class="o">.</span><span class="n">construct</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">range_</span><span class="p">)</span>
            <span class="n">pkgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pkgs</span></div>

<div class="viewcode-block" id="Cycle.description"><a class="viewcode-back" href="../../api/rez.html#rez.solver.Cycle.description">[docs]</a>    <span class="k">def</span> <span class="nf">description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;A cyclic dependency was detected: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">packages</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">packages</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">stmts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">packages</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">packages</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="s2">&quot; --&gt; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">stmts</span><span class="p">))</span></div>


<div class="viewcode-block" id="PackageVariant"><a class="viewcode-back" href="../../api/rez.html#rez.solver.PackageVariant">[docs]</a><span class="k">class</span> <span class="nc">PackageVariant</span><span class="p">(</span><span class="n">_Common</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A variant of a package.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variant</span><span class="p">,</span> <span class="n">building</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a package variant.</span>

<span class="sd">        Args:</span>
<span class="sd">            variant (`Variant`): Package variant.</span>
<span class="sd">            building (bool): True if a build is occurring.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variant</span> <span class="o">=</span> <span class="n">variant</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">building</span> <span class="o">=</span> <span class="n">building</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant</span><span class="o">.</span><span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant</span><span class="o">.</span><span class="n">version</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant</span><span class="o">.</span><span class="n">index</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">requires_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        It is important that this property is calculated lazily. Getting the</span>
<span class="sd">        &#39;requires&#39; attribute may trigger a package load, which may be avoided if</span>
<span class="sd">        this variant is reduced away before that happens.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">requires</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant</span><span class="o">.</span><span class="n">get_requires</span><span class="p">(</span><span class="n">build_requires</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">building</span><span class="p">)</span>
        <span class="n">reqlist</span> <span class="o">=</span> <span class="n">RequirementList</span><span class="p">(</span><span class="n">requires</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">reqlist</span><span class="o">.</span><span class="n">conflict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ResolveError</span><span class="p">(</span>
                <span class="s2">&quot;The package </span><span class="si">%s</span><span class="s2"> has an internal requirements conflict: </span><span class="si">%s</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">reqlist</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">reqlist</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">request_fams</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">requires_list</span><span class="o">.</span><span class="n">names</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">conflict_request_fams</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">requires_list</span><span class="o">.</span><span class="n">conflict_names</span>

<div class="viewcode-block" id="PackageVariant.get"><a class="viewcode-back" href="../../api/rez.html#rez.solver.PackageVariant.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkg_name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">requires_list</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">version</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">index</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">version</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">index</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="n">VersionedObject</span><span class="o">.</span><span class="n">construct</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
        <span class="n">idxstr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">stmt</span><span class="p">),</span> <span class="n">idxstr</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">_PackageEntry</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The variants in a package.</span>

<span class="sd">    Holds some extra state data, such as whether the variants are sorted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package</span><span class="p">,</span> <span class="n">variants</span><span class="p">,</span> <span class="n">solver</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">package</span> <span class="o">=</span> <span class="n">package</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variants</span> <span class="o">=</span> <span class="n">variants</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">solver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sorted</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">package</span><span class="o">.</span><span class="n">version</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variants</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nvariants</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">nvariants</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variants</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">_PackageEntry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variants</span><span class="p">[:</span><span class="n">nvariants</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="p">)</span>
        <span class="n">next_entry</span> <span class="o">=</span> <span class="n">_PackageEntry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variants</span><span class="p">[</span><span class="n">nvariants</span><span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="p">)</span>
        <span class="n">entry</span><span class="o">.</span><span class="n">sorted</span> <span class="o">=</span> <span class="n">next_entry</span><span class="o">.</span><span class="n">sorted</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">entry</span><span class="p">,</span> <span class="n">next_entry</span>

    <span class="k">def</span> <span class="nf">sort</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sort variants from most correct to consume, to least.</span>

<span class="sd">        Sort rules:</span>

<span class="sd">        version_priority:</span>
<span class="sd">        - sort by highest versions of packages shared with request;</span>
<span class="sd">        - THEN least number of additional packages added to solve;</span>
<span class="sd">        - THEN highest versions of additional packages;</span>
<span class="sd">        - THEN alphabetical on name of additional packages;</span>
<span class="sd">        - THEN variant index.</span>

<span class="sd">        intersection_priority:</span>
<span class="sd">        - sort by highest number of packages shared with request;</span>
<span class="sd">        - THEN sort according to version_priority</span>

<span class="sd">        Note:</span>
<span class="sd">            In theory &#39;variant.index&#39; should never factor into the sort unless</span>
<span class="sd">            two variants are identical (which shouldn&#39;t happen) - this is just</span>
<span class="sd">            here as a safety measure so that sorting is guaranteed repeatable</span>
<span class="sd">            regardless.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sorted</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">def</span> <span class="nf">key</span><span class="p">(</span><span class="n">variant</span><span class="p">):</span>
            <span class="n">requested_key</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">request</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">request_list</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">conflict</span><span class="p">:</span>
                    <span class="n">req</span> <span class="o">=</span> <span class="n">variant</span><span class="o">.</span><span class="n">requires_list</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">req</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">requested_key</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="o">-</span><span class="n">i</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">range</span><span class="p">))</span>
                        <span class="n">names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="n">additional_key</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">request</span> <span class="ow">in</span> <span class="n">variant</span><span class="o">.</span><span class="n">requires_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">conflict</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                    <span class="n">additional_key</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">request</span><span class="o">.</span><span class="n">range</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">VariantSelectMode</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">variant_select_mode</span><span class="p">]</span> <span class="o">==</span> <span class="n">VariantSelectMode</span><span class="o">.</span><span class="n">version_priority</span><span class="p">):</span>
                <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">requested_key</span><span class="p">,</span>
                     <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">additional_key</span><span class="p">),</span>
                     <span class="n">additional_key</span><span class="p">,</span>
                     <span class="n">variant</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># VariantSelectMode.intersection_priority</span>
                <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">requested_key</span><span class="p">),</span>
                     <span class="n">requested_key</span><span class="p">,</span>
                     <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">additional_key</span><span class="p">),</span>
                     <span class="n">additional_key</span><span class="p">,</span>
                     <span class="n">variant</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">k</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">variants</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sorted</span> <span class="o">=</span> <span class="kc">True</span>


<span class="k">class</span> <span class="nc">_PackageVariantList</span><span class="p">(</span><span class="n">_Common</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A list of package variants, loaded lazily.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package_name</span><span class="p">,</span> <span class="n">solver</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">package_name</span> <span class="o">=</span> <span class="n">package_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">solver</span>

        <span class="c1"># note: we do not apply package filters here, because doing so might</span>
        <span class="c1"># cause package loads (eg, timestamp rules). We only apply filters</span>
        <span class="c1"># during an intersection, which minimises the amount of filtering.</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entries</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">package</span> <span class="ow">in</span> <span class="n">iter_packages</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package_name</span><span class="p">,</span>
                                     <span class="n">paths</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">package_paths</span><span class="p">):</span>
            <span class="n">package</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">package</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PackageFamilyNotFoundError</span><span class="p">(</span>
                <span class="s2">&quot;package family not found: </span><span class="si">%s</span><span class="s2"> (searched: </span><span class="si">%s</span><span class="s2">)&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">package_name</span><span class="p">,</span> <span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">package_paths</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">get_intersection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">range_</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a list of variants that intersect with the given range.</span>

<span class="sd">        Args:</span>
<span class="sd">            range_ (`VersionRange`): Package version range.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of `_PackageEntry` objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">:</span>
            <span class="n">package</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">entry</span>

            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># package was blocked by package filters</span>

            <span class="k">if</span> <span class="n">package</span><span class="o">.</span><span class="n">version</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">range_</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">variants</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">entry_</span> <span class="o">=</span> <span class="n">_PackageEntry</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="n">variants</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry_</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># apply package filter</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">package_filter</span><span class="p">:</span>
                <span class="n">rule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">package_filter</span><span class="o">.</span><span class="n">excludes</span><span class="p">(</span><span class="n">package</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rule</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">debug_package_exclusions</span><span class="p">:</span>
                        <span class="n">print_debug</span><span class="p">(</span><span class="s2">&quot;Package &#39;</span><span class="si">%s</span><span class="s2">&#39; was excluded by rule &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span>
                                    <span class="o">%</span> <span class="p">(</span><span class="n">package</span><span class="o">.</span><span class="n">qualified_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">rule</span><span class="p">)))</span>
                    <span class="n">entry</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">continue</span>

            <span class="c1"># expand package entry into list of variants</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">package_load_callback</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">package_load_callback</span><span class="p">(</span><span class="n">package</span><span class="p">)</span>

            <span class="n">variants_</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">package</span><span class="o">.</span><span class="n">iter_variants</span><span class="p">():</span>
                <span class="n">variant</span> <span class="o">=</span> <span class="n">PackageVariant</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">building</span><span class="p">)</span>
                <span class="n">variants_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">variant</span><span class="p">)</span>

            <span class="n">entry</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">variants_</span>
            <span class="n">entry_</span> <span class="o">=</span> <span class="n">_PackageEntry</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="n">variants_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry_</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span> <span class="ow">or</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package_name</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">package</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">package</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    [FILTERED]&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">variants</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">for</span> <span class="n">variant</span> <span class="ow">in</span> <span class="n">variants</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">variant</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">package</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">strs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">package</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">variants</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">val_str</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">variants</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">val_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">package</span><span class="p">)</span>

            <span class="n">strs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_str</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package_name</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">strs</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">_PackageVariantSlice</span><span class="p">(</span><span class="n">_Common</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A subset of a variant list, but with more dependency-related info.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package_name</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">solver</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            entries (list of `_PackageEntry`): result of</span>
<span class="sd">                _PackageVariantList.get_intersection().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">solver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">package_name</span> <span class="o">=</span> <span class="n">package_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entries</span> <span class="o">=</span> <span class="n">entries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extracted_fams</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">been_reduced_by</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">been_intersected_with</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sorted</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># calculated on demand</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_range</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fam_requires</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_common_fams</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">pr</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">range_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">versions</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">version</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_range</span> <span class="o">=</span> <span class="n">VersionRange</span><span class="o">.</span><span class="n">from_versions</span><span class="p">(</span><span class="n">versions</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_range</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fam_requires</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_fam_info</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fam_requires</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">common_fams</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_fam_info</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_common_fams</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">extractable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if there are possible remaining extractions.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">extracted_fams</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">common_fams</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">first_variant</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">entry</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">entry</span><span class="o">.</span><span class="n">variants</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">iter_variants</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">variant</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">variants</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">variant</span>

    <span class="k">def</span> <span class="nf">intersect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">range_</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">intersection_broad_tests_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="sd">&quot;&quot;&quot;Remove variants whose version fall outside of the given range.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">range_</span><span class="o">.</span><span class="n">is_any</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">optimised</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">range_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">been_intersected_with</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">passive</span><span class="p">(</span><span class="s2">&quot;intersecting </span><span class="si">%s</span><span class="s2"> wrt range &#39;</span><span class="si">%s</span><span class="s2">&#39;...&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">range_</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">intersection_tests_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">timed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">intersection_time</span><span class="p">):</span>
            <span class="c1"># this is faster than iter_intersecting :(</span>
            <span class="n">entries</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">version</span> <span class="ow">in</span> <span class="n">range_</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">entries</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">):</span>
            <span class="n">copy_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_copy</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
            <span class="n">copy_</span><span class="o">.</span><span class="n">been_intersected_with</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">range_</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">copy_</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">been_intersected_with</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">range_</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">reduce_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package_request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove variants whos dependencies conflict with the given package</span>
<span class="sd">        request.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (VariantSlice, [Reduction]) tuple, where slice may be None if all</span>
<span class="sd">            variants were reduced.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">:</span>
            <span class="n">reqstr</span> <span class="o">=</span> <span class="n">_short_req_str</span><span class="p">(</span><span class="n">package_request</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">passive</span><span class="p">(</span><span class="s2">&quot;reducing </span><span class="si">%s</span><span class="s2"> wrt </span><span class="si">%s</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">reqstr</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">optimised</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">package_request</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">been_reduced_by</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">[])</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">package_request</span><span class="o">.</span><span class="n">range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="n">package_request</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fam_requires</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">[])</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">timed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">reduction_time</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reduce_by</span><span class="p">(</span><span class="n">package_request</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_reduce_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package_request</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">reduction_tests_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">entries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">reductions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">conflict_tests</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span> <span class="nf">_conflicts</span><span class="p">(</span><span class="n">req_</span><span class="p">):</span>
            <span class="c1"># cache conflict tests, since variants often share similar requirements</span>
            <span class="n">req_s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">conflict_tests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">req_s</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">req_</span><span class="o">.</span><span class="n">conflicts_with</span><span class="p">(</span><span class="n">package_request</span><span class="p">)</span>
                <span class="n">conflict_tests</span><span class="p">[</span><span class="n">req_s</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">:</span>
            <span class="n">new_variants</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">variant</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">variants</span><span class="p">:</span>
                <span class="n">req</span> <span class="o">=</span> <span class="n">variant</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">package_request</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">req</span> <span class="ow">and</span> <span class="n">_conflicts</span><span class="p">(</span><span class="n">req</span><span class="p">):</span>
                    <span class="n">red</span> <span class="o">=</span> <span class="n">Reduction</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">variant</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                    <span class="n">version</span><span class="o">=</span><span class="n">variant</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
                                    <span class="n">variant_index</span><span class="o">=</span><span class="n">variant</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                                    <span class="n">dependency</span><span class="o">=</span><span class="n">req</span><span class="p">,</span>
                                    <span class="n">conflicting_request</span><span class="o">=</span><span class="n">package_request</span><span class="p">)</span>

                    <span class="n">reductions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">red</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s2">&quot;removed </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">red</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_variants</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">variant</span><span class="p">)</span>

            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_variants</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">entry</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="n">_PackageEntry</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">package</span><span class="p">,</span> <span class="n">new_variants</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="p">)</span>

            <span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">entries</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">reductions</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">reductions</span><span class="p">:</span>
            <span class="n">copy_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_copy</span><span class="p">(</span><span class="n">new_entries</span><span class="o">=</span><span class="n">entries</span><span class="p">)</span>
            <span class="n">copy_</span><span class="o">.</span><span class="n">been_reduced_by</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">package_request</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">copy_</span><span class="p">,</span> <span class="n">reductions</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">been_reduced_by</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">package_request</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">[])</span>

    <span class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract a common dependency.</span>

<span class="sd">        Note that conflict dependencies are never extracted, they are always</span>
<span class="sd">        resolved via reduction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">extractable</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">,</span> <span class="kc">None</span>

        <span class="n">extractable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">common_fams</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">extracted_fams</span>

        <span class="c1"># the sort is necessary to ensure solves are deterministic</span>
        <span class="n">fam</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">extractable</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">last_range</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ranges</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">variant</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_variants</span><span class="p">():</span>
            <span class="n">req</span> <span class="o">=</span> <span class="n">variant</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fam</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">range</span> <span class="o">!=</span> <span class="n">last_range</span><span class="p">:</span>  <span class="c1"># will match often, avoids set search</span>
                <span class="n">ranges</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">range</span><span class="p">)</span>
                <span class="n">last_range</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">range</span>

        <span class="n">slice_</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">slice_</span><span class="o">.</span><span class="n">extracted_fams</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extracted_fams</span> <span class="o">|</span> <span class="nb">set</span><span class="p">([</span><span class="n">fam</span><span class="p">])</span>

        <span class="n">ranges</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ranges</span><span class="p">)</span>
        <span class="n">range_</span> <span class="o">=</span> <span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="n">common_req</span> <span class="o">=</span> <span class="n">Requirement</span><span class="o">.</span><span class="n">construct</span><span class="p">(</span><span class="n">fam</span><span class="p">,</span> <span class="n">range_</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">slice_</span><span class="p">,</span> <span class="n">common_req</span>

    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Split the slice.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (`_PackageVariantSlice`, `_PackageVariantSlice`) tuple, where the</span>
<span class="sd">            first is the preferred slice.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># We sort here in the split in order to sort as late as possible.</span>
        <span class="c1"># Because splits usually happen after intersections/reductions, this</span>
        <span class="c1"># means there can be less entries to sort.</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sort_versions</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">_split</span><span class="p">(</span><span class="n">i_entry</span><span class="p">,</span> <span class="n">n_variants</span><span class="p">,</span> <span class="n">common_fams</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="c1"># perform a split at a specific point</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">[</span><span class="n">i_entry</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">n_variants</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">entry</span><span class="p">,</span> <span class="n">next_entry</span> <span class="o">=</span> <span class="n">result</span>
                <span class="n">entries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">[:</span><span class="n">i_entry</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">entry</span><span class="p">]</span>
                <span class="n">next_entries</span> <span class="o">=</span> <span class="p">[</span><span class="n">next_entry</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">[</span><span class="n">i_entry</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">entries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">[:</span><span class="n">i_entry</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">next_entries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">[</span><span class="n">i_entry</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>

            <span class="n">slice_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_copy</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
            <span class="n">next_slice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_copy</span><span class="p">(</span><span class="n">next_entries</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">common_fams</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">common_fams</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">reason_str</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">common_fams</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">reason_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">common_fams</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">reason_str</span> <span class="o">=</span> <span class="s2">&quot;first variant&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s2">&quot;split (reason: </span><span class="si">%s</span><span class="s2">) </span><span class="si">%s</span><span class="s2"> into </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">reason_str</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">slice_</span><span class="p">,</span> <span class="n">next_slice</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">slice_</span><span class="p">,</span> <span class="n">next_slice</span>

        <span class="c1"># determine if we need to find first variant without common dependency</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">fams</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_variant</span><span class="o">.</span><span class="n">request_fams</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">extracted_fams</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fams</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">fams</span><span class="p">:</span>
            <span class="c1"># trivial case, split on first variant</span>
            <span class="k">return</span> <span class="n">_split</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># find split point - first variant with no dependency shared with previous</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">):</span>
            <span class="c1"># sort the variants. This is done here in order to do the sort as</span>
            <span class="c1"># late as possible, simply to avoid the cost.</span>
            <span class="n">entry</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">variant</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">variants</span><span class="p">):</span>
                <span class="n">fams</span> <span class="o">=</span> <span class="n">fams</span> <span class="o">&amp;</span> <span class="n">variant</span><span class="o">.</span><span class="n">request_fams</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">fams</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">_split</span><span class="p">(</span><span class="o">*</span><span class="n">prev</span><span class="p">)</span>

                <span class="n">prev</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fams</span><span class="p">)</span>

        <span class="c1"># should never get here - it&#39;s only possible if there&#39;s a common</span>
        <span class="c1"># dependency, but if there&#39;s a common dependency, split() should never</span>
        <span class="c1"># have been called.</span>
        <span class="k">raise</span> <span class="n">RezSystemError</span><span class="p">(</span>
            <span class="s2">&quot;Unexpected solver error: common family(s) still in slice being &quot;</span>
            <span class="s2">&quot;split: slice: </span><span class="si">%s</span><span class="s2">, family(s): </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">fams</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">sort_versions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sort entries by version.</span>

<span class="sd">        The order is typically descending, but package order functions can</span>
<span class="sd">        change this.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sorted</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">orderer</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">package_orderers</span> <span class="ow">or</span> <span class="p">[]):</span>
            <span class="n">entries</span> <span class="o">=</span> <span class="n">orderer</span><span class="o">.</span><span class="n">reorder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">package</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">entries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">entries</span> <span class="o">=</span> <span class="n">entries</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sorted</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s2">&quot;sorted: </span><span class="si">%s</span><span class="s2"> packages: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_name</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">orderer</span><span class="p">))</span>
                <span class="k">return</span>

        <span class="c1"># default ordering is version descending</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entries</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sorted</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s2">&quot;sorted: </span><span class="si">%s</span><span class="s2"> packages: version descending&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package_name</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_variants</span><span class="p">())))</span>

    <span class="k">def</span> <span class="nf">_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_entries</span><span class="p">):</span>
        <span class="n">slice_</span> <span class="o">=</span> <span class="n">_PackageVariantSlice</span><span class="p">(</span><span class="n">package_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">package_name</span><span class="p">,</span>
                                      <span class="n">entries</span><span class="o">=</span><span class="n">new_entries</span><span class="p">,</span>
                                      <span class="n">solver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="p">)</span>

        <span class="n">slice_</span><span class="o">.</span><span class="n">sorted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sorted</span>
        <span class="n">slice_</span><span class="o">.</span><span class="n">been_reduced_by</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">been_reduced_by</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">slice_</span><span class="o">.</span><span class="n">been_intersected_with</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">been_intersected_with</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">slice_</span>

    <span class="k">def</span> <span class="nf">_update_fam_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_common_fams</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_common_fams</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">first_variant</span><span class="o">.</span><span class="n">request_fams</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fam_requires</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">variant</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_variants</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_common_fams</span> <span class="o">&amp;=</span> <span class="n">variant</span><span class="o">.</span><span class="n">request_fams</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fam_requires</span> <span class="o">|=</span> <span class="p">(</span><span class="n">variant</span><span class="o">.</span><span class="n">request_fams</span>
                                   <span class="o">|</span> <span class="n">variant</span><span class="o">.</span><span class="n">conflict_request_fams</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_len</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        foo[2..6(3:4)]* means, 3 versions, 4 variants in 2..6, and at least one</span>
<span class="sd">            family can still be extracted.</span>
<span class="sd">        foo[2..6(2)] means, 2 versions in 2..6.</span>
<span class="sd">        [foo==2[1,2]] means, 1st and 2nd variants of exact version foo-2.</span>
<span class="sd">        [foo==2]* means, exact version foo-2, families still to extract.</span>
<span class="sd">        [foo==2] means a resolved package (no variants in the package).</span>
<span class="sd">        [foo=2[0]] means a resolved package (zeroeth variant).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nvariants</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">nversions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">nvariants</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">variant</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_variant</span>
            <span class="n">s_idx</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">variant</span><span class="o">.</span><span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;[</span><span class="si">%d</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="n">variant</span><span class="o">.</span><span class="n">index</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">==</span><span class="si">%s%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">variant</span><span class="o">.</span><span class="n">version</span><span class="p">),</span> <span class="n">s_idx</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">nversions</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">indexes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">variants</span><span class="p">])</span>
            <span class="n">s_idx</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">indexes</span><span class="p">)</span>
            <span class="n">verstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">==</span><span class="si">%s</span><span class="s2">[</span><span class="si">%s</span><span class="s2">]]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package_name</span><span class="p">,</span> <span class="n">verstr</span><span class="p">,</span> <span class="n">s_idx</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">verstr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">nvariants</span> <span class="k">if</span> <span class="p">(</span><span class="n">nversions</span> <span class="o">==</span> <span class="n">nvariants</span><span class="p">)</span> \
                <span class="k">else</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">:</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nversions</span><span class="p">,</span> <span class="n">nvariants</span><span class="p">)</span>

            <span class="n">span</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">range_</span><span class="o">.</span><span class="n">span</span><span class="p">()</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">[</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">span</span><span class="p">),</span> <span class="n">verstr</span><span class="p">)</span>

        <span class="n">strextr</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extractable</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="k">return</span> <span class="n">s</span> <span class="o">+</span> <span class="n">strextr</span>


<div class="viewcode-block" id="PackageVariantCache"><a class="viewcode-back" href="../../api/rez.html#rez.solver.PackageVariantCache">[docs]</a><span class="k">class</span> <span class="nc">PackageVariantCache</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solver</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">solver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variant_lists</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># {package-name: _PackageVariantList}</span>

<div class="viewcode-block" id="PackageVariantCache.get_variant_slice"><a class="viewcode-back" href="../../api/rez.html#rez.solver.PackageVariantCache.get_variant_slice">[docs]</a>    <span class="k">def</span> <span class="nf">get_variant_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package_name</span><span class="p">,</span> <span class="n">range_</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a list of variants from the cache.</span>

<span class="sd">        Args:</span>
<span class="sd">            package_name (str): Name of package.</span>
<span class="sd">            range_ (`VersionRange`): Package version range.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `_PackageVariantSlice` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">variant_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant_lists</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">package_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">variant_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">variant_list</span> <span class="o">=</span> <span class="n">_PackageVariantList</span><span class="p">(</span><span class="n">package_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variant_lists</span><span class="p">[</span><span class="n">package_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">variant_list</span>

        <span class="n">entries</span> <span class="o">=</span> <span class="n">variant_list</span><span class="o">.</span><span class="n">get_intersection</span><span class="p">(</span><span class="n">range_</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">entries</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">slice_</span> <span class="o">=</span> <span class="n">_PackageVariantSlice</span><span class="p">(</span><span class="n">package_name</span><span class="p">,</span>
                                      <span class="n">entries</span><span class="o">=</span><span class="n">entries</span><span class="p">,</span>
                                      <span class="n">solver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">slice_</span></div></div>


<span class="k">class</span> <span class="nc">_PackageScope</span><span class="p">(</span><span class="n">_Common</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Contains possible solutions for a package, such as a list of variants,</span>
<span class="sd">    or a conflict range. As the resolve progresses, package scopes are narrowed</span>
<span class="sd">    down.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package_request</span><span class="p">,</span> <span class="n">solver</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">package_name</span> <span class="o">=</span> <span class="n">package_request</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">solver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">package_request</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variant_slice</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pr</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">pr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_ephemeral</span> <span class="o">=</span> <span class="p">(</span><span class="n">package_request</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">package_request</span><span class="o">.</span><span class="n">conflict</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ephemeral</span><span class="p">:</span>
            <span class="c1"># these cases don&#39;t actually contain variants</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">package_request</span> <span class="o">=</span> <span class="n">package_request</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variant_slice</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">_get_variant_slice</span><span class="p">(</span>
                <span class="n">package_request</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">package_request</span><span class="o">.</span><span class="n">range</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant_slice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">req</span> <span class="o">=</span> <span class="n">Requirement</span><span class="o">.</span><span class="n">construct</span><span class="p">(</span><span class="n">package_request</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                            <span class="n">package_request</span><span class="o">.</span><span class="n">range</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">PackageNotFoundError</span><span class="p">(</span><span class="s2">&quot;Package could not be found: </span><span class="si">%s</span><span class="s2">&quot;</span>
                                           <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_conflict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_request</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_request</span><span class="o">.</span><span class="n">conflict</span>

    <span class="k">def</span> <span class="nf">intersect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">range_</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Intersect this scope with a package range.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A new copy of this scope, with variants whos version fall outside</span>
<span class="sd">            of the given range removed. If there were no removals, self is</span>
<span class="sd">            returned. If all variants were removed, None is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># ephemerals are just a range intersection</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ephemeral</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_conflict</span><span class="p">:</span>
                <span class="n">intersect_range</span> <span class="o">=</span> <span class="n">range_</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_request</span><span class="o">.</span><span class="n">range</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">intersect_range</span> <span class="o">=</span> <span class="n">range_</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_request</span><span class="o">.</span><span class="n">range</span>

            <span class="k">if</span> <span class="n">intersect_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> intersected with range &#39;</span><span class="si">%s</span><span class="s2">&#39; resulted in conflict&quot;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="p">,</span> <span class="n">range_</span>
                    <span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">intersect_range</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_request</span><span class="o">.</span><span class="n">range</span><span class="p">:</span>
                <span class="c1"># intersection did not change the scope</span>
                <span class="k">return</span> <span class="bp">self</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scope</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="n">scope</span><span class="o">.</span><span class="n">package_request</span> <span class="o">=</span> <span class="n">Requirement</span><span class="o">.</span><span class="n">construct</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">package_name</span><span class="p">,</span> <span class="n">intersect_range</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> was intersected to </span><span class="si">%s</span><span class="s2"> by range &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">range_</span>
                    <span class="p">)</span>
                <span class="k">return</span> <span class="n">scope</span>

        <span class="c1"># typical case: slice or conflict</span>
        <span class="n">new_slice</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_conflict</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_request</span><span class="o">.</span><span class="n">range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">new_slice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">_get_variant_slice</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">package_name</span><span class="p">,</span> <span class="n">range_</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_range</span> <span class="o">=</span> <span class="n">range_</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_request</span><span class="o">.</span><span class="n">range</span>
                <span class="k">if</span> <span class="n">new_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">new_slice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">_get_variant_slice</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">package_name</span><span class="p">,</span> <span class="n">new_range</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_slice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant_slice</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span><span class="n">range_</span><span class="p">)</span>

        <span class="c1"># intersection reduced the scope to nothing</span>
        <span class="k">if</span> <span class="n">new_slice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> intersected with range &#39;</span><span class="si">%s</span><span class="s2">&#39; resulted in no packages&quot;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="p">,</span> <span class="n">range_</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># intersection narrowed the scope</span>
        <span class="k">if</span> <span class="n">new_slice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant_slice</span><span class="p">:</span>
            <span class="n">scope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_copy</span><span class="p">(</span><span class="n">new_slice</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> was intersected to </span><span class="si">%s</span><span class="s2"> by range &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">range_</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">scope</span>

        <span class="c1"># intersection did not change the scope</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">reduce_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package_request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reduce this scope wrt a package request.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A (_PackageScope, [Reduction]) tuple, where the scope is a new</span>
<span class="sd">            scope copy with reductions applied, or self if there were no</span>
<span class="sd">            reductions, or None if the scope was completely reduced.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">reduction_broad_tests_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># reduction of conflicts and ephemerals is nonsensical (they have no</span>
        <span class="c1"># variant list to reduce)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_conflict</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ephemeral</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">[])</span>

        <span class="c1"># perform the reduction</span>
        <span class="n">new_slice</span><span class="p">,</span> <span class="n">reductions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant_slice</span><span class="o">.</span><span class="n">reduce_by</span><span class="p">(</span><span class="n">package_request</span><span class="p">)</span>

        <span class="c1"># there was total reduction</span>
        <span class="k">if</span> <span class="n">new_slice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">reductions_count</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">:</span>
                <span class="n">reqstr</span> <span class="o">=</span> <span class="n">_short_req_str</span><span class="p">(</span><span class="n">package_request</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> was reduced to nothing by </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">reqstr</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">br</span><span class="p">()</span>

            <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">reductions</span><span class="p">)</span>

        <span class="c1"># there was some reduction</span>
        <span class="k">if</span> <span class="n">new_slice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant_slice</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">reductions_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">scope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_copy</span><span class="p">(</span><span class="n">new_slice</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">:</span>
                <span class="n">reqstr</span> <span class="o">=</span> <span class="n">_short_req_str</span><span class="p">(</span><span class="n">package_request</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> was reduced to </span><span class="si">%s</span><span class="s2"> by </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">reqstr</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">br</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">reductions</span><span class="p">)</span>

        <span class="c1"># there was no reduction</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">[])</span>

    <span class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract a common dependency.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A (_PackageScope, Requirement) tuple, containing the new scope copy</span>
<span class="sd">            with the extraction, and the extracted package range. If no package</span>
<span class="sd">            was extracted, then (self,None) is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># extraction is nonsensical for conflicts and ephemerals</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_conflict</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ephemeral</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">new_slice</span><span class="p">,</span> <span class="n">package_request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant_slice</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">package_request</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">new_slice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant_slice</span>
        <span class="n">scope</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">scope</span><span class="o">.</span><span class="n">variant_slice</span> <span class="o">=</span> <span class="n">new_slice</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s2">&quot;extracted </span><span class="si">%s</span><span class="s2"> from </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">package_request</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">package_request</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Split the scope.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A (_PackageScope, _PackageScope) tuple, where the first scope is</span>
<span class="sd">            guaranteed to have a common dependency. Or None, if splitting is</span>
<span class="sd">            not applicable to this scope.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_conflict</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ephemeral</span>
            <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variant_slice</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant_slice</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">slice_</span><span class="p">,</span> <span class="n">next_slice</span> <span class="o">=</span> <span class="n">r</span>
        <span class="n">scope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_copy</span><span class="p">(</span><span class="n">slice_</span><span class="p">)</span>
        <span class="n">next_scope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_copy</span><span class="p">(</span><span class="n">next_slice</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">next_scope</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_slice</span><span class="p">):</span>
        <span class="n">scope</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">scope</span><span class="o">.</span><span class="n">variant_slice</span> <span class="o">=</span> <span class="n">new_slice</span>
        <span class="n">scope</span><span class="o">.</span><span class="n">_update</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">scope</span>

    <span class="k">def</span> <span class="nf">_is_solved</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_conflict</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ephemeral</span>
            <span class="ow">or</span> <span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variant_slice</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant_slice</span><span class="o">.</span><span class="n">extractable</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_solved_variant</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variant_slice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variant_slice</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant_slice</span><span class="o">.</span><span class="n">extractable</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant_slice</span><span class="o">.</span><span class="n">first_variant</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_solved_ephemeral</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ephemeral</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_conflict</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_request</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant_slice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">package_request</span> <span class="o">=</span> <span class="n">Requirement</span><span class="o">.</span><span class="n">construct</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">package_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant_slice</span><span class="o">.</span><span class="n">range_</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">variant_slice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package_request</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variant_slice</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_dependency_order</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">node_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return list of nodes as close as possible to the ordering in node_list,</span>
<span class="sd">    but with child nodes earlier in the list than parents.&quot;&quot;&quot;</span>
    <span class="n">access_</span> <span class="o">=</span> <span class="n">accessibility</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
    <span class="n">deps</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">([</span><span class="n">k</span><span class="p">]))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">access_</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="n">nodes</span> <span class="o">=</span> <span class="n">node_list</span> <span class="o">+</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">nodes</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">node_list</span><span class="p">))</span>
    <span class="n">ordered_nodes</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">while</span> <span class="n">nodes</span><span class="p">:</span>
        <span class="n">n_</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">n_deps</span> <span class="o">=</span> <span class="n">deps</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">n_</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n_</span> <span class="ow">in</span> <span class="n">ordered_nodes</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">n_deps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">continue</span>

        <span class="n">moved</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">n_deps</span><span class="p">:</span>
                <span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">nodes</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">nodes</span><span class="p">[:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">nodes</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:]</span>
                <span class="n">moved</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">moved</span><span class="p">:</span>
            <span class="n">ordered_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n_</span><span class="p">)</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="k">return</span> <span class="n">ordered_nodes</span>


<span class="k">class</span> <span class="nc">_ResolvePhase</span><span class="p">(</span><span class="n">_Common</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A resolve phase contains a full copy of the resolve state, and runs the</span>
<span class="sd">    resolve algorithm until no further action can be taken without &#39;selecting&#39;</span>
<span class="sd">    a sub-range of some package. When this selection occurs, a phase splits</span>
<span class="sd">    into two - one with the selected subrange, and one without - and these two</span>
<span class="sd">    new phases replace this phase on the solver&#39;s phase stack.</span>

<span class="sd">    If the resolve phase gets to a point where every package scope is solved,</span>
<span class="sd">    then the entire resolve is considered to be solved.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solver</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">solver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failure_reason</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extractions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">SolverStatus</span><span class="o">.</span><span class="n">pending</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scopes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">package_request</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">request_list</span><span class="p">:</span>
            <span class="n">scope</span> <span class="o">=</span> <span class="n">_PackageScope</span><span class="p">(</span><span class="n">package_request</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="n">solver</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scopes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>

        <span class="c1"># only so an initial reduction across all scopes happens in a new phase</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">changed_scopes_i</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scopes</span><span class="p">)))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">pr</span>

    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Attempt to solve the phase.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">SolverStatus</span><span class="o">.</span><span class="n">pending</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="n">scopes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scopes</span><span class="p">[:]</span>
        <span class="n">failure_reason</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">extractions</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">changed_scopes_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">changed_scopes_i</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">_create_phase</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">phase</span><span class="o">.</span><span class="n">scopes</span> <span class="o">=</span> <span class="n">scopes</span>
            <span class="n">phase</span><span class="o">.</span><span class="n">failure_reason</span> <span class="o">=</span> <span class="n">failure_reason</span>
            <span class="n">phase</span><span class="o">.</span><span class="n">extractions</span> <span class="o">=</span> <span class="n">extractions</span>
            <span class="n">phase</span><span class="o">.</span><span class="n">changed_scopes_i</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">status</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">phase</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="n">SolverStatus</span><span class="o">.</span><span class="n">solved</span> <span class="k">if</span> <span class="n">phase</span><span class="o">.</span><span class="n">_is_solved</span><span class="p">()</span>
                                <span class="k">else</span> <span class="n">SolverStatus</span><span class="o">.</span><span class="n">exhausted</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">phase</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>
            <span class="k">return</span> <span class="n">phase</span>

        <span class="c1"># iteratively reduce until no more reductions possible</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">prev_num_scopes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">scopes</span><span class="p">)</span>
            <span class="n">widened_scopes_i</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

            <span class="c1"># iteratively extract until no more extractions possible</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;EXTRACTING:&quot;</span><span class="p">)</span>
                <span class="n">extracted_requests</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="c1"># perform all possible extractions</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">timed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">extraction_time</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">scopes</span><span class="p">)):</span>
                        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">scope_</span><span class="p">,</span> <span class="n">extracted_request</span> <span class="o">=</span> <span class="n">scopes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>

                            <span class="k">if</span> <span class="n">extracted_request</span><span class="p">:</span>
                                <span class="n">extracted_requests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extracted_request</span><span class="p">)</span>
                                <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">scopes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">package_name</span><span class="p">,</span> <span class="n">extracted_request</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                                <span class="n">extractions</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">extracted_request</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">extractions_count</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="n">scopes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">scope_</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">break</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">extracted_requests</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="c1"># simplify extractions (there may be overlaps)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;MERGE-EXTRACTIONS:&quot;</span><span class="p">)</span>
                <span class="n">extracted_requests</span> <span class="o">=</span> <span class="n">RequirementList</span><span class="p">(</span><span class="n">extracted_requests</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">extracted_requests</span><span class="o">.</span><span class="n">conflict</span><span class="p">:</span>  <span class="c1"># extractions are in conflict</span>
                    <span class="n">req1</span><span class="p">,</span> <span class="n">req2</span> <span class="o">=</span> <span class="n">extracted_requests</span><span class="o">.</span><span class="n">conflict</span>
                    <span class="n">conflict</span> <span class="o">=</span> <span class="n">DependencyConflict</span><span class="p">(</span><span class="n">req1</span><span class="p">,</span> <span class="n">req2</span><span class="p">)</span>
                    <span class="n">failure_reason</span> <span class="o">=</span> <span class="n">DependencyConflicts</span><span class="p">([</span><span class="n">conflict</span><span class="p">])</span>
                    <span class="k">return</span> <span class="n">_create_phase</span><span class="p">(</span><span class="n">SolverStatus</span><span class="o">.</span><span class="n">failed</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s2">&quot;merged extractions: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">extracted_requests</span><span class="p">)</span>

                <span class="c1"># intersect extracted requests with current scopes</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;INTERSECTING:&quot;</span><span class="p">)</span>
                <span class="n">req_fams</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">timed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">intersection_test_time</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">scope</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">scopes</span><span class="p">):</span>
                        <span class="n">extracted_req</span> <span class="o">=</span> <span class="n">extracted_requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">scope</span><span class="o">.</span><span class="n">package_name</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">extracted_req</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">continue</span>

                        <span class="c1"># perform the intersection</span>
                        <span class="n">scope_</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span><span class="n">extracted_req</span><span class="o">.</span><span class="n">range</span><span class="p">)</span>

                        <span class="n">req_fams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extracted_req</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">scope_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="c1"># the scope conflicted with the extraction</span>
                            <span class="n">conflict</span> <span class="o">=</span> <span class="n">DependencyConflict</span><span class="p">(</span>
                                <span class="n">extracted_req</span><span class="p">,</span> <span class="n">scope</span><span class="o">.</span><span class="n">package_request</span><span class="p">)</span>
                            <span class="n">failure_reason</span> <span class="o">=</span> <span class="n">DependencyConflicts</span><span class="p">([</span><span class="n">conflict</span><span class="p">])</span>
                            <span class="k">return</span> <span class="n">_create_phase</span><span class="p">(</span><span class="n">SolverStatus</span><span class="o">.</span><span class="n">failed</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">scope_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">scope</span><span class="p">:</span>
                            <span class="c1"># the scope was narrowed because it intersected</span>
                            <span class="c1"># with an extraction</span>
                            <span class="n">scopes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">scope_</span>
                            <span class="n">changed_scopes_i</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">intersections_count</span> <span class="o">+=</span> <span class="mi">1</span>

                            <span class="c1"># if the intersection caused a conflict scope to turn</span>
                            <span class="c1"># into a non-conflict scope, then it has to be reduced</span>
                            <span class="c1"># against all other scopes.</span>
                            <span class="c1">#</span>
                            <span class="c1"># In the very common case, if a scope changes then it</span>
                            <span class="c1"># has been narrowed, so there is no need to reduce it</span>
                            <span class="c1"># against other unchanged scopes. In this case however,</span>
                            <span class="c1"># the scope actually widens! For eg, &#39;~foo-1&#39; may be</span>
                            <span class="c1"># intersected with &#39;foo&#39; to become &#39;foo-1&#39;, which might</span>
                            <span class="c1"># then reduce against existing scopes.</span>
                            <span class="c1">#</span>
                            <span class="k">if</span> <span class="n">scope</span><span class="o">.</span><span class="n">is_conflict</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">scope_</span><span class="o">.</span><span class="n">is_conflict</span><span class="p">:</span>
                                <span class="n">widened_scopes_i</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

                <span class="c1"># add new scopes</span>
                <span class="n">new_extracted_reqs</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">extracted_requests</span><span class="o">.</span><span class="n">requirements</span>
                    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">req_fams</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">new_extracted_reqs</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;ADDING:&quot;</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">new_extracted_reqs</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">scope</span> <span class="o">=</span> <span class="n">_PackageScope</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="p">)</span>
                        <span class="k">except</span> <span class="n">PackageFamilyNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="c1"># Look up which are requesting the missing one</span>
                            <span class="n">requesters</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">extracted_request</span> <span class="ow">in</span> <span class="n">extractions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="k">if</span> <span class="n">extracted_request</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">req</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                                    <span class="n">requesters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">requesters</span><span class="p">:</span>
                                <span class="c1"># Must have a match. Raise origin error if not</span>
                                <span class="k">raise</span> <span class="n">e</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># Raise with more info when match found</span>
                                <span class="n">searched</span> <span class="o">=</span> <span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">package_paths</span><span class="p">)</span>
                                <span class="n">requested</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">requesters</span><span class="p">)</span>
                                <span class="k">raise</span> <span class="n">PackageFamilyNotFoundError</span><span class="p">(</span>
                                    <span class="s2">&quot;package family not found: </span><span class="si">%s</span><span class="s2">, &quot;</span>
                                    <span class="s2">&quot;was required by: </span><span class="si">%s</span><span class="s2"> (searched: </span><span class="si">%s</span><span class="s2">)&quot;</span>
                                    <span class="o">%</span> <span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">requested</span><span class="p">,</span> <span class="n">searched</span><span class="p">))</span>

                        <span class="n">scopes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s2">&quot;added </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span>

            <span class="n">num_scopes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">scopes</span><span class="p">)</span>

            <span class="c1"># no further reductions to do</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">num_scopes</span> <span class="o">==</span> <span class="n">prev_num_scopes</span><span class="p">)</span> \
                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">changed_scopes_i</span> \
                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">widened_scopes_i</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="c1"># iteratively reduce until no more reductions possible</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;REDUCING:&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">optimised</span><span class="p">:</span>
                <span class="c1"># force reductions across all scopes</span>
                <span class="n">changed_scopes_i</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_scopes</span><span class="p">))</span>
                <span class="n">prev_num_scopes</span> <span class="o">=</span> <span class="n">num_scopes</span>

            <span class="c1"># Create set of pending reductions from the list of changed scopes</span>
            <span class="c1"># and list of added scopes. Each item is an (x, y) tuple, where</span>
            <span class="c1"># scope[x] will reduce by scope[y].package_request.</span>
            <span class="c1">#</span>
            <span class="n">all_scopes_i</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_scopes</span><span class="p">)</span>
            <span class="n">prev_scopes_i</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">prev_num_scopes</span><span class="p">)</span>
            <span class="n">added_scopes_i</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">prev_num_scopes</span><span class="p">,</span> <span class="n">num_scopes</span><span class="p">)</span>

            <span class="n">pending_reducts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span>

                <span class="c1"># existing scopes must reduce against changed scopes</span>
                <span class="n">product</span><span class="p">(</span><span class="n">prev_scopes_i</span><span class="p">,</span> <span class="n">changed_scopes_i</span><span class="p">),</span>

                <span class="c1"># existing scopes must reduce against newly added scopes</span>
                <span class="n">product</span><span class="p">(</span><span class="n">prev_scopes_i</span><span class="p">,</span> <span class="n">added_scopes_i</span><span class="p">),</span>

                <span class="c1"># newly added scopes must reduce against all other scopes</span>
                <span class="n">product</span><span class="p">(</span><span class="n">added_scopes_i</span><span class="p">,</span> <span class="n">all_scopes_i</span><span class="p">),</span>

                <span class="c1"># &#39;widened&#39; scopes (see earlier comment in this func) must reduce</span>
                <span class="c1"># against all other scopes</span>
                <span class="c1">#</span>
                <span class="n">product</span><span class="p">(</span><span class="n">widened_scopes_i</span><span class="p">,</span> <span class="n">all_scopes_i</span><span class="p">)</span>
            <span class="p">))</span>

            <span class="c1"># iteratively reduce until there are no more pending reductions.</span>
            <span class="c1"># Note that if a scope is reduced, then other scopes need to reduce</span>
            <span class="c1"># against it once again.</span>
            <span class="c1">#</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">timed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">reduction_test_time</span><span class="p">):</span>

                <span class="c1"># A different order here wouldn&#39;t cause an invalid solve, however</span>
                <span class="c1"># rez solves must be deterministic, so this is why we sort.</span>
                <span class="c1">#</span>
                <span class="n">pending_reducts</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pending_reducts</span><span class="p">)</span>

                <span class="k">while</span> <span class="n">pending_reducts</span><span class="p">:</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">pending_reducts</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">y</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">new_scope</span><span class="p">,</span> <span class="n">reductions</span> <span class="o">=</span> <span class="n">scopes</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">reduce_by</span><span class="p">(</span>
                        <span class="n">scopes</span><span class="p">[</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">package_request</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">new_scope</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">failure_reason</span> <span class="o">=</span> <span class="n">TotalReduction</span><span class="p">(</span><span class="n">reductions</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">_create_phase</span><span class="p">(</span><span class="n">SolverStatus</span><span class="o">.</span><span class="n">failed</span><span class="p">)</span>

                    <span class="k">elif</span> <span class="n">new_scope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">scopes</span><span class="p">[</span><span class="n">x</span><span class="p">]:</span>
                        <span class="n">scopes</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_scope</span>

                        <span class="c1"># other scopes need to reduce against x again</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">all_scopes_i</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">x</span><span class="p">:</span>
                                <span class="n">pending_reducts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">j</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>

            <span class="n">changed_scopes_i</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">_create_phase</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">finalise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove conflict requests, detect cyclic dependencies, and reorder</span>
<span class="sd">        packages wrt dependency and then request order.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A new copy of the phase with conflict requests removed and packages</span>
<span class="sd">            correctly ordered; or, if cyclic dependencies were detected, a new</span>
<span class="sd">            phase marked as cyclic.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_solved</span><span class="p">()</span>
        <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_minimal_graph</span><span class="p">()</span>
        <span class="n">scopes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">package_name</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scopes</span>
                      <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">is_conflict</span><span class="p">)</span>

        <span class="c1"># check for cyclic dependencies</span>
        <span class="n">fam_cycle</span> <span class="o">=</span> <span class="n">find_cycle</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fam_cycle</span><span class="p">:</span>
            <span class="n">cycle</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">fam</span> <span class="ow">in</span> <span class="n">fam_cycle</span><span class="p">:</span>
                <span class="n">scope</span> <span class="o">=</span> <span class="n">scopes</span><span class="p">[</span><span class="n">fam</span><span class="p">]</span>
                <span class="n">variant</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">_get_solved_variant</span><span class="p">()</span>
                <span class="n">stmt</span> <span class="o">=</span> <span class="n">VersionedObject</span><span class="o">.</span><span class="n">construct</span><span class="p">(</span><span class="n">fam</span><span class="p">,</span> <span class="n">variant</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
                <span class="n">cycle</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>

            <span class="n">phase</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">phase</span><span class="o">.</span><span class="n">scopes</span> <span class="o">=</span> <span class="n">scopes</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="n">phase</span><span class="o">.</span><span class="n">failure_reason</span> <span class="o">=</span> <span class="n">Cycle</span><span class="p">(</span><span class="n">cycle</span><span class="p">)</span>
            <span class="n">phase</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">SolverStatus</span><span class="o">.</span><span class="n">cyclic</span>
            <span class="k">return</span> <span class="n">phase</span>

        <span class="c1"># reorder wrt dependencies, keeping original request order where possible</span>
        <span class="n">fams</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">request_list</span><span class="p">]</span>
        <span class="n">ordered_fams</span> <span class="o">=</span> <span class="n">_get_dependency_order</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">fams</span><span class="p">)</span>

        <span class="n">scopes_</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fam</span> <span class="ow">in</span> <span class="n">ordered_fams</span><span class="p">:</span>
            <span class="n">scope</span> <span class="o">=</span> <span class="n">scopes</span><span class="p">[</span><span class="n">fam</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">scope</span><span class="o">.</span><span class="n">is_conflict</span><span class="p">:</span>
                <span class="n">scopes_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>

        <span class="n">phase</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">phase</span><span class="o">.</span><span class="n">scopes</span> <span class="o">=</span> <span class="n">scopes_</span>
        <span class="k">return</span> <span class="n">phase</span>

    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Split the phase.</span>

<span class="sd">        When a phase is exhausted, it gets split into a pair of phases to be</span>
<span class="sd">        further solved. The split happens like so:</span>
<span class="sd">        1) Select the first unsolved package scope.</span>
<span class="sd">        2) Find some common dependency in the first N variants of the scope.</span>
<span class="sd">        3) Split the scope into two: [:N] and [N:].</span>
<span class="sd">        4) Create two copies of the phase, containing each half of the split</span>
<span class="sd">           scope.</span>

<span class="sd">        The result of this split is that we have a new phase (the first phase),</span>
<span class="sd">        which contains a package scope with a common dependency. This</span>
<span class="sd">        dependency can now be intersected with the current resolve, thus</span>
<span class="sd">        progressing it.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A 2-tuple of _ResolvePhase objects, where the first phase is the</span>
<span class="sd">            best contender for resolving.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">SolverStatus</span><span class="o">.</span><span class="n">exhausted</span>

        <span class="n">scopes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">next_scopes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">split_i</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">scope</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scopes</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">split_i</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">scope_</span><span class="p">,</span> <span class="n">next_scope</span> <span class="o">=</span> <span class="n">r</span>
                    <span class="n">scopes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scope_</span><span class="p">)</span>
                    <span class="n">next_scopes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_scope</span><span class="p">)</span>
                    <span class="n">split_i</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="k">continue</span>

            <span class="n">scopes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
            <span class="n">next_scopes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">split_i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="n">phase</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">phase</span><span class="o">.</span><span class="n">scopes</span> <span class="o">=</span> <span class="n">scopes</span>
        <span class="n">phase</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">SolverStatus</span><span class="o">.</span><span class="n">pending</span>
        <span class="n">phase</span><span class="o">.</span><span class="n">changed_scopes_i</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">split_i</span><span class="p">])</span>

        <span class="c1"># because a scope was narrowed by a split, other scopes need to be</span>
        <span class="c1"># reduced against it</span>
        <span class="c1"># for i in range(len(phase.scopes)):</span>
        <span class="c1">#     if i != split_i:</span>
        <span class="c1">#         phase.pending_reducts.add((i, split_i))</span>

        <span class="n">next_phase</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>
        <span class="n">next_phase</span><span class="o">.</span><span class="n">scopes</span> <span class="o">=</span> <span class="n">next_scopes</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="n">next_phase</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the resolve graph.</span>

<span class="sd">        The resolve graph shows what packages were resolved, and the</span>
<span class="sd">        relationships between them. A failed phase also has a graph, which</span>
<span class="sd">        will shows the conflict(s) that caused the resolve to fail.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A pygraph.digraph object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">digraph</span><span class="p">()</span>
        <span class="n">scopes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">package_name</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scopes</span><span class="p">)</span>
        <span class="n">failure_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">request_nodes</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># (request, node_id)</span>
        <span class="n">scope_nodes</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># (package_name, node_id)</span>
        <span class="n">scope_requests</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># (node_id, request)</span>

        <span class="c1"># -- graph creation basics</span>

        <span class="n">node_color</span> <span class="o">=</span> <span class="s2">&quot;#F6F6F6&quot;</span>
        <span class="n">request_color</span> <span class="o">=</span> <span class="s2">&quot;#FFFFAA&quot;</span>
        <span class="n">solved_color</span> <span class="o">=</span> <span class="s2">&quot;#AAFFAA&quot;</span>
        <span class="n">node_fontsize</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">_uid</span><span class="p">():</span>
            <span class="n">id_</span> <span class="o">=</span> <span class="n">counter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">counter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="s2">&quot;_</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">id_</span>

        <span class="k">def</span> <span class="nf">_add_edge</span><span class="p">(</span><span class="n">id1</span><span class="p">,</span> <span class="n">id2</span><span class="p">,</span> <span class="n">arrowsize</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
            <span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">id1</span><span class="p">,</span> <span class="n">id2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">has_edge</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="n">g</span><span class="o">.</span><span class="n">del_edge</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_edge_attribute</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;arrowsize&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">arrowsize</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">e</span>

        <span class="k">def</span> <span class="nf">_add_extraction_merge_edge</span><span class="p">(</span><span class="n">id1</span><span class="p">,</span> <span class="n">id2</span><span class="p">):</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">_add_edge</span><span class="p">(</span><span class="n">id1</span><span class="p">,</span> <span class="n">id2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_edge_attribute</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;arrowhead&quot;</span><span class="p">,</span> <span class="s2">&quot;odot&quot;</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">_add_conflict_edge</span><span class="p">(</span><span class="n">id1</span><span class="p">,</span> <span class="n">id2</span><span class="p">):</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">_add_edge</span><span class="p">(</span><span class="n">id1</span><span class="p">,</span> <span class="n">id2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">set_edge_label</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s2">&quot;CONFLICT&quot;</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_edge_attribute</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;style&quot;</span><span class="p">,</span> <span class="s2">&quot;bold&quot;</span><span class="p">))</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_edge_attribute</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">))</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_edge_attribute</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;fontcolor&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">_add_cycle_edge</span><span class="p">(</span><span class="n">id1</span><span class="p">,</span> <span class="n">id2</span><span class="p">):</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">_add_edge</span><span class="p">(</span><span class="n">id1</span><span class="p">,</span> <span class="n">id2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">set_edge_label</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s2">&quot;CYCLE&quot;</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_edge_attribute</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;style&quot;</span><span class="p">,</span> <span class="s2">&quot;bold&quot;</span><span class="p">))</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_edge_attribute</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">))</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_edge_attribute</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;fontcolor&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">_add_reduct_edge</span><span class="p">(</span><span class="n">id1</span><span class="p">,</span> <span class="n">id2</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">_add_edge</span><span class="p">(</span><span class="n">id1</span><span class="p">,</span> <span class="n">id2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">set_edge_label</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_edge_attribute</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;fontsize&quot;</span><span class="p">,</span> <span class="n">node_fontsize</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">_add_node</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">style</span><span class="p">):</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">label</span><span class="p">),</span>
                     <span class="p">(</span><span class="s2">&quot;fontsize&quot;</span><span class="p">,</span> <span class="n">node_fontsize</span><span class="p">),</span>
                     <span class="p">(</span><span class="s2">&quot;fillcolor&quot;</span><span class="p">,</span> <span class="n">color</span><span class="p">),</span>
                     <span class="p">(</span><span class="s2">&quot;style&quot;</span><span class="p">,</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">style</span><span class="p">)]</span>
            <span class="n">id_</span> <span class="o">=</span> <span class="n">_uid</span><span class="p">()</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">id_</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">id_</span>

        <span class="k">def</span> <span class="nf">_add_request_node</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">initial_request</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">id_</span> <span class="o">=</span> <span class="n">request_nodes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">id_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">id_</span>

            <span class="n">label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">initial_request</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">request_color</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">node_color</span>

            <span class="n">id_</span> <span class="o">=</span> <span class="n">_add_node</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="s2">&quot;filled,dashed&quot;</span><span class="p">)</span>
            <span class="n">request_nodes</span><span class="p">[</span><span class="n">request</span><span class="p">]</span> <span class="o">=</span> <span class="n">id_</span>
            <span class="k">return</span> <span class="n">id_</span>

        <span class="k">def</span> <span class="nf">_add_scope_node</span><span class="p">(</span><span class="n">scope</span><span class="p">):</span>
            <span class="n">id_</span> <span class="o">=</span> <span class="n">scope_nodes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">scope</span><span class="o">.</span><span class="n">package_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">id_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">id_</span>

            <span class="n">variant</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">_get_solved_variant</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">variant</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">variant</span><span class="p">)</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">solved_color</span>
                <span class="n">style</span> <span class="o">=</span> <span class="s2">&quot;filled&quot;</span>
            <span class="k">elif</span> <span class="n">scope</span><span class="o">.</span><span class="n">is_conflict</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">node_color</span>
                <span class="n">style</span> <span class="o">=</span> <span class="s2">&quot;filled,dashed&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">node_color</span>
                <span class="n">style</span> <span class="o">=</span> <span class="s2">&quot;filled&quot;</span>

            <span class="n">id_</span> <span class="o">=</span> <span class="n">_add_node</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">style</span><span class="p">)</span>
            <span class="n">scope_nodes</span><span class="p">[</span><span class="n">scope</span><span class="o">.</span><span class="n">package_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">id_</span>
            <span class="n">scope_requests</span><span class="p">[</span><span class="n">id_</span><span class="p">]</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">package_request</span>
            <span class="k">return</span> <span class="n">id_</span>

        <span class="k">def</span> <span class="nf">_add_reduct_node</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">_add_node</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="p">),</span> <span class="n">node_color</span><span class="p">,</span> <span class="s2">&quot;filled,dashed&quot;</span><span class="p">)</span>

        <span class="c1"># -- generate the graph</span>

        <span class="c1"># create initial request nodes</span>
        <span class="k">for</span> <span class="n">request</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">request_list</span><span class="p">:</span>
            <span class="n">_add_request_node</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># create scope nodes</span>
        <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scope</span><span class="o">.</span><span class="n">is_conflict</span><span class="p">:</span>
                <span class="n">id1</span> <span class="o">=</span> <span class="n">request_nodes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">scope</span><span class="o">.</span><span class="n">package_request</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">id1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># special case - a scope that matches an initial conflict request,</span>
                    <span class="c1"># we switch nodes so the request node becomes a scope node</span>
                    <span class="n">scope_nodes</span><span class="p">[</span><span class="n">scope</span><span class="o">.</span><span class="n">package_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">id1</span>
                    <span class="k">del</span> <span class="n">request_nodes</span><span class="p">[</span><span class="n">scope</span><span class="o">.</span><span class="n">package_request</span><span class="p">]</span>
                    <span class="k">continue</span>

            <span class="n">_add_scope_node</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>

        <span class="c1"># create (initial request -&gt; scope) edges</span>
        <span class="k">for</span> <span class="n">request</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">request_list</span><span class="p">:</span>
            <span class="n">id1</span> <span class="o">=</span> <span class="n">request_nodes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">id1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">id2</span> <span class="o">=</span> <span class="n">scope_nodes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">id2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">_add_edge</span><span class="p">(</span><span class="n">id1</span><span class="p">,</span> <span class="n">id2</span><span class="p">)</span>

        <span class="c1"># for solved scopes, create (scope -&gt; requirement) edge</span>
        <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
            <span class="n">variant</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">_get_solved_variant</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">variant</span><span class="p">:</span>
                <span class="n">id1</span> <span class="o">=</span> <span class="n">scope_nodes</span><span class="p">[</span><span class="n">scope</span><span class="o">.</span><span class="n">package_name</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">request</span> <span class="ow">in</span> <span class="n">variant</span><span class="o">.</span><span class="n">requires_list</span><span class="o">.</span><span class="n">requirements</span><span class="p">:</span>
                    <span class="n">id2</span> <span class="o">=</span> <span class="n">_add_request_node</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
                    <span class="n">_add_edge</span><span class="p">(</span><span class="n">id1</span><span class="p">,</span> <span class="n">id2</span><span class="p">)</span>

        <span class="c1"># add extractions</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">src_fam</span><span class="p">,</span> <span class="n">_</span><span class="p">),</span> <span class="n">dest_req</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extractions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">id1</span> <span class="o">=</span> <span class="n">scope_nodes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">src_fam</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">id1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">id2</span> <span class="o">=</span> <span class="n">_add_request_node</span><span class="p">(</span><span class="n">dest_req</span><span class="p">)</span>
                <span class="n">_add_edge</span><span class="p">(</span><span class="n">id1</span><span class="p">,</span> <span class="n">id2</span><span class="p">)</span>

        <span class="c1"># add extraction intersections</span>
        <span class="n">extracted_fams</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extractions</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">fam</span> <span class="ow">in</span> <span class="n">extracted_fams</span><span class="p">:</span>
            <span class="n">requests</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extractions</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">fam</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">requests</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">reqlist</span> <span class="o">=</span> <span class="n">RequirementList</span><span class="p">(</span><span class="n">requests</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">reqlist</span><span class="o">.</span><span class="n">conflict</span><span class="p">:</span>
                    <span class="n">merged_request</span> <span class="o">=</span> <span class="n">reqlist</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fam</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">request</span> <span class="ow">in</span> <span class="n">requests</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">merged_request</span> <span class="o">!=</span> <span class="n">request</span><span class="p">:</span>
                            <span class="n">id1</span> <span class="o">=</span> <span class="n">_add_request_node</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
                            <span class="n">id2</span> <span class="o">=</span> <span class="n">_add_request_node</span><span class="p">(</span><span class="n">merged_request</span><span class="p">)</span>
                            <span class="n">_add_extraction_merge_edge</span><span class="p">(</span><span class="n">id1</span><span class="p">,</span> <span class="n">id2</span><span class="p">)</span>

        <span class="c1"># add conflicts</span>
        <span class="n">fr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure_reason</span>
        <span class="k">if</span> <span class="n">fr</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fr</span><span class="p">,</span> <span class="n">DependencyConflicts</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">conflict</span> <span class="ow">in</span> <span class="n">fr</span><span class="o">.</span><span class="n">conflicts</span><span class="p">:</span>
                    <span class="n">conflicting_request</span> <span class="o">=</span> <span class="n">conflict</span><span class="o">.</span><span class="n">conflicting_request</span>
                    <span class="n">scope_n</span> <span class="o">=</span> <span class="n">scope_nodes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">conflicting_request</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">scope_r</span> <span class="o">=</span> <span class="n">scope_requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">scope_n</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">scope_n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> \
                            <span class="ow">and</span> <span class="n">scope_r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> \
                            <span class="ow">and</span> <span class="n">scope_r</span><span class="o">.</span><span class="n">conflicts_with</span><span class="p">(</span><span class="n">conflicting_request</span><span class="p">):</span>
                        <span class="c1"># confirmed that scope node is in conflict</span>
                        <span class="n">id1</span> <span class="o">=</span> <span class="n">_add_request_node</span><span class="p">(</span><span class="n">conflicting_request</span><span class="p">)</span>
                        <span class="n">id2</span> <span class="o">=</span> <span class="n">scope_n</span>
                    <span class="k">elif</span> <span class="n">scope_n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">scope_r</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># occurs when an existing conflict request conflicts</span>
                        <span class="c1"># with a pkg requirement</span>
                        <span class="n">id1</span> <span class="o">=</span> <span class="n">scope_n</span>
                        <span class="n">id2</span> <span class="o">=</span> <span class="n">_add_request_node</span><span class="p">(</span><span class="n">conflict</span><span class="o">.</span><span class="n">dependency</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">id1</span> <span class="o">=</span> <span class="n">_add_request_node</span><span class="p">(</span><span class="n">conflict</span><span class="o">.</span><span class="n">dependency</span><span class="p">)</span>
                        <span class="n">id2</span> <span class="o">=</span> <span class="n">scope_n</span> <span class="ow">or</span> <span class="n">_add_request_node</span><span class="p">(</span><span class="n">conflicting_request</span><span class="p">)</span>

                    <span class="n">_add_conflict_edge</span><span class="p">(</span><span class="n">id1</span><span class="p">,</span> <span class="n">id2</span><span class="p">)</span>

                    <span class="n">failure_nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id1</span><span class="p">)</span>
                    <span class="n">failure_nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id2</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fr</span><span class="p">,</span> <span class="n">TotalReduction</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fr</span><span class="o">.</span><span class="n">reductions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># special case - singular total reduction</span>
                    <span class="n">reduct</span> <span class="o">=</span> <span class="n">fr</span><span class="o">.</span><span class="n">reductions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">id1</span> <span class="o">=</span> <span class="n">scope_nodes</span><span class="p">[</span><span class="n">reduct</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                    <span class="n">id2</span> <span class="o">=</span> <span class="n">_add_request_node</span><span class="p">(</span><span class="n">reduct</span><span class="o">.</span><span class="n">dependency</span><span class="p">)</span>
                    <span class="n">id3</span> <span class="o">=</span> <span class="n">scope_nodes</span><span class="p">[</span><span class="n">reduct</span><span class="o">.</span><span class="n">conflicting_request</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                    <span class="n">_add_edge</span><span class="p">(</span><span class="n">id1</span><span class="p">,</span> <span class="n">id2</span><span class="p">)</span>
                    <span class="n">_add_conflict_edge</span><span class="p">(</span><span class="n">id2</span><span class="p">,</span> <span class="n">id3</span><span class="p">)</span>

                    <span class="n">failure_nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id1</span><span class="p">)</span>
                    <span class="n">failure_nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id2</span><span class="p">)</span>
                    <span class="n">failure_nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id3</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">reduct</span> <span class="ow">in</span> <span class="n">fr</span><span class="o">.</span><span class="n">reductions</span><span class="p">:</span>
                        <span class="n">id1</span> <span class="o">=</span> <span class="n">scope_nodes</span><span class="p">[</span><span class="n">reduct</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                        <span class="n">id2</span> <span class="o">=</span> <span class="n">_add_reduct_node</span><span class="p">(</span><span class="n">reduct</span><span class="o">.</span><span class="n">dependency</span><span class="p">)</span>
                        <span class="n">id3</span> <span class="o">=</span> <span class="n">scope_nodes</span><span class="p">[</span><span class="n">reduct</span><span class="o">.</span><span class="n">conflicting_request</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                        <span class="n">_add_reduct_edge</span><span class="p">(</span><span class="n">id1</span><span class="p">,</span> <span class="n">id2</span><span class="p">,</span> <span class="n">reduct</span><span class="o">.</span><span class="n">reducee_str</span><span class="p">())</span>
                        <span class="n">_add_conflict_edge</span><span class="p">(</span><span class="n">id2</span><span class="p">,</span> <span class="n">id3</span><span class="p">)</span>

                        <span class="n">failure_nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id1</span><span class="p">)</span>
                        <span class="n">failure_nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id2</span><span class="p">)</span>
                        <span class="n">failure_nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id3</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fr</span><span class="p">,</span> <span class="n">Cycle</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fr</span><span class="o">.</span><span class="n">packages</span><span class="p">):</span>
                    <span class="n">id1</span> <span class="o">=</span> <span class="n">scope_nodes</span><span class="p">[</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                    <span class="n">failure_nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id1</span><span class="p">)</span>
                    <span class="n">pkg2</span> <span class="o">=</span> <span class="n">fr</span><span class="o">.</span><span class="n">packages</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">fr</span><span class="o">.</span><span class="n">packages</span><span class="p">)]</span>
                    <span class="n">id2</span> <span class="o">=</span> <span class="n">scope_nodes</span><span class="p">[</span><span class="n">pkg2</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                    <span class="n">_add_cycle_edge</span><span class="p">(</span><span class="n">id1</span><span class="p">,</span> <span class="n">id2</span><span class="p">)</span>

        <span class="c1"># connect leaf-node requests to a matching scope, if any</span>
        <span class="k">for</span> <span class="n">request</span><span class="p">,</span> <span class="n">id1</span> <span class="ow">in</span> <span class="n">request_nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">id1</span><span class="p">):</span>  <span class="c1"># leaf node</span>
                <span class="n">id2</span> <span class="o">=</span> <span class="n">scope_nodes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">id2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">scope</span> <span class="o">=</span> <span class="n">scopes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">conflicts_with</span><span class="p">(</span><span class="n">scope</span><span class="o">.</span><span class="n">package_request</span><span class="p">):</span>
                        <span class="n">_add_edge</span><span class="p">(</span><span class="n">id1</span><span class="p">,</span> <span class="n">id2</span><span class="p">)</span>

        <span class="c1"># prune nodes not related to failure</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">prune_unfailed</span> <span class="ow">and</span> <span class="n">failure_nodes</span><span class="p">:</span>
            <span class="n">access_dict</span> <span class="o">=</span> <span class="n">accessibility</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
            <span class="n">del_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">access_nodes</span> <span class="ow">in</span> <span class="n">access_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">access_nodes</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">failure_nodes</span><span class="p">):</span>
                    <span class="n">del_nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">del_nodes</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">del_node</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">g</span>

    <span class="k">def</span> <span class="nf">_get_minimal_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_solved</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">scopes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">package_name</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scopes</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">scopes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">scope</span><span class="o">.</span><span class="n">is_conflict</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">scope</span><span class="o">.</span><span class="n">package_name</span><span class="p">)</span>

            <span class="n">variant</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">_get_solved_variant</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">variant</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">variant</span><span class="o">.</span><span class="n">requires_list</span><span class="o">.</span><span class="n">requirements</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">req</span><span class="o">.</span><span class="n">conflict</span><span class="p">:</span>
                        <span class="n">edges</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">scope</span><span class="o">.</span><span class="n">package_name</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

        <span class="n">g</span> <span class="o">=</span> <span class="n">digraph</span><span class="p">()</span>
        <span class="n">g</span><span class="o">.</span><span class="n">add_nodes</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">g</span>

    <span class="k">def</span> <span class="nf">_is_solved</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">scope</span><span class="o">.</span><span class="n">_is_solved</span><span class="p">():</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_get_solved_variants</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">variants</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
            <span class="n">variant</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">_get_solved_variant</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">variant</span><span class="p">:</span>
                <span class="n">variants</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">variant</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">variants</span>

    <span class="k">def</span> <span class="nf">_get_solved_ephemerals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ephemerals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scopes</span><span class="p">:</span>
            <span class="n">ephemeral</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">_get_solved_ephemeral</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">ephemeral</span><span class="p">:</span>
                <span class="n">ephemerals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ephemeral</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ephemerals</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scopes</span><span class="p">)</span>


<div class="viewcode-block" id="Solver"><a class="viewcode-back" href="../../api/rez.html#rez.solver.Solver">[docs]</a><span class="k">class</span> <span class="nc">Solver</span><span class="p">(</span><span class="n">_Common</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Solver.</span>

<span class="sd">    A package solver takes a list of package requests (the &#39;request&#39;), then</span>
<span class="sd">    runs a resolve algorithm in order to determine the &#39;resolve&#39; - the list of</span>
<span class="sd">    non-conflicting packages that include all dependencies.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">max_verbosity</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package_requests</span><span class="p">,</span> <span class="n">package_paths</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">package_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">package_orderers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">building</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optimised</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">package_load_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prune_unfailed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">suppress_passive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">print_stats</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a Solver.</span>

<span class="sd">        Args:</span>
<span class="sd">            package_requests: List of Requirement objects representing the</span>
<span class="sd">                request.</span>
<span class="sd">            package_paths: List of paths to search for pkgs.</span>
<span class="sd">            context (`ResolvedContext`): Context this solver is used within, if</span>
<span class="sd">                any. This is needed in a solve if any packages contain late</span>
<span class="sd">                binding package attributes that need access to context info.</span>
<span class="sd">            package_filter (`PackageFilterBase`): Filter for excluding packages.</span>
<span class="sd">            package_orderers (list of `PackageOrder`): Custom package ordering.</span>
<span class="sd">            building: True if we&#39;re resolving for a build.</span>
<span class="sd">            optimised: Run the solver in optimised mode. This is only ever set</span>
<span class="sd">                to False for testing purposes.</span>
<span class="sd">            callback: If not None, this callable will be called after each</span>
<span class="sd">                solve step. It is passed a `SolverState` object. It must return</span>
<span class="sd">                a 2-tuple:</span>
<span class="sd">                - `SolverCallbackReturn` object indicating what to do next;</span>
<span class="sd">                - str: Reason for solve abort, ignored if solve not aborted.</span>
<span class="sd">                If the callable returns `SolverCallbackReturn.fail`, but there</span>
<span class="sd">                has not been a failure, the solver will ignore the callback and</span>
<span class="sd">                continue on with the solve.</span>
<span class="sd">            package_load_callback: If not None, this callable will be called</span>
<span class="sd">                prior to each package being loaded. It is passed a single</span>
<span class="sd">                `Package` object.</span>
<span class="sd">            prune_unfailed (bool): If the solve failed, and `prune_unfailed` is</span>
<span class="sd">                True, any packages unrelated to the conflict are removed from</span>
<span class="sd">                the graph.</span>
<span class="sd">            suppress_passive (bool): If True, don&#39;t print debugging info that</span>
<span class="sd">                has had no effect on the solve. This argument only has an</span>
<span class="sd">                effect if `verbosity` &gt; 2.</span>
<span class="sd">            print_stats (bool): If true, print advanced solver stats at the end.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">package_paths</span> <span class="o">=</span> <span class="n">package_paths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">package_filter</span> <span class="o">=</span> <span class="n">package_filter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">package_orderers</span> <span class="o">=</span> <span class="n">package_orderers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">callback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prune_unfailed</span> <span class="o">=</span> <span class="n">prune_unfailed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">package_load_callback</span> <span class="o">=</span> <span class="n">package_load_callback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">building</span> <span class="o">=</span> <span class="n">building</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pr</span> <span class="o">=</span> <span class="n">_Printer</span><span class="p">(</span><span class="n">verbosity</span><span class="p">,</span> <span class="n">buf</span><span class="o">=</span><span class="n">buf</span><span class="p">,</span> <span class="n">suppress_passive</span><span class="o">=</span><span class="n">suppress_passive</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_stats</span> <span class="o">=</span> <span class="n">print_stats</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span>

        <span class="k">if</span> <span class="n">_force_unoptimised_solver</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimised</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimised</span> <span class="o">=</span> <span class="n">optimised</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">phase_stack</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failed_phase_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abort_reason</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callback_return</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth_counts</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solve_begun</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solve_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_time</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># advanced solve metrics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solve_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extractions_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intersections_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intersection_tests_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intersection_broad_tests_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reductions_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reduction_tests_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reduction_broad_tests_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">extraction_time</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intersection_time</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intersection_test_time</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reduction_time</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reduction_test_time</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_init</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">package_cache</span> <span class="o">=</span> <span class="n">PackageVariantCache</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># merge the request</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s2">&quot;request: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">package_requests</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_list</span> <span class="o">=</span> <span class="n">RequirementList</span><span class="p">(</span><span class="n">package_requests</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_list</span><span class="o">.</span><span class="n">conflict</span><span class="p">:</span>
            <span class="n">req1</span><span class="p">,</span> <span class="n">req2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_list</span><span class="o">.</span><span class="n">conflict</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s2">&quot;conflict in request: </span><span class="si">%s</span><span class="s2"> &lt;--!--&gt; </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">req1</span><span class="p">,</span> <span class="n">req2</span><span class="p">)</span>

            <span class="n">conflict</span> <span class="o">=</span> <span class="n">DependencyConflict</span><span class="p">(</span><span class="n">req1</span><span class="p">,</span> <span class="n">req2</span><span class="p">)</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="n">_ResolvePhase</span><span class="p">(</span><span class="n">solver</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">phase</span><span class="o">.</span><span class="n">failure_reason</span> <span class="o">=</span> <span class="n">DependencyConflicts</span><span class="p">([</span><span class="n">conflict</span><span class="p">])</span>
            <span class="n">phase</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">SolverStatus</span><span class="o">.</span><span class="n">failed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_push_phase</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_list</span><span class="o">.</span><span class="n">requirements</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s2">&quot;merged request: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

        <span class="c1"># create the initial phase</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">_ResolvePhase</span><span class="p">(</span><span class="n">solver</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_push_phase</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>

<div class="viewcode-block" id="Solver.timed"><a class="viewcode-back" href="../../api/rez.html#rez.solver.Solver.timed">[docs]</a>    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">timed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">yield</span>
        <span class="n">secs</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span>
        <span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">secs</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the current status of the solve.</span>

<span class="sd">        Returns:</span>
<span class="sd">          SolverStatus: Enum representation of the state of the solver.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_list</span><span class="o">.</span><span class="n">conflict</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SolverStatus</span><span class="o">.</span><span class="n">failed</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback_return</span> <span class="o">==</span> <span class="n">SolverCallbackReturn</span><span class="o">.</span><span class="n">fail</span><span class="p">:</span>
            <span class="c1"># the solve has failed because a callback has nominated the most</span>
            <span class="c1"># recent failure as the reason.</span>
            <span class="k">return</span> <span class="n">SolverStatus</span><span class="o">.</span><span class="n">failed</span>

        <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">status</span>
        <span class="k">if</span> <span class="n">st</span> <span class="o">==</span> <span class="n">SolverStatus</span><span class="o">.</span><span class="n">cyclic</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SolverStatus</span><span class="o">.</span><span class="n">failed</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_stack</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">st</span> <span class="o">==</span> <span class="n">SolverStatus</span><span class="o">.</span><span class="n">solved</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">SolverStatus</span><span class="o">.</span><span class="n">solved</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">SolverStatus</span><span class="o">.</span><span class="n">unsolved</span>
        <span class="k">elif</span> <span class="n">st</span> <span class="ow">in</span> <span class="p">(</span><span class="n">SolverStatus</span><span class="o">.</span><span class="n">pending</span><span class="p">,</span> <span class="n">SolverStatus</span><span class="o">.</span><span class="n">exhausted</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">SolverStatus</span><span class="o">.</span><span class="n">unsolved</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">st</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_solves</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the number of solve steps that have been executed.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">solve_count</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_fails</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the number of failed solve steps that have been executed.</span>
<span class="sd">        Note that num_solves is inclusive of failures.&quot;&quot;&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">failed_phase_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">(</span><span class="n">SolverStatus</span><span class="o">.</span><span class="n">failed</span><span class="p">,</span> <span class="n">SolverStatus</span><span class="o">.</span><span class="n">cyclic</span><span class="p">):</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">n</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cyclic_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return True if the solve failed due to a cycle, False otherwise.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">SolverStatus</span><span class="o">.</span><span class="n">cyclic</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">resolved_packages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of resolved variants.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list of `PackageVariant`: Resolved variants, or None if the resolve</span>
<span class="sd">            did not complete or was unsuccessful.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">SolverStatus</span><span class="o">.</span><span class="n">solved</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">final_phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">final_phase</span><span class="o">.</span><span class="n">_get_solved_variants</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">resolved_ephemerals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the list of final ephemeral package ranges.</span>

<span class="sd">        Note that conflict ephemerals are not included.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of `Requirement`: Final non-conflict ephemerals, or None</span>
<span class="sd">            if the resolve did not complete or was unsuccessful.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">SolverStatus</span><span class="o">.</span><span class="n">solved</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">final_phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">final_phase</span><span class="o">.</span><span class="n">_get_solved_ephemerals</span><span class="p">()</span>

<div class="viewcode-block" id="Solver.reset"><a class="viewcode-back" href="../../api/rez.html#rez.solver.Solver.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reset the solver, removing any current solve.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_list</span><span class="o">.</span><span class="n">conflict</span><span class="p">:</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="n">_ResolvePhase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_list</span><span class="o">.</span><span class="n">requirements</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s2">&quot;resetting...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_push_phase</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span></div>

<div class="viewcode-block" id="Solver.solve"><a class="viewcode-back" href="../../api/rez.html#rez.solver.Solver.solve">[docs]</a>    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Attempt to solve the request.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solve_begun</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ResolveError</span><span class="p">(</span><span class="s2">&quot;cannot run solve() on a solve that has &quot;</span>
                               <span class="s2">&quot;already been started&quot;</span><span class="p">)</span>

        <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">pt1</span> <span class="o">=</span> <span class="n">package_repo_stats</span><span class="o">.</span><span class="n">package_load_time</span>

        <span class="c1"># iteratively solve phases</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">SolverStatus</span><span class="o">.</span><span class="n">unsolved</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solve_step</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">SolverStatus</span><span class="o">.</span><span class="n">unsolved</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_callback</span><span class="p">():</span>
                <span class="k">break</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load_time</span> <span class="o">=</span> <span class="n">package_repo_stats</span><span class="o">.</span><span class="n">package_load_time</span> <span class="o">-</span> <span class="n">pt1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solve_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t1</span>

        <span class="c1"># print stats</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pformat</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;SOLVE STATS:&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="n">pformat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solve_stats</span><span class="p">))</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_stats</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pformat</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;solve_stats&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">solve_stats</span><span class="p">}</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">pformat</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">))</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">solve_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">extraction_stats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;extraction_time&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">extraction_time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;num_extractions&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">extractions_count</span>
        <span class="p">}</span>

        <span class="n">intersection_stats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;num_intersections&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersections_count</span><span class="p">,</span>
            <span class="s2">&quot;num_intersection_tests&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersection_tests_count</span><span class="p">,</span>
            <span class="s2">&quot;num_intersection_broad_tests&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersection_broad_tests_count</span><span class="p">,</span>
            <span class="s2">&quot;intersection_time&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersection_time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;intersection_test_time&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersection_test_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">}</span>

        <span class="n">reduction_stats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;num_reductions&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reductions_count</span><span class="p">,</span>
            <span class="s2">&quot;num_reduction_tests&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduction_tests_count</span><span class="p">,</span>
            <span class="s2">&quot;num_reduction_broad_tests&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduction_broad_tests_count</span><span class="p">,</span>
            <span class="s2">&quot;reduction_time&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduction_time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;reduction_test_time&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduction_test_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">}</span>

        <span class="n">global_stats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;num_solves&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_solves</span><span class="p">,</span>
            <span class="s2">&quot;num_fails&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_fails</span><span class="p">,</span>
            <span class="s2">&quot;solve_time&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">solve_time</span><span class="p">,</span>
            <span class="s2">&quot;load_time&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_time</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;global&quot;</span><span class="p">:</span> <span class="n">global_stats</span><span class="p">,</span>
            <span class="s2">&quot;extractions&quot;</span><span class="p">:</span> <span class="n">extraction_stats</span><span class="p">,</span>
            <span class="s2">&quot;intersections&quot;</span><span class="p">:</span> <span class="n">intersection_stats</span><span class="p">,</span>
            <span class="s2">&quot;reductions&quot;</span><span class="p">:</span> <span class="n">reduction_stats</span>
        <span class="p">}</span>

<div class="viewcode-block" id="Solver.solve_step"><a class="viewcode-back" href="../../api/rez.html#rez.solver.Solver.solve_step">[docs]</a>    <span class="k">def</span> <span class="nf">solve_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform a single solve step.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solve_begun</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">SolverStatus</span><span class="o">.</span><span class="n">unsolved</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;SOLVE #</span><span class="si">%d</span><span class="s2"> (</span><span class="si">%d</span><span class="s2"> fails so far)...&quot;</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">solve_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_fails</span><span class="p">)</span>

        <span class="n">phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_phase</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">phase</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">SolverStatus</span><span class="o">.</span><span class="n">failed</span><span class="p">:</span>  <span class="c1"># a previously failed phase</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s2">&quot;discarded failed phase, fetching previous unsolved phase...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">failed_phase_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_phase</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">phase</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">SolverStatus</span><span class="o">.</span><span class="n">exhausted</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;SPLITTING:&quot;</span><span class="p">)</span>
            <span class="n">phase</span><span class="p">,</span> <span class="n">next_phase</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_push_phase</span><span class="p">(</span><span class="n">next_phase</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s2">&quot;new phase: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">phase</span><span class="p">)</span>

        <span class="n">new_phase</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solve_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">new_phase</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">SolverStatus</span><span class="o">.</span><span class="n">failed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;FAILED:&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_push_phase</span><span class="p">(</span><span class="n">new_phase</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pr</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_stack</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;FAIL: there is no solution&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">new_phase</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">SolverStatus</span><span class="o">.</span><span class="n">solved</span><span class="p">:</span>
            <span class="c1"># solved, but there may be cyclic dependencies</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;SOLVED:&quot;</span><span class="p">)</span>
            <span class="n">final_phase</span> <span class="o">=</span> <span class="n">new_phase</span><span class="o">.</span><span class="n">finalise</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_push_phase</span><span class="p">(</span><span class="n">final_phase</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">final_phase</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">SolverStatus</span><span class="o">.</span><span class="n">cyclic</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;FAIL: a cycle was detected&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;SUCCESS&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;EXHAUSTED:&quot;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">new_phase</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">SolverStatus</span><span class="o">.</span><span class="n">exhausted</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_push_phase</span><span class="p">(</span><span class="n">new_phase</span><span class="p">)</span></div>

<div class="viewcode-block" id="Solver.failure_reason"><a class="viewcode-back" href="../../api/rez.html#rez.solver.Solver.failure_reason">[docs]</a>    <span class="k">def</span> <span class="nf">failure_reason</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">failure_index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the reason for a failure.</span>

<span class="sd">        Args:</span>
<span class="sd">            failure_index: Index of the fail to return the graph for (can be</span>
<span class="sd">                negative). If None, the most appropriate failure is chosen</span>
<span class="sd">                according to these rules:</span>
<span class="sd">                - If the fail is cyclic, the most recent fail (the one containing</span>
<span class="sd">                  the cycle) is used;</span>
<span class="sd">                - If a callback has caused a failure, the most recent fail is used;</span>
<span class="sd">                - Otherwise, the first fail is used.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A `FailureReason` subclass instance describing the failure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">phase</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_failed_phase</span><span class="p">(</span><span class="n">failure_index</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">phase</span><span class="o">.</span><span class="n">failure_reason</span></div>

<div class="viewcode-block" id="Solver.failure_description"><a class="viewcode-back" href="../../api/rez.html#rez.solver.Solver.failure_description">[docs]</a>    <span class="k">def</span> <span class="nf">failure_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">failure_index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a description of the failure.</span>

<span class="sd">        This differs from `failure_reason` - in some cases, such as when a</span>
<span class="sd">        callback forces a failure, there is more information in the description</span>
<span class="sd">        than there is from `failure_reason`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_failed_phase</span><span class="p">(</span><span class="n">failure_index</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">description</span></div>

<div class="viewcode-block" id="Solver.failure_packages"><a class="viewcode-back" href="../../api/rez.html#rez.solver.Solver.failure_packages">[docs]</a>    <span class="k">def</span> <span class="nf">failure_packages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">failure_index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get packages involved in a failure.</span>

<span class="sd">        Args:</span>
<span class="sd">            failure_index: See `failure_reason`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list of Requirement objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">phase</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_failed_phase</span><span class="p">(</span><span class="n">failure_index</span><span class="p">)</span>
        <span class="n">fr</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">failure_reason</span>
        <span class="k">return</span> <span class="n">fr</span><span class="o">.</span><span class="n">involved_requirements</span><span class="p">()</span> <span class="k">if</span> <span class="n">fr</span> <span class="k">else</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Solver.get_graph"><a class="viewcode-back" href="../../api/rez.html#rez.solver.Solver.get_graph">[docs]</a>    <span class="k">def</span> <span class="nf">get_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the most recent solve graph.</span>

<span class="sd">        This gives a graph showing the latest state of the solve. The specific</span>
<span class="sd">        graph returned depends on the solve status. When status is:</span>
<span class="sd">        unsolved: latest unsolved graph is returned;</span>
<span class="sd">        solved:   final solved graph is returned;</span>
<span class="sd">        failed:   most appropriate failure graph is returned (see `failure_reason`);</span>
<span class="sd">        cyclic:   last failure is returned (contains cycle).</span>

<span class="sd">        Returns:</span>
<span class="sd">            A pygraph.digraph object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span>
        <span class="k">if</span> <span class="n">st</span> <span class="ow">in</span> <span class="p">(</span><span class="n">SolverStatus</span><span class="o">.</span><span class="n">solved</span><span class="p">,</span> <span class="n">SolverStatus</span><span class="o">.</span><span class="n">unsolved</span><span class="p">):</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latest_nonfailed_phase</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">phase</span><span class="o">.</span><span class="n">get_graph</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fail_graph</span><span class="p">()</span></div>

<div class="viewcode-block" id="Solver.get_fail_graph"><a class="viewcode-back" href="../../api/rez.html#rez.solver.Solver.get_fail_graph">[docs]</a>    <span class="k">def</span> <span class="nf">get_fail_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">failure_index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a graph showing a solve failure.</span>

<span class="sd">        Args:</span>
<span class="sd">            failure_index: See `failure_reason`</span>

<span class="sd">        Returns:</span>
<span class="sd">            A pygraph.digraph object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">phase</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_failed_phase</span><span class="p">(</span><span class="n">failure_index</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">phase</span><span class="o">.</span><span class="n">get_graph</span><span class="p">()</span></div>

<div class="viewcode-block" id="Solver.dump"><a class="viewcode-back" href="../../api/rez.html#rez.solver.Solver.dump">[docs]</a>    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print a formatted summary of the current solve state.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">rez.utils.formatting</span> <span class="kn">import</span> <span class="n">columnise</span>

        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">phase</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_stack</span><span class="p">):</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_depth_label</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">phase</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">phase</span><span class="p">)))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;status: </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">description</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;initial request: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_list</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;solve stack:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">columnise</span><span class="p">(</span><span class="n">rows</span><span class="p">)))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">failed_phase_list</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">phase</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">failed_phase_list</span><span class="p">):</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;#</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">phase</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">phase</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;previous failures:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">columnise</span><span class="p">(</span><span class="n">rows</span><span class="p">)))</span></div>

    <span class="k">def</span> <span class="nf">_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phase_stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failed_phase_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth_counts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solve_time</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_time</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solve_begun</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># advanced solve stats</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solve_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extractions_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intersections_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intersection_tests_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intersection_broad_tests_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reductions_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reduction_tests_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reduction_broad_tests_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">extraction_time</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intersection_time</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intersection_test_time</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reduction_time</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reduction_test_time</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_latest_nonfailed_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">SolverStatus</span><span class="o">.</span><span class="n">failed</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_stack</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">phase</span><span class="o">.</span><span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">SolverStatus</span><span class="o">.</span><span class="n">failed</span><span class="p">,</span> <span class="n">SolverStatus</span><span class="o">.</span><span class="n">cyclic</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">phase</span>
        <span class="k">assert</span> <span class="kc">False</span>  <span class="c1"># should never get here</span>

    <span class="k">def</span> <span class="nf">_do_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">keep_going</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">:</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latest_nonfailed_phase</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">phase</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">SolverState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_solves</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_fails</span><span class="p">,</span> <span class="n">phase</span><span class="p">)</span>
                <span class="n">value</span><span class="p">,</span> <span class="n">abort_reason</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="n">SolverCallbackReturn</span><span class="o">.</span><span class="n">abort</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s2">&quot;solve aborted: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">abort_reason</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">abort_reason</span> <span class="o">=</span> <span class="n">abort_reason</span>
                    <span class="n">keep_going</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="n">value</span> <span class="o">==</span> <span class="n">SolverCallbackReturn</span><span class="o">.</span><span class="n">fail</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_fails</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">abort_reason</span> <span class="o">=</span> <span class="n">abort_reason</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s2">&quot;solve failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">abort_reason</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">callback_return</span> <span class="o">=</span> <span class="n">value</span>
                        <span class="n">keep_going</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">keep_going</span>

    <span class="k">def</span> <span class="nf">_get_variant_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package_name</span><span class="p">,</span> <span class="n">range_</span><span class="p">):</span>
        <span class="n">slice_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_cache</span><span class="o">.</span><span class="n">get_variant_slice</span><span class="p">(</span>
            <span class="n">package_name</span><span class="o">=</span><span class="n">package_name</span><span class="p">,</span> <span class="n">range_</span><span class="o">=</span><span class="n">range_</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">slice_</span>

    <span class="k">def</span> <span class="nf">_push_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase</span><span class="p">):</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_stack</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth_counts</span><span class="p">[</span><span class="n">depth</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phase_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">:</span>
            <span class="n">dlabel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_depth_label</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s2">&quot;pushed </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dlabel</span><span class="p">,</span> <span class="n">phase</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_pop_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dlabel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_depth_label</span><span class="p">()</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s2">&quot;popped </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dlabel</span><span class="p">,</span> <span class="n">phase</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">phase</span>

    <span class="k">def</span> <span class="nf">_get_failed_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># returns (phase, fail_description)</span>
        <span class="n">prepend_abort_reason</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">fails</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">failed_phase_list</span>
        <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">status</span>
        <span class="k">if</span> <span class="n">st</span> <span class="ow">in</span> <span class="p">(</span><span class="n">SolverStatus</span><span class="o">.</span><span class="n">failed</span><span class="p">,</span> <span class="n">SolverStatus</span><span class="o">.</span><span class="n">cyclic</span><span class="p">):</span>
            <span class="n">fails</span> <span class="o">=</span> <span class="n">fails</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>

        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">st</span> <span class="o">==</span> <span class="n">SolverStatus</span><span class="o">.</span><span class="n">cyclic</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback_return</span> <span class="o">==</span> <span class="n">SolverCallbackReturn</span><span class="o">.</span><span class="n">fail</span><span class="p">:</span>
                <span class="n">prepend_abort_reason</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="n">fails</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;failure index out of range&quot;</span><span class="p">)</span>

        <span class="n">fail_description</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">failure_reason</span><span class="o">.</span><span class="n">description</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">prepend_abort_reason</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">abort_reason</span><span class="p">:</span>
            <span class="n">fail_description</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abort_reason</span><span class="p">,</span> <span class="n">fail_description</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">phase</span><span class="p">,</span> <span class="n">fail_description</span>

    <span class="k">def</span> <span class="nf">_depth_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">depth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_stack</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth_counts</span><span class="p">[</span><span class="n">depth</span><span class="p">]</span>
        <span class="k">return</span> <span class="s2">&quot;{</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">}&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">_depth_label</span><span class="p">(),</span>
                             <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span></div>


<span class="k">def</span> <span class="nf">_short_req_str</span><span class="p">(</span><span class="n">package_request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;print shortened version of &#39;==X|==Y|==Z&#39; ranged requests.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">package_request</span><span class="o">.</span><span class="n">conflict</span><span class="p">:</span>
        <span class="n">versions</span> <span class="o">=</span> <span class="n">package_request</span><span class="o">.</span><span class="n">range</span><span class="o">.</span><span class="n">to_versions</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">versions</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">versions</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">package_request</span><span class="o">.</span><span class="n">range</span><span class="p">)</span> \
                <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">versions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-</span><span class="si">%s</span><span class="s2">(</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">package_request</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                  <span class="nb">str</span><span class="p">(</span><span class="n">package_request</span><span class="o">.</span><span class="n">range</span><span class="o">.</span><span class="n">span</span><span class="p">()),</span>
                                  <span class="nb">len</span><span class="p">(</span><span class="n">versions</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">package_request</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2014, Allan Johns.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>