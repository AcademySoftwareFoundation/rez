<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>rez.rex &mdash; Rez 2.112.0 documentation</title><link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> Rez
          </a>
              <div class="version">
                2.112
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/modules.html">1. API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../one-liners.html">2. One-Liners</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Rez</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">rez.rex</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for rez.rex</h1><div class="highlight"><pre>
<span></span><span class="c1"># SPDX-License-Identifier: Apache-2.0</span>
<span class="c1"># Copyright Contributors to the Rez Project</span>


<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">fnmatch</span> <span class="kn">import</span> <span class="n">fnmatch</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">string</span> <span class="kn">import</span> <span class="n">Formatter</span>

<span class="kn">from</span> <span class="nn">rez.system</span> <span class="kn">import</span> <span class="n">system</span>
<span class="kn">from</span> <span class="nn">rez.config</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">rez.exceptions</span> <span class="kn">import</span> <span class="n">RexError</span><span class="p">,</span> <span class="n">RexUndefinedVariableError</span><span class="p">,</span> \
    <span class="n">RezSystemError</span><span class="p">,</span> <span class="n">_NeverError</span>
<span class="kn">from</span> <span class="nn">rez.util</span> <span class="kn">import</span> <span class="n">shlex_join</span><span class="p">,</span> <span class="n">is_non_string_iterable</span>
<span class="kn">from</span> <span class="nn">rez.utils</span> <span class="kn">import</span> <span class="n">reraise</span>
<span class="kn">from</span> <span class="nn">rez.utils.execution</span> <span class="kn">import</span> <span class="n">Popen</span>
<span class="kn">from</span> <span class="nn">rez.utils.sourcecode</span> <span class="kn">import</span> <span class="n">SourceCode</span><span class="p">,</span> <span class="n">SourceCodeError</span>
<span class="kn">from</span> <span class="nn">rez.utils.data_utils</span> <span class="kn">import</span> <span class="n">AttrDictWrapper</span>
<span class="kn">from</span> <span class="nn">rez.utils.formatting</span> <span class="kn">import</span> <span class="n">expandvars</span>
<span class="kn">from</span> <span class="nn">rez.utils.platform_</span> <span class="kn">import</span> <span class="n">platform_</span>
<span class="kn">from</span> <span class="nn">rez.vendor.enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">rez.vendor.six</span> <span class="kn">import</span> <span class="n">six</span>


<span class="n">basestring</span> <span class="o">=</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># http://python3porting.com/problems.html#replacing-userdict</span>
<span class="k">if</span> <span class="n">six</span><span class="o">.</span><span class="n">PY2</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">UserDict</span> <span class="kn">import</span> <span class="n">DictMixin</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">MutableMapping</span> <span class="k">as</span> <span class="n">DictMixin</span>


<span class="c1">#===============================================================================</span>
<span class="c1"># Actions</span>
<span class="c1">#===============================================================================</span>

<div class="viewcode-block" id="Action"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Action">[docs]</a><span class="k">class</span> <span class="nc">Action</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">_registry</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                           <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>

<div class="viewcode-block" id="Action.register_command_type"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Action.register_command_type">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">register_command_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">klass</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">klass</span><span class="p">))</span></div>

<div class="viewcode-block" id="Action.register"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Action.register">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">register_command_type</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span></div>

<div class="viewcode-block" id="Action.get_command_types"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Action.get_command_types">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_command_types</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_registry</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="EnvAction"><a class="viewcode-back" href="../../api/rez.html#rez.rex.EnvAction">[docs]</a><span class="k">class</span> <span class="nc">EnvAction</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="Unsetenv"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Unsetenv">[docs]</a><span class="k">class</span> <span class="nc">Unsetenv</span><span class="p">(</span><span class="n">EnvAction</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;unsetenv&#39;</span></div>


<div class="viewcode-block" id="Setenv"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Setenv">[docs]</a><span class="k">class</span> <span class="nc">Setenv</span><span class="p">(</span><span class="n">EnvAction</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;setenv&#39;</span>

<div class="viewcode-block" id="Setenv.pre_exec"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Setenv.pre_exec">[docs]</a>    <span class="k">def</span> <span class="nf">pre_exec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interpreter</span><span class="p">):</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">interpreter</span><span class="o">.</span><span class="n">_env_sep</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span></div>

<div class="viewcode-block" id="Setenv.post_exec"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Setenv.post_exec">[docs]</a>    <span class="k">def</span> <span class="nf">post_exec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interpreter</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="n">interpreter</span><span class="o">.</span><span class="n">_environ</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div></div>


<div class="viewcode-block" id="Resetenv"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Resetenv">[docs]</a><span class="k">class</span> <span class="nc">Resetenv</span><span class="p">(</span><span class="n">EnvAction</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;resetenv&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">friends</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<div class="viewcode-block" id="Resetenv.pre_exec"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Resetenv.pre_exec">[docs]</a>    <span class="k">def</span> <span class="nf">pre_exec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interpreter</span><span class="p">):</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">friends</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">interpreter</span><span class="o">.</span><span class="n">_env_sep</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">friends</span></div>

<div class="viewcode-block" id="Resetenv.post_exec"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Resetenv.post_exec">[docs]</a>    <span class="k">def</span> <span class="nf">post_exec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interpreter</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="n">interpreter</span><span class="o">.</span><span class="n">_environ</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div></div>


<div class="viewcode-block" id="Prependenv"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Prependenv">[docs]</a><span class="k">class</span> <span class="nc">Prependenv</span><span class="p">(</span><span class="n">Setenv</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;prependenv&#39;</span></div>


<div class="viewcode-block" id="Appendenv"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Appendenv">[docs]</a><span class="k">class</span> <span class="nc">Appendenv</span><span class="p">(</span><span class="n">Setenv</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;appendenv&#39;</span></div>


<div class="viewcode-block" id="Alias"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Alias">[docs]</a><span class="k">class</span> <span class="nc">Alias</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;alias&#39;</span></div>


<div class="viewcode-block" id="Info"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Info">[docs]</a><span class="k">class</span> <span class="nc">Info</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;info&#39;</span></div>


<div class="viewcode-block" id="Error"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Error">[docs]</a><span class="k">class</span> <span class="nc">Error</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;error&#39;</span></div>


<div class="viewcode-block" id="Stop"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Stop">[docs]</a><span class="k">class</span> <span class="nc">Stop</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;stop&#39;</span></div>


<div class="viewcode-block" id="Command"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Command">[docs]</a><span class="k">class</span> <span class="nc">Command</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;command&#39;</span></div>


<div class="viewcode-block" id="Comment"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Comment">[docs]</a><span class="k">class</span> <span class="nc">Comment</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;comment&#39;</span></div>


<div class="viewcode-block" id="Source"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Source">[docs]</a><span class="k">class</span> <span class="nc">Source</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;source&#39;</span></div>


<div class="viewcode-block" id="Shebang"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Shebang">[docs]</a><span class="k">class</span> <span class="nc">Shebang</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;shebang&#39;</span></div>


<span class="n">Unsetenv</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>
<span class="n">Setenv</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>
<span class="n">Resetenv</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>
<span class="n">Prependenv</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>
<span class="n">Appendenv</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>
<span class="n">Alias</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>
<span class="n">Info</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>
<span class="n">Error</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>
<span class="n">Stop</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>
<span class="n">Command</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>
<span class="n">Comment</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>
<span class="n">Source</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>
<span class="n">Shebang</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>


<span class="c1">#===============================================================================</span>
<span class="c1"># Action Manager</span>
<span class="c1">#===============================================================================</span>

<div class="viewcode-block" id="OutputStyle"><a class="viewcode-back" href="../../api/rez.html#rez.rex.OutputStyle">[docs]</a><span class="k">class</span> <span class="nc">OutputStyle</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Enum to represent the style of code output when using Rex.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">file</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Code as it would appear in a script file.&quot;</span><span class="p">,</span> <span class="p">)</span>
    <span class="nb">eval</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Code in a form that can be evaluated.&quot;</span><span class="p">,</span> <span class="p">)</span></div>


<div class="viewcode-block" id="ActionManager"><a class="viewcode-back" href="../../api/rez.html#rez.rex.ActionManager">[docs]</a><span class="k">class</span> <span class="nc">ActionManager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Handles the execution book-keeping.  Tracks env variable values, and</span>
<span class="sd">    triggers the callbacks of the `ActionInterpreter`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interpreter</span><span class="p">,</span> <span class="n">parent_environ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent_variables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">formatter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">env_sep_map</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        interpreter: string or `ActionInterpreter`</span>
<span class="sd">            the interpreter to use when executing rex actions</span>
<span class="sd">        parent_environ: environment to execute the actions within. If None,</span>
<span class="sd">            defaults to the current environment.</span>
<span class="sd">        parent_variables: List of variables to append/prepend to, rather than</span>
<span class="sd">            overwriting on first reference. If this is set to True instead of a</span>
<span class="sd">            list, all variables are treated as parent variables.</span>
<span class="sd">        formatter: func or None</span>
<span class="sd">            function to use for formatting string values</span>
<span class="sd">        verbose : bool or list of str</span>
<span class="sd">            if True, causes commands to print additional feedback (using info()).</span>
<span class="sd">            can also be set to a list of strings matching command names to add</span>
<span class="sd">            verbosity to only those commands.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interpreter</span> <span class="o">=</span> <span class="n">interpreter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_environ</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="k">if</span> <span class="n">parent_environ</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">parent_environ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_variables</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">parent_variables</span> <span class="ow">is</span> <span class="kc">True</span> \
            <span class="k">else</span> <span class="nb">set</span><span class="p">(</span><span class="n">parent_variables</span> <span class="ow">or</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environ</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formatter</span> <span class="o">=</span> <span class="n">formatter</span> <span class="ow">or</span> <span class="nb">str</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_env_sep_map</span> <span class="o">=</span> <span class="n">env_sep_map</span> <span class="k">if</span> <span class="n">env_sep_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> \
            <span class="k">else</span> <span class="n">config</span><span class="o">.</span><span class="n">env_var_separators</span>

<div class="viewcode-block" id="ActionManager.get_action_methods"><a class="viewcode-back" href="../../api/rez.html#rez.rex.ActionManager.get_action_methods">[docs]</a>    <span class="k">def</span> <span class="nf">get_action_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        return a list of methods on this class for executing actions.</span>
<span class="sd">        methods are return as a list of (name, func) tuples</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[(</span><span class="n">name</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">Action</span><span class="o">.</span><span class="n">get_command_types</span><span class="p">()]</span></div>

<div class="viewcode-block" id="ActionManager.get_public_methods"><a class="viewcode-back" href="../../api/rez.html#rez.rex.ActionManager.get_public_methods">[docs]</a>    <span class="k">def</span> <span class="nf">get_public_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        return a list of methods on this class which should be exposed in the rex</span>
<span class="sd">        API.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_action_methods</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;getenv&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getenv</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;expandvars&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expandvars</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;defined&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defined</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;undefined&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">undefined</span><span class="p">)]</span></div>

    <span class="k">def</span> <span class="nf">_env_sep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env_sep_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpreter</span><span class="o">.</span><span class="n">pathsep</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_is_verbose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">command</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c1"># It would be unexpected to get var expansion on the str repr of an</span>
        <span class="c1"># object, so don&#39;t do that.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">basestring</span><span class="p">,</span> <span class="n">EscapedString</span><span class="p">)):</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="c1"># Perform expansion on non-literal parts of the string. If any</span>
        <span class="c1"># expansion fails, just return unformatted string.</span>
        <span class="c1">#</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">EscapedString</span><span class="o">.</span><span class="n">promote</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">formatted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formatter</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_expand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_fn</span><span class="p">(</span><span class="n">str_</span><span class="p">):</span>
            <span class="n">str_</span> <span class="o">=</span> <span class="n">expandvars</span><span class="p">(</span><span class="n">str_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
            <span class="n">str_</span> <span class="o">=</span> <span class="n">expandvars</span><span class="p">(</span><span class="n">str_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_environ</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">str_</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">EscapedString</span><span class="o">.</span><span class="n">promote</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">formatted</span><span class="p">(</span><span class="n">_fn</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="c1"># returns (unexpanded, expanded) forms of key</span>
        <span class="n">unexpanded_key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="n">expanded_key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_expand</span><span class="p">(</span><span class="n">unexpanded_key</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">unexpanded_key</span><span class="p">,</span> <span class="n">expanded_key</span>

    <span class="k">def</span> <span class="nf">_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c1"># returns (unexpanded, expanded) forms of value</span>
        <span class="n">unexpanded_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">expanded_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand</span><span class="p">(</span><span class="n">unexpanded_value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">unexpanded_value</span><span class="p">,</span> <span class="n">expanded_value</span>

<div class="viewcode-block" id="ActionManager.get_output"><a class="viewcode-back" href="../../api/rez.html#rez.rex.ActionManager.get_output">[docs]</a>    <span class="k">def</span> <span class="nf">get_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">OutputStyle</span><span class="o">.</span><span class="n">file</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpreter</span><span class="o">.</span><span class="n">get_output</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">)</span></div>

    <span class="c1"># -- Commands</span>

<div class="viewcode-block" id="ActionManager.undefined"><a class="viewcode-back" href="../../api/rez.html#rez.rex.ActionManager.undefined">[docs]</a>    <span class="k">def</span> <span class="nf">undefined</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">expanded_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">expanded_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span>
            <span class="ow">and</span> <span class="n">expanded_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_environ</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ActionManager.defined"><a class="viewcode-back" href="../../api/rez.html#rez.rex.ActionManager.defined">[docs]</a>    <span class="k">def</span> <span class="nf">defined</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">undefined</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></div>

<div class="viewcode-block" id="ActionManager.expandvars"><a class="viewcode-back" href="../../api/rez.html#rez.rex.ActionManager.expandvars">[docs]</a>    <span class="k">def</span> <span class="nf">expandvars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">format</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_expand</span><span class="p">(</span><span class="n">value</span><span class="p">))</span></div>

<div class="viewcode-block" id="ActionManager.getenv"><a class="viewcode-back" href="../../api/rez.html#rez.rex.ActionManager.getenv">[docs]</a>    <span class="k">def</span> <span class="nf">getenv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">expanded_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">expanded_key</span><span class="p">]</span> <span class="k">if</span> <span class="n">expanded_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span> \
                <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_environ</span><span class="p">[</span><span class="n">expanded_key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RexUndefinedVariableError</span><span class="p">(</span>
                <span class="s2">&quot;Referenced undefined environment variable: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">expanded_key</span><span class="p">)</span></div>

<div class="viewcode-block" id="ActionManager.setenv"><a class="viewcode-back" href="../../api/rez.html#rez.rex.ActionManager.setenv">[docs]</a>    <span class="k">def</span> <span class="nf">setenv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">unexpanded_key</span><span class="p">,</span> <span class="n">expanded_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">unexpanded_value</span><span class="p">,</span> <span class="n">expanded_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="c1"># TODO: check if value has already been set by another package</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Setenv</span><span class="p">(</span><span class="n">unexpanded_key</span><span class="p">,</span> <span class="n">unexpanded_value</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">expanded_key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">expanded_value</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpreter</span><span class="o">.</span><span class="n">expand_env_vars</span><span class="p">:</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">expanded_key</span><span class="p">,</span> <span class="n">expanded_value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">unexpanded_key</span><span class="p">,</span> <span class="n">unexpanded_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interpreter</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="ActionManager.unsetenv"><a class="viewcode-back" href="../../api/rez.html#rez.rex.ActionManager.unsetenv">[docs]</a>    <span class="k">def</span> <span class="nf">unsetenv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">unexpanded_key</span><span class="p">,</span> <span class="n">expanded_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Unsetenv</span><span class="p">(</span><span class="n">unexpanded_key</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">expanded_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">expanded_key</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpreter</span><span class="o">.</span><span class="n">expand_env_vars</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">expanded_key</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">unexpanded_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interpreter</span><span class="o">.</span><span class="n">unsetenv</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></div>

<div class="viewcode-block" id="ActionManager.resetenv"><a class="viewcode-back" href="../../api/rez.html#rez.rex.ActionManager.resetenv">[docs]</a>    <span class="k">def</span> <span class="nf">resetenv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">friends</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">unexpanded_key</span><span class="p">,</span> <span class="n">expanded_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">unexpanded_value</span><span class="p">,</span> <span class="n">expanded_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="n">action</span> <span class="o">=</span> <span class="n">Resetenv</span><span class="p">(</span><span class="n">unexpanded_key</span><span class="p">,</span> <span class="n">unexpanded_value</span><span class="p">,</span> <span class="n">friends</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">expanded_key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">expanded_value</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpreter</span><span class="o">.</span><span class="n">expand_env_vars</span><span class="p">:</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">expanded_key</span><span class="p">,</span> <span class="n">expanded_value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">unexpanded_key</span><span class="p">,</span> <span class="n">unexpanded_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interpreter</span><span class="o">.</span><span class="n">resetenv</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_pendenv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">interpfunc</span><span class="p">,</span> <span class="n">addfunc</span><span class="p">):</span>
        <span class="n">unexpanded_key</span><span class="p">,</span> <span class="n">expanded_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">unexpanded_value</span><span class="p">,</span> <span class="n">expanded_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="c1"># expose env-vars from parent env if explicitly told to do so</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">expanded_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_variables</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">expanded_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_variables</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">expanded_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">expanded_key</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpreter</span><span class="o">.</span><span class="n">expand_env_vars</span><span class="p">:</span>
                <span class="n">key_</span> <span class="o">=</span> <span class="n">expanded_key</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">key_</span> <span class="o">=</span> <span class="n">unexpanded_key</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interpreter</span><span class="o">.</span><span class="n">_saferefenv</span><span class="p">(</span><span class="n">key_</span><span class="p">)</span>

        <span class="c1"># *pend or setenv depending on whether this is first reference to the var</span>
        <span class="k">if</span> <span class="n">expanded_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="n">env_sep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env_sep</span><span class="p">(</span><span class="n">expanded_key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">action</span><span class="p">(</span><span class="n">unexpanded_key</span><span class="p">,</span> <span class="n">unexpanded_value</span><span class="p">))</span>

            <span class="n">values</span> <span class="o">=</span> <span class="n">addfunc</span><span class="p">(</span><span class="n">unexpanded_value</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_keytoken</span><span class="p">(</span><span class="n">expanded_key</span><span class="p">)])</span>
            <span class="n">unexpanded_values</span> <span class="o">=</span> <span class="n">EscapedString</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">env_sep</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>

            <span class="n">parts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">expanded_key</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">env_sep</span><span class="p">)</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">addfunc</span><span class="p">(</span><span class="n">expanded_value</span><span class="p">,</span> <span class="n">parts</span><span class="p">)</span>
            <span class="n">expanded_values</span> <span class="o">=</span> <span class="n">EscapedString</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">env_sep</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">expanded_key</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">env_sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">addfunc</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">expanded_value</span><span class="p">),</span> <span class="n">parts</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Setenv</span><span class="p">(</span><span class="n">unexpanded_key</span><span class="p">,</span> <span class="n">unexpanded_value</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">expanded_key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">expanded_value</span><span class="p">)</span>
            <span class="n">unexpanded_values</span> <span class="o">=</span> <span class="n">unexpanded_value</span>
            <span class="n">expanded_values</span> <span class="o">=</span> <span class="n">expanded_value</span>
            <span class="n">interpfunc</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">applied</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">interpfunc</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpreter</span><span class="o">.</span><span class="n">expand_env_vars</span><span class="p">:</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">expanded_key</span><span class="p">,</span> <span class="n">expanded_value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">unexpanded_key</span><span class="p">,</span> <span class="n">unexpanded_value</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">interpfunc</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="n">applied</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">applied</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpreter</span><span class="o">.</span><span class="n">expand_env_vars</span><span class="p">:</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">expanded_key</span><span class="p">,</span> <span class="n">expanded_values</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">unexpanded_key</span><span class="p">,</span> <span class="n">unexpanded_values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interpreter</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="ActionManager.prependenv"><a class="viewcode-back" href="../../api/rez.html#rez.rex.ActionManager.prependenv">[docs]</a>    <span class="k">def</span> <span class="nf">prependenv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pendenv</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">Prependenv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpreter</span><span class="o">.</span><span class="n">prependenv</span><span class="p">,</span>
                      <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span></div>

<div class="viewcode-block" id="ActionManager.appendenv"><a class="viewcode-back" href="../../api/rez.html#rez.rex.ActionManager.appendenv">[docs]</a>    <span class="k">def</span> <span class="nf">appendenv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pendenv</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">Appendenv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpreter</span><span class="o">.</span><span class="n">appendenv</span><span class="p">,</span>
                      <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">y</span> <span class="o">+</span> <span class="p">[</span><span class="n">x</span><span class="p">])</span></div>

<div class="viewcode-block" id="ActionManager.alias"><a class="viewcode-back" href="../../api/rez.html#rez.rex.ActionManager.alias">[docs]</a>    <span class="k">def</span> <span class="nf">alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Alias</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interpreter</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="ActionManager.info"><a class="viewcode-back" href="../../api/rez.html#rez.rex.ActionManager.info">[docs]</a>    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Info</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interpreter</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="ActionManager.error"><a class="viewcode-back" href="../../api/rez.html#rez.rex.ActionManager.error">[docs]</a>    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Error</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interpreter</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="ActionManager.stop"><a class="viewcode-back" href="../../api/rez.html#rez.rex.ActionManager.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">nargs</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">rez.exceptions</span> <span class="kn">import</span> <span class="n">RexStopError</span>
        <span class="k">raise</span> <span class="n">RexStopError</span><span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="n">nargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ActionManager.command"><a class="viewcode-back" href="../../api/rez.html#rez.rex.ActionManager.command">[docs]</a>    <span class="k">def</span> <span class="nf">command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c1"># Note: Value is deliberately not formatted in commands</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Command</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interpreter</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="ActionManager.comment"><a class="viewcode-back" href="../../api/rez.html#rez.rex.ActionManager.comment">[docs]</a>    <span class="k">def</span> <span class="nf">comment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Comment</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interpreter</span><span class="o">.</span><span class="n">comment</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="ActionManager.source"><a class="viewcode-back" href="../../api/rez.html#rez.rex.ActionManager.source">[docs]</a>    <span class="k">def</span> <span class="nf">source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_format</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Source</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interpreter</span><span class="o">.</span><span class="n">source</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="ActionManager.shebang"><a class="viewcode-back" href="../../api/rez.html#rez.rex.ActionManager.shebang">[docs]</a>    <span class="k">def</span> <span class="nf">shebang</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Shebang</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interpreter</span><span class="o">.</span><span class="n">shebang</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_keytoken</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpreter</span><span class="o">.</span><span class="n">get_key_token</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></div>


<span class="c1">#===============================================================================</span>
<span class="c1"># Interpreters</span>
<span class="c1">#===============================================================================</span>

<div class="viewcode-block" id="ActionInterpreter"><a class="viewcode-back" href="../../api/rez.html#rez.rex.ActionInterpreter">[docs]</a><span class="k">class</span> <span class="nc">ActionInterpreter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract base class that provides callbacks for rex Actions.  This class</span>
<span class="sd">    should not be used directly. Its methods are called by the</span>
<span class="sd">    `ActionManager` in response to actions issued by user code written using</span>
<span class="sd">    the rex python API.</span>

<span class="sd">    Sub-classes should override the `get_output` method to return</span>
<span class="sd">    implementation-specific data structure.  For example, an interpreter for a</span>
<span class="sd">    shell language like bash would return a string of shell code.  An interpreter</span>
<span class="sd">    for an active python session might return a dictionary of the modified</span>
<span class="sd">    environment.</span>

<span class="sd">    Sub-classes can override the `expand_env_vars` class variable to instruct</span>
<span class="sd">    the `ActionManager` whether or not to expand the value of environment</span>
<span class="sd">    variables which reference other variables (e.g. &quot;this-${THAT}&quot;).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">expand_env_vars</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Path separator. There are cases (eg gitbash - git for windows) where the</span>
    <span class="c1"># path separator does not match the system (ie os.pathsep)</span>
    <span class="c1">#</span>
    <span class="n">pathsep</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span>

    <span class="c1"># RegEx that captures environment variables (generic form).</span>
    <span class="c1"># Extend/override to regex formats that can capture environment formats</span>
    <span class="c1"># in other interpreters like shells if needed</span>
    <span class="n">ENV_VAR_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
            <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">${([^</span><span class="se">\\</span><span class="s2">{</span><span class="se">\\</span><span class="s2">}]+?)}&quot;</span><span class="p">,</span>               <span class="c1"># ${ENVVAR}</span>
            <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">$([a-zA-Z_]+[a-zA-Z0-9_]*?)&quot;</span><span class="p">,</span>    <span class="c1"># $ENVVAR</span>
        <span class="p">])</span>
    <span class="p">)</span>

<div class="viewcode-block" id="ActionInterpreter.get_output"><a class="viewcode-back" href="../../api/rez.html#rez.rex.ActionInterpreter.get_output">[docs]</a>    <span class="k">def</span> <span class="nf">get_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">OutputStyle</span><span class="o">.</span><span class="n">file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns any implementation specific data.</span>

<span class="sd">        Args:</span>
<span class="sd">            style (`OutputStyle`): Style affecting output format.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Depends on implementation, but usually a code string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

    <span class="c1"># --- commands</span>

<div class="viewcode-block" id="ActionInterpreter.setenv"><a class="viewcode-back" href="../../api/rez.html#rez.rex.ActionInterpreter.setenv">[docs]</a>    <span class="k">def</span> <span class="nf">setenv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="ActionInterpreter.unsetenv"><a class="viewcode-back" href="../../api/rez.html#rez.rex.ActionInterpreter.unsetenv">[docs]</a>    <span class="k">def</span> <span class="nf">unsetenv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="ActionInterpreter.resetenv"><a class="viewcode-back" href="../../api/rez.html#rez.rex.ActionInterpreter.resetenv">[docs]</a>    <span class="k">def</span> <span class="nf">resetenv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">friends</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="ActionInterpreter.prependenv"><a class="viewcode-back" href="../../api/rez.html#rez.rex.ActionInterpreter.prependenv">[docs]</a>    <span class="k">def</span> <span class="nf">prependenv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This is optional, but if it is not implemented, you must</span>
<span class="sd">        implement setenv.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="ActionInterpreter.appendenv"><a class="viewcode-back" href="../../api/rez.html#rez.rex.ActionInterpreter.appendenv">[docs]</a>    <span class="k">def</span> <span class="nf">appendenv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This is optional, but if it is not implemented, you must</span>
<span class="sd">        implement setenv.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="ActionInterpreter.alias"><a class="viewcode-back" href="../../api/rez.html#rez.rex.ActionInterpreter.alias">[docs]</a>    <span class="k">def</span> <span class="nf">alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="ActionInterpreter.info"><a class="viewcode-back" href="../../api/rez.html#rez.rex.ActionInterpreter.info">[docs]</a>    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="ActionInterpreter.error"><a class="viewcode-back" href="../../api/rez.html#rez.rex.ActionInterpreter.error">[docs]</a>    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="ActionInterpreter.command"><a class="viewcode-back" href="../../api/rez.html#rez.rex.ActionInterpreter.command">[docs]</a>    <span class="k">def</span> <span class="nf">command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="ActionInterpreter.comment"><a class="viewcode-back" href="../../api/rez.html#rez.rex.ActionInterpreter.comment">[docs]</a>    <span class="k">def</span> <span class="nf">comment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="ActionInterpreter.source"><a class="viewcode-back" href="../../api/rez.html#rez.rex.ActionInterpreter.source">[docs]</a>    <span class="k">def</span> <span class="nf">source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="ActionInterpreter.shebang"><a class="viewcode-back" href="../../api/rez.html#rez.rex.ActionInterpreter.shebang">[docs]</a>    <span class="k">def</span> <span class="nf">shebang</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

    <span class="c1"># --- other</span>

<div class="viewcode-block" id="ActionInterpreter.escape_string"><a class="viewcode-back" href="../../api/rez.html#rez.rex.ActionInterpreter.escape_string">[docs]</a>    <span class="k">def</span> <span class="nf">escape_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">is_path</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Escape a string.</span>

<span class="sd">        Escape the given string so that special characters (such as quotes and</span>
<span class="sd">        whitespace) are treated properly. If `value` is a string, assume that</span>
<span class="sd">        this is an expandable string in this interpreter.</span>

<span class="sd">        Note that `is_path` provided because of the special case where a</span>
<span class="sd">        path-like envvar is set. In this case, path normalization, if it needs</span>
<span class="sd">        to occur, has to be part of the string escaping process.</span>

<span class="sd">        Note:</span>
<span class="sd">            This default implementation returns the string with no escaping</span>
<span class="sd">            applied.</span>

<span class="sd">        Args:</span>
<span class="sd">            value (str or `EscapedString`): String to escape.</span>
<span class="sd">            is_path (bool): True if the value is path-like.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The escaped string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_is_pathed_key</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">pathed_env_vars</span><span class="p">)</span>

<div class="viewcode-block" id="ActionInterpreter.normalize_path"><a class="viewcode-back" href="../../api/rez.html#rez.rex.ActionInterpreter.normalize_path">[docs]</a>    <span class="k">def</span> <span class="nf">normalize_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Normalize a path.</span>

<span class="sd">        Change `path` to a valid filepath representation for this interpreter.</span>

<span class="sd">        IMPORTANT: Because var references like ${THIS} might be passed to funcs</span>
<span class="sd">        like appendvar, `path` might be in this form. You need to take that</span>
<span class="sd">        into account (ie, ensure normalization doesn&#39;t break such a var reference).</span>

<span class="sd">        Args:</span>
<span class="sd">            path (str): A filepath which may be in posix format, or windows</span>
<span class="sd">                format, or some combination of the two. For eg, a string like</span>
<span class="sd">                `{root}/bin` on windows will evaluate to `C:\\.../bin` - in this</span>
<span class="sd">                case, the `cmd` shell would want to normalize this and convert</span>
<span class="sd">                to all forward slashes.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The normalized path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">path</span></div>

<div class="viewcode-block" id="ActionInterpreter.normalize_paths"><a class="viewcode-back" href="../../api/rez.html#rez.rex.ActionInterpreter.normalize_paths">[docs]</a>    <span class="k">def</span> <span class="nf">normalize_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Normalize value if it&#39;s a path(s).</span>

<span class="sd">        Note that `value` may be more than one pathsep-delimited paths.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pathsep</span><span class="p">)</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize_path</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pathsep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span></div>

    <span class="c1"># --- internal commands, not exposed to public rex API</span>

    <span class="k">def</span> <span class="nf">_saferefenv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        make the var safe to reference, even if it does not yet exist. This is</span>
<span class="sd">        needed because of different behaviours in shells - eg, tcsh will fail</span>
<span class="sd">        on ref to undefined var, but sh will expand to the empty string.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="c1"># --- internal functions</span>

    <span class="k">def</span> <span class="nf">_bind_interactive_rez</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        apply changes to the env needed to expose rez in an interactive shell,</span>
<span class="sd">        for eg prompt change, sourcing completion scripts etc. Do NOT add rez</span>
<span class="sd">        to PATH, this is done elsewhere.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<div class="viewcode-block" id="Python"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Python">[docs]</a><span class="k">class</span> <span class="nc">Python</span><span class="p">(</span><span class="n">ActionInterpreter</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Execute commands in the current python session&#39;&#39;&#39;</span>
    <span class="n">expand_env_vars</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_environ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">passive</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        target_environ: dict</span>
<span class="sd">            If target_environ is None or os.environ, interpreted actions are</span>
<span class="sd">            applied to the current python interpreter. Otherwise, changes are</span>
<span class="sd">            only applied to target_environ. In either case you must call</span>
<span class="sd">            `apply_environ` to flush all changes to the target environ dict.</span>

<span class="sd">        passive: bool</span>
<span class="sd">            If True, commands that do not update the environment (such as info)</span>
<span class="sd">            are skipped.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">passive</span> <span class="o">=</span> <span class="n">passive</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">target_environ</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">target_environ</span> <span class="ow">is</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_environ</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_session</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_environ</span> <span class="o">=</span> <span class="n">target_environ</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_session</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="Python.set_manager"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Python.set_manager">[docs]</a>    <span class="k">def</span> <span class="nf">set_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manager</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="n">manager</span></div>

<div class="viewcode-block" id="Python.apply_environ"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Python.apply_environ">[docs]</a>    <span class="k">def</span> <span class="nf">apply_environ</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply changes to target environ.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RezSystemError</span><span class="p">(</span><span class="s2">&quot;You must call &#39;set_manager&#39; on a Python rex &quot;</span>
                                 <span class="s2">&quot;interpreter before using it.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">target_environ</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adjust_env_for_platform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_environ</span><span class="p">)</span></div>

<div class="viewcode-block" id="Python.get_output"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Python.get_output">[docs]</a>    <span class="k">def</span> <span class="nf">get_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">OutputStyle</span><span class="o">.</span><span class="n">file</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_environ</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">environ</span></div>

<div class="viewcode-block" id="Python.setenv"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Python.setenv">[docs]</a>    <span class="k">def</span> <span class="nf">setenv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_session</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;PYTHONPATH&#39;</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">escape_string</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pathsep</span><span class="p">)</span></div>

<div class="viewcode-block" id="Python.unsetenv"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Python.unsetenv">[docs]</a>    <span class="k">def</span> <span class="nf">unsetenv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Python.resetenv"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Python.resetenv">[docs]</a>    <span class="k">def</span> <span class="nf">resetenv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">friends</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Python.prependenv"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Python.prependenv">[docs]</a>    <span class="k">def</span> <span class="nf">prependenv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_session</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;PYTHONPATH&#39;</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">escape_string</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="Python.appendenv"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Python.appendenv">[docs]</a>    <span class="k">def</span> <span class="nf">appendenv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_session</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;PYTHONPATH&#39;</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">escape_string</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="Python.info"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Python.info">[docs]</a>    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">passive</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">escape_string</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="Python.error"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Python.error">[docs]</a>    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">passive</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">escape_string</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span></div>

<div class="viewcode-block" id="Python.subprocess"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Python.subprocess">[docs]</a>    <span class="k">def</span> <span class="nf">subprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">subproc_kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_environ</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adjust_env_for_platform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_environ</span><span class="p">)</span>

        <span class="n">shell_mode</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">basestring</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Popen</span><span class="p">(</span><span class="n">args</span><span class="p">,</span>
                     <span class="n">shell</span><span class="o">=</span><span class="n">shell_mode</span><span class="p">,</span>
                     <span class="n">env</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target_environ</span><span class="p">,</span>
                     <span class="o">**</span><span class="n">subproc_kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Python.command"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Python.command">[docs]</a>    <span class="k">def</span> <span class="nf">command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">passive</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">is_non_string_iterable</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">EscapedString</span><span class="o">.</span><span class="n">disallow</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">))</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmd</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">escape_string</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">it</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">EscapedString</span><span class="o">.</span><span class="n">disallow</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">escape_string</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subprocess</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">shlex_join</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">RexError</span><span class="p">(</span><span class="s1">&#39;Error executing command: </span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span></div>

<div class="viewcode-block" id="Python.comment"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Python.comment">[docs]</a>    <span class="k">def</span> <span class="nf">comment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Python.source"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Python.source">[docs]</a>    <span class="k">def</span> <span class="nf">source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Python.alias"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Python.alias">[docs]</a>    <span class="k">def</span> <span class="nf">alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">pass</span></div>

    <span class="k">def</span> <span class="nf">_bind_interactive_rez</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_saferefenv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="Python.shebang"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Python.shebang">[docs]</a>    <span class="k">def</span> <span class="nf">shebang</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="Python.get_key_token"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Python.get_key_token">[docs]</a>    <span class="k">def</span> <span class="nf">get_key_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="c1"># Not sure if this actually needs to be returned here.  Prior to the</span>
        <span class="c1"># Windows refactor this is the value this interpretter was receiving,</span>
        <span class="c1"># but the concept doesn&#39;t really feel applicable to Python.  It&#39;s just</span>
        <span class="c1"># here because the API requires it.</span>
        <span class="k">return</span> <span class="s2">&quot;${</span><span class="si">%s</span><span class="s2">}&quot;</span> <span class="o">%</span> <span class="n">key</span></div>

<div class="viewcode-block" id="Python.adjust_env_for_platform"><a class="viewcode-back" href="../../api/rez.html#rez.rex.Python.adjust_env_for_platform">[docs]</a>    <span class="k">def</span> <span class="nf">adjust_env_for_platform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Make required platform-specific adjustments to env.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">platform_</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;windows&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_systemroot_to_env_win32</span><span class="p">(</span><span class="n">env</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_add_systemroot_to_env_win32</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot; Sets ``%SYSTEMROOT%`` environment variable, if not present</span>
<span class="sd">        in :py:attr:`target_environ` .</span>

<span class="sd">        Args:</span>
<span class="sd">            env (dict): desired environment variables</span>

<span class="sd">        Notes:</span>
<span class="sd">            on windows, python-3.6 startup fails within an environment</span>
<span class="sd">            where it ``%PATH%`` includes python3, but ``%SYSTEMROOT%`` is not</span>
<span class="sd">            present.</span>

<span class="sd">            for example.</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                from subprocess import Popen</span>
<span class="sd">                cmds = [&#39;python&#39;, &#39;--version&#39;]</span>

<span class="sd">                # successful</span>
<span class="sd">                Popen(cmds)</span>
<span class="sd">                Popen(cmds, env={&#39;PATH&#39;: &#39;C:\\Python-3.6.5&#39;,</span>
<span class="sd">                                 &#39;SYSTEMROOT&#39;: &#39;C:\Windows&#39;})</span>

<span class="sd">                # failure</span>
<span class="sd">                Popen(cmds, env={&#39;PATH&#39;: &#39;C:\\Python-3.6.5&#39;})</span>

<span class="sd">                #&gt; Fatal Python Error: failed to get random numbers to initialize Python</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># &#39;SYSTEMROOT&#39; unecessary unless &#39;PATH&#39; is set.</span>
        <span class="k">if</span> <span class="n">env</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># leave SYSTEMROOT alone if set by user</span>
        <span class="k">if</span> <span class="s1">&#39;SYSTEMROOT&#39;</span> <span class="ow">in</span> <span class="n">env</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># not enough info to set SYSTEMROOT</span>
        <span class="k">if</span> <span class="s1">&#39;SYSTEMROOT&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;SYSTEMROOT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SYSTEMROOT&#39;</span><span class="p">]</span></div>


<span class="c1">#===============================================================================</span>
<span class="c1"># String manipulation</span>
<span class="c1">#===============================================================================</span>

<div class="viewcode-block" id="EscapedString"><a class="viewcode-back" href="../../api/rez.html#rez.rex.EscapedString">[docs]</a><span class="k">class</span> <span class="nc">EscapedString</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class for constructing literal or expandable strings, or a combination</span>
<span class="sd">    of both.</span>

<span class="sd">    This determines how a string is escaped in an interpreter. For example,</span>
<span class="sd">    the following rex commands may result in the bash code shown:</span>

<span class="sd">        &gt;&gt;&gt; env.FOO = literal(&#39;oh &quot;noes&quot;&#39;)</span>
<span class="sd">        &gt;&gt;&gt; env.BAH = expandable(&#39;oh &quot;noes&quot;&#39;)</span>
<span class="sd">        export FOO=&#39;oh &quot;noes&quot;&#39;</span>
<span class="sd">        export BAH=&quot;oh \&quot;noes\&quot;&quot;</span>

<span class="sd">    You do not need to use `expandable` - a string by default is interpreted as</span>
<span class="sd">    expandable. However you can mix literals and expandables together, like so:</span>

<span class="sd">        &gt;&gt;&gt; env.FOO = literal(&quot;hello&quot;).expandable(&quot; ${DUDE}&quot;)</span>
<span class="sd">        export FOO=&#39;hello&#39;&quot; ${DUDE}&quot;</span>

<span class="sd">    Shorthand methods `e` and `l` are also supplied, for better readability:</span>

<span class="sd">        &gt;&gt;&gt; env.FOO = literal(&quot;hello&quot;).e(&quot; ${DUDE}&quot;).l(&quot;, and welcome!&quot;)</span>
<span class="sd">        export FOO=&#39;hello&#39;&quot; ${DUDE}&quot;&#39;, and welcome!&#39;</span>

<span class="sd">    Note:</span>
<span class="sd">        you can use the `literal` and `expandable` free functions, rather than</span>
<span class="sd">        constructing a class instance directly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">is_literal</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strings</span> <span class="o">=</span> <span class="p">[(</span><span class="n">is_literal</span><span class="p">,</span> <span class="n">value</span><span class="p">)]</span>

<div class="viewcode-block" id="EscapedString.copy"><a class="viewcode-back" href="../../api/rez.html#rez.rex.EscapedString.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">EscapedString</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">EscapedString</span><span class="p">)</span>
        <span class="n">other</span><span class="o">.</span><span class="n">strings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strings</span><span class="p">[:]</span>
        <span class="k">return</span> <span class="n">other</span></div>

<div class="viewcode-block" id="EscapedString.literal"><a class="viewcode-back" href="../../api/rez.html#rez.rex.EscapedString.literal">[docs]</a>    <span class="k">def</span> <span class="nf">literal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="EscapedString.expandable"><a class="viewcode-back" href="../../api/rez.html#rez.rex.EscapedString.expandable">[docs]</a>    <span class="k">def</span> <span class="nf">expandable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="EscapedString.l"><a class="viewcode-back" href="../../api/rez.html#rez.rex.EscapedString.l">[docs]</a>    <span class="k">def</span> <span class="nf">l</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>  <span class="c1"># noqa</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="EscapedString.e"><a class="viewcode-back" href="../../api/rez.html#rez.rex.EscapedString.e">[docs]</a>    <span class="k">def</span> <span class="nf">e</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">expandable</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">is_literal</span><span class="p">):</span>
        <span class="n">last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strings</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">last</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">is_literal</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">strings</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">last</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">last</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">strings</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">is_literal</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the string unescaped.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">strings</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%r</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">strings</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">EscapedString</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">strings</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">strings</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span> <span class="o">==</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Join two escaped strings together.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `EscapedString` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">EscapedString</span><span class="o">.</span><span class="n">promote</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">is_literal</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">strings</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">_add</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">is_literal</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

<div class="viewcode-block" id="EscapedString.expanduser"><a class="viewcode-back" href="../../api/rez.html#rez.rex.EscapedString.expanduser">[docs]</a>    <span class="k">def</span> <span class="nf">expanduser</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Analogous to os.path.expanduser.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `EscapedString` object with expanded &#39;~&#39; references.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">)</span></div>

<div class="viewcode-block" id="EscapedString.formatted"><a class="viewcode-back" href="../../api/rez.html#rez.rex.EscapedString.formatted">[docs]</a>    <span class="k">def</span> <span class="nf">formatted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the string with non-literal parts formatted.</span>

<span class="sd">        Args:</span>
<span class="sd">            func (callable): Callable that translates a string into a</span>
<span class="sd">                formatted string.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `EscapedString` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">EscapedString</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">EscapedString</span><span class="p">)</span>
        <span class="n">other</span><span class="o">.</span><span class="n">strings</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">is_literal</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">strings</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_literal</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">other</span><span class="o">.</span><span class="n">strings</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">is_literal</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">other</span></div>

<div class="viewcode-block" id="EscapedString.split"><a class="viewcode-back" href="../../api/rez.html#rez.rex.EscapedString.split">[docs]</a>    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Same as string.split(), but retains literal/expandable structure.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of `EscapedString`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">strings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strings</span><span class="p">[:]</span>
        <span class="n">current</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">while</span> <span class="n">strings</span><span class="p">:</span>
            <span class="n">is_literal</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">strings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">delimiter</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">value1</span><span class="p">,</span> <span class="n">value2</span> <span class="o">=</span> <span class="n">parts</span>
                <span class="n">strings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">is_literal</span><span class="p">,</span> <span class="n">value2</span><span class="p">)</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">EscapedString</span><span class="p">(</span><span class="n">value1</span><span class="p">,</span> <span class="n">is_literal</span><span class="p">)</span>
                <span class="n">push</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">strings</span> <span class="o">=</span> <span class="n">strings</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">EscapedString</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">is_literal</span><span class="p">)</span>
                <span class="n">push</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">current</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">current</span> <span class="o">=</span> <span class="n">out</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">current</span> <span class="o">=</span> <span class="n">current</span> <span class="o">+</span> <span class="n">out</span>
            <span class="k">if</span> <span class="n">push</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
                <span class="n">current</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">current</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="EscapedString.join"><a class="viewcode-back" href="../../api/rez.html#rez.rex.EscapedString.join">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">join</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">values</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">EscapedString</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">EscapedString</span><span class="o">.</span><span class="n">promote</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="o">+</span> <span class="n">sep</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="o">+</span> <span class="n">value</span>

        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="EscapedString.promote"><a class="viewcode-back" href="../../api/rez.html#rez.rex.EscapedString.promote">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">promote</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="EscapedString.demote"><a class="viewcode-back" href="../../api/rez.html#rez.rex.EscapedString.demote">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">demote</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span></div>

<div class="viewcode-block" id="EscapedString.disallow"><a class="viewcode-back" href="../../api/rez.html#rez.rex.EscapedString.disallow">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">disallow</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">RexError</span><span class="p">(</span><span class="s2">&quot;The command does not accept use of &#39;literal&#39; or &#39;expandable&#39;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span></div></div>


<div class="viewcode-block" id="literal"><a class="viewcode-back" href="../../api/rez.html#rez.rex.literal">[docs]</a><span class="k">def</span> <span class="nf">literal</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates a literal string.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">EscapedString</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="expandable"><a class="viewcode-back" href="../../api/rez.html#rez.rex.expandable">[docs]</a><span class="k">def</span> <span class="nf">expandable</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates an expandable string.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">EscapedString</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="optionvars"><a class="viewcode-back" href="../../api/rez.html#rez.rex.optionvars">[docs]</a><span class="k">def</span> <span class="nf">optionvars</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Access arbitrary data from rez config setting &#39;optionvars&#39;.</span>

<span class="sd">    Args:</span>
<span class="sd">        name (str): Name of the optionvar. Use dot notation for values in</span>
<span class="sd">            nested dicts.</span>
<span class="sd">        default (object): Default value if setting is missing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">optionvars</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parts</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">RexError</span><span class="p">(</span>
                <span class="s2">&quot;Optionvar </span><span class="si">%r</span><span class="s2"> is invalid because </span><span class="si">%r</span><span class="s2"> is not a dict&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[:</span><span class="n">i</span><span class="p">]))</span>
            <span class="p">)</span>

        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span>

    <span class="k">return</span> <span class="n">value</span></div>


<span class="c1">#===============================================================================</span>
<span class="c1"># Rex Execution Namespace</span>
<span class="c1">#===============================================================================</span>

<div class="viewcode-block" id="NamespaceFormatter"><a class="viewcode-back" href="../../api/rez.html#rez.rex.NamespaceFormatter">[docs]</a><span class="k">class</span> <span class="nc">NamespaceFormatter</span><span class="p">(</span><span class="n">Formatter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;String formatter that, as well as expanding &#39;{variable}&#39; strings, also</span>
<span class="sd">    protects environment variable references such as ${THIS} so they do not get</span>
<span class="sd">    expanded as though {THIS} is a formatting target. Also, environment variable</span>
<span class="sd">    references such as $THIS are converted to ${THIS}, which gives consistency</span>
<span class="sd">    across shells, and avoids some problems with non-curly-braced variables in</span>
<span class="sd">    some situations.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">namespace</span><span class="p">):</span>
        <span class="n">Formatter</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_namespace</span> <span class="o">=</span> <span class="n">namespace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_namespace</span>

<div class="viewcode-block" id="NamespaceFormatter.format"><a class="viewcode-back" href="../../api/rez.html#rez.rex.NamespaceFormatter.format">[docs]</a>    <span class="k">def</span> <span class="nf">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">format_string</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">escape_envvar</span><span class="p">(</span><span class="n">matchobj</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">matchobj</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">))</span>
            <span class="k">return</span> <span class="s2">&quot;${{</span><span class="si">%s</span><span class="s2">}}&quot;</span> <span class="o">%</span> <span class="n">value</span>

        <span class="n">regex</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;regex&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ActionInterpreter</span><span class="o">.</span><span class="n">ENV_VAR_REGEX</span>

        <span class="n">format_string_</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">escape_envvar</span><span class="p">,</span> <span class="n">format_string</span><span class="p">)</span>

        <span class="c1"># for recursive formatting, where a field has a value we want to expand,</span>
        <span class="c1"># add kwargs to namespace, so format_field can use them...</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">prev_namespace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">prev_namespace</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prev_namespace</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Formatter</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">format_string_</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">prev_namespace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span> <span class="o">=</span> <span class="n">prev_namespace</span></div>

<div class="viewcode-block" id="NamespaceFormatter.format_field"><a class="viewcode-back" href="../../api/rez.html#rez.rex.NamespaceFormatter.format_field">[docs]</a>    <span class="k">def</span> <span class="nf">format_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">format_spec</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">EscapedString</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">formatted</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">format</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">format_spec</span><span class="p">)</span></div>

<div class="viewcode-block" id="NamespaceFormatter.get_value"><a class="viewcode-back" href="../../api/rez.html#rez.rex.NamespaceFormatter.get_value">[docs]</a>    <span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwds</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">key</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Check explicitly passed arguments first</span>
                    <span class="k">return</span> <span class="n">kwds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;zero length field name in format&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Formatter</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwds</span><span class="p">)</span></div></div>


<span class="c1">#===============================================================================</span>
<span class="c1"># Environment Classes</span>
<span class="c1">#===============================================================================</span>

<div class="viewcode-block" id="EnvironmentDict"><a class="viewcode-back" href="../../api/rez.html#rez.rex.EnvironmentDict">[docs]</a><span class="k">class</span> <span class="nc">EnvironmentDict</span><span class="p">(</span><span class="n">DictMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Provides a mapping interface to `EnvironmentVariable` instances,</span>
<span class="sd">    which provide an object-oriented interface for recording environment</span>
<span class="sd">    variable manipulations.</span>

<span class="sd">    `__getitem__` is always guaranteed to return an `EnvironmentVariable`</span>
<span class="sd">    instance: it will not raise a KeyError.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manager</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates an `EnvironmentDict`.</span>

<span class="sd">        Args:</span>
<span class="sd">            override_existing_lists (bool): If True, the first call to append</span>
<span class="sd">                or prepend will override the value in `environ` and effectively</span>
<span class="sd">                act as a setenv operation. If False, pre-existing values will</span>
<span class="sd">                be appended/prepended to as usual.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="n">manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_var_cache</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">EnvironmentVariable</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
                               <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">manager</span><span class="o">.</span><span class="n">parent_environ</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<div class="viewcode-block" id="EnvironmentDict.keys"><a class="viewcode-back" href="../../api/rez.html#rez.rex.EnvironmentDict.keys">[docs]</a>    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_var_cache</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_var_cache</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_var_cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_var_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">EnvironmentVariable</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_var_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_var_cache</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_var_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_var_cache</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">key</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_var_cache</span><span class="p">)</span></div>


<div class="viewcode-block" id="EnvironmentVariable"><a class="viewcode-back" href="../../api/rez.html#rez.rex.EnvironmentVariable">[docs]</a><span class="k">class</span> <span class="nc">EnvironmentVariable</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    class representing an environment variable</span>

<span class="sd">    combined with EnvironmentDict class, records changes to the environment</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">environ_map</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_environ_map</span> <span class="o">=</span> <span class="n">environ_map</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>

<div class="viewcode-block" id="EnvironmentVariable.prepend"><a class="viewcode-back" href="../../api/rez.html#rez.rex.EnvironmentVariable.prepend">[docs]</a>    <span class="k">def</span> <span class="nf">prepend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_environ_map</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">prependenv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="EnvironmentVariable.append"><a class="viewcode-back" href="../../api/rez.html#rez.rex.EnvironmentVariable.append">[docs]</a>    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_environ_map</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">appendenv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="EnvironmentVariable.reset"><a class="viewcode-back" href="../../api/rez.html#rez.rex.EnvironmentVariable.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">friends</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_environ_map</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">resetenv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">friends</span><span class="o">=</span><span class="n">friends</span><span class="p">)</span></div>

<div class="viewcode-block" id="EnvironmentVariable.set"><a class="viewcode-back" href="../../api/rez.html#rez.rex.EnvironmentVariable.set">[docs]</a>    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_environ_map</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="EnvironmentVariable.unset"><a class="viewcode-back" href="../../api/rez.html#rez.rex.EnvironmentVariable.unset">[docs]</a>    <span class="k">def</span> <span class="nf">unset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_environ_map</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">unsetenv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>

    <span class="c1"># --- the following methods all require knowledge of the current environment</span>

<div class="viewcode-block" id="EnvironmentVariable.get"><a class="viewcode-back" href="../../api/rez.html#rez.rex.EnvironmentVariable.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_environ_map</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="EnvironmentVariable.value"><a class="viewcode-back" href="../../api/rez.html#rez.rex.EnvironmentVariable.value">[docs]</a>    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">()</span></div>

<div class="viewcode-block" id="EnvironmentVariable.setdefault"><a class="viewcode-back" href="../../api/rez.html#rez.rex.EnvironmentVariable.setdefault">[docs]</a>    <span class="k">def</span> <span class="nf">setdefault</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;set value if the variable does not yet exist&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">(</span><span class="si">%r</span><span class="s1">, </span><span class="si">%r</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">__nonzero__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">())</span>
        <span class="k">except</span> <span class="n">RexUndefinedVariableError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="fm">__bool__</span> <span class="o">=</span> <span class="n">__nonzero__</span>  <span class="c1"># py3 compat</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">EnvironmentVariable</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="o">==</span> <span class="n">value</span>

    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span> <span class="o">==</span> <span class="n">value</span></div>


<span class="c1">#===============================================================================</span>
<span class="c1"># Executors</span>
<span class="c1">#===============================================================================</span>

<div class="viewcode-block" id="RexExecutor"><a class="viewcode-back" href="../../api/rez.html#rez.rex.RexExecutor">[docs]</a><span class="k">class</span> <span class="nc">RexExecutor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs an interpreter over code within the given namespace. You can also access</span>
<span class="sd">    namespaces and rex functions directly in the executor, like so:</span>

<span class="sd">    RexExecutor ex()</span>
<span class="sd">    ex.setenv(&#39;FOO&#39;, &#39;BAH&#39;)</span>
<span class="sd">    ex.env.FOO_SET = 1</span>
<span class="sd">    ex.alias(&#39;foo&#39;,&#39;foo -l&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interpreter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">globals_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent_environ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">parent_variables</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shebang</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_default_namespaces</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        interpreter: `ActionInterpreter` or None</span>
<span class="sd">            the interpreter to use when executing rex actions. If None, creates</span>
<span class="sd">            a python interpreter with an empty target environment dict.</span>
<span class="sd">        globals_map : dict or None</span>
<span class="sd">            dictionary which comprises the main python namespace when rex code</span>
<span class="sd">            is executed (via the python `exec` statement). if None, defaults</span>
<span class="sd">            to empty dict.</span>
<span class="sd">        parent_environ: environment to execute the rex code within. If None, defaults</span>
<span class="sd">            to the current environment.</span>
<span class="sd">        parent_variables: List of variables to append/prepend to, rather than</span>
<span class="sd">            overwriting on first reference. If this is set to True instead of a</span>
<span class="sd">            list, all variables are treated as parent variables.</span>
<span class="sd">        shebang: bool</span>
<span class="sd">            if True, apply a shebang to the result.</span>
<span class="sd">        add_default_namespaces: bool</span>
<span class="sd">            whether to add default namespaces such as &#39;system&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">globals</span> <span class="o">=</span> <span class="n">globals_map</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formatter</span> <span class="o">=</span> <span class="n">NamespaceFormatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">globals</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s1">&#39;format&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s1">&#39;literal&#39;</span><span class="p">,</span> <span class="n">literal</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s1">&#39;expandable&#39;</span><span class="p">,</span> <span class="n">expandable</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s1">&#39;optionvars&#39;</span><span class="p">,</span> <span class="n">optionvars</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">interpreter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">interpreter</span> <span class="o">=</span> <span class="n">Python</span><span class="p">(</span><span class="n">target_environ</span><span class="o">=</span><span class="p">{})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="n">ActionManager</span><span class="p">(</span><span class="n">interpreter</span><span class="p">,</span>
                                     <span class="n">formatter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">expand</span><span class="p">,</span>
                                     <span class="n">parent_environ</span><span class="o">=</span><span class="n">parent_environ</span><span class="p">,</span>
                                     <span class="n">parent_variables</span><span class="o">=</span><span class="n">parent_variables</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">interpreter</span><span class="p">,</span> <span class="n">Python</span><span class="p">):</span>
            <span class="n">interpreter</span><span class="o">.</span><span class="n">set_manager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">shebang</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">shebang</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">environ</span> <span class="o">=</span> <span class="n">EnvironmentDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s1">&#39;env&#39;</span><span class="p">,</span> <span class="n">AttrDictWrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">get_public_methods</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">add_default_namespaces</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s1">&#39;system&#39;</span><span class="p">,</span> <span class="n">system</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">interpreter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">interpreter</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">actions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of Action objects that will be executed.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">actions</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Allows for access such as: self.setenv(&#39;FOO&#39;,&#39;bah&#39;).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">globals</span> \
            <span class="k">else</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">super</span><span class="p">(</span><span class="n">RexExecutor</span><span class="p">,</span> <span class="bp">self</span><span class="p">),</span> <span class="n">attr</span><span class="p">)</span>

<div class="viewcode-block" id="RexExecutor.bind"><a class="viewcode-back" href="../../api/rez.html#rez.rex.RexExecutor.bind">[docs]</a>    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Binds an object to the execution context.</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str) Variable name to bind to.</span>
<span class="sd">            obj (object): Object to bind.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span></div>

<div class="viewcode-block" id="RexExecutor.unbind"><a class="viewcode-back" href="../../api/rez.html#rez.rex.RexExecutor.unbind">[docs]</a>    <span class="k">def</span> <span class="nf">unbind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Unbind an object from the execution context.</span>

<span class="sd">        Has no effect if the binding does not exist.</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str) Variable name to bind to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">globals</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="RexExecutor.reset_globals"><a class="viewcode-back" href="../../api/rez.html#rez.rex.RexExecutor.reset_globals">[docs]</a>    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">reset_globals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove changes to globals dict post-context.</span>

<span class="sd">        Any bindings (self.bind) will only be visible during this context.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># we want to execute the code using self.globals - if for no other</span>
        <span class="c1"># reason that self.formatter is pointing at self.globals, so if we</span>
        <span class="c1"># passed in a copy, we would also need to make self.formatter &quot;look&quot; at</span>
        <span class="c1"># the same copy - but we don&#39;t want to &quot;pollute&quot; our namespace, because</span>
        <span class="c1"># the same executor may be used to run multiple packages. Therefore,</span>
        <span class="c1"># we save a copy of self.globals before execution, and restore it after</span>
        <span class="c1">#</span>
        <span class="n">saved_globals</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">globals</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">globals</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">globals</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">saved_globals</span><span class="p">)</span></div>

<div class="viewcode-block" id="RexExecutor.append_system_paths"><a class="viewcode-back" href="../../api/rez.html#rez.rex.RexExecutor.append_system_paths">[docs]</a>    <span class="k">def</span> <span class="nf">append_system_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Append system paths to $PATH.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">rez.shells</span> <span class="kn">import</span> <span class="n">Shell</span><span class="p">,</span> <span class="n">create_shell</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interpreter</span><span class="p">,</span> <span class="n">Shell</span><span class="p">):</span>
            <span class="n">sh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpreter</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sh</span> <span class="o">=</span> <span class="n">create_shell</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">sh</span><span class="o">.</span><span class="n">get_syspaths</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>

<div class="viewcode-block" id="RexExecutor.prepend_rez_path"><a class="viewcode-back" href="../../api/rez.html#rez.rex.RexExecutor.prepend_rez_path">[docs]</a>    <span class="k">def</span> <span class="nf">prepend_rez_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prepend rez path to $PATH.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">system</span><span class="o">.</span><span class="n">rez_bin_path</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">prepend</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">rez_bin_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="RexExecutor.append_rez_path"><a class="viewcode-back" href="../../api/rez.html#rez.rex.RexExecutor.append_rez_path">[docs]</a>    <span class="k">def</span> <span class="nf">append_rez_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Append rez path to $PATH.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">system</span><span class="o">.</span><span class="n">rez_bin_path</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">rez_bin_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="RexExecutor.normalize_path"><a class="viewcode-back" href="../../api/rez.html#rez.rex.RexExecutor.normalize_path">[docs]</a>    <span class="k">def</span> <span class="nf">normalize_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Normalize a path.</span>

<span class="sd">        Note that in many interpreters this will be unchanged.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The normalized path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpreter</span><span class="o">.</span><span class="n">normalize_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>

<div class="viewcode-block" id="RexExecutor.compile_code"><a class="viewcode-back" href="../../api/rez.html#rez.rex.RexExecutor.compile_code">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">compile_code</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exec_namespace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compile and possibly execute rex code.</span>

<span class="sd">        Args:</span>
<span class="sd">            code (str or SourceCode): The python code to compile.</span>
<span class="sd">            filename (str): File to associate with the code, will default to</span>
<span class="sd">                &#39;&lt;string&gt;&#39;.</span>
<span class="sd">            exec_namespace (dict): Namespace to execute the code in. If None,</span>
<span class="sd">                the code is not executed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Compiled code object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">SourceCode</span><span class="p">):</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">sourcename</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;&lt;string&gt;&quot;</span>

        <span class="c1"># compile</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">SourceCode</span><span class="p">):</span>
                <span class="n">pyc</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">compiled</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pyc</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">SourceCodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">reraise</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">RexError</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">stack</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">RexError</span><span class="p">(</span><span class="s2">&quot;Failed to compile </span><span class="si">%s</span><span class="s2">:</span><span class="se">\n\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">stack</span><span class="p">))</span>

        <span class="n">exc_type</span> <span class="o">=</span> <span class="ne">Exception</span> <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">catch_rex_errors</span> <span class="k">else</span> <span class="n">_NeverError</span>

        <span class="c1"># execute</span>
        <span class="k">if</span> <span class="n">exec_namespace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">SourceCode</span><span class="p">):</span>
                    <span class="n">code</span><span class="o">.</span><span class="n">exec_</span><span class="p">(</span><span class="n">globals_</span><span class="o">=</span><span class="n">exec_namespace</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">exec</span><span class="p">(</span><span class="n">pyc</span><span class="p">,</span> <span class="n">exec_namespace</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">RexError</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="n">SourceCodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">reraise</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">RexError</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">exc_type</span><span class="p">:</span>
                <span class="n">stack</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="k">raise</span> <span class="n">RexError</span><span class="p">(</span><span class="s2">&quot;Failed to exec </span><span class="si">%s</span><span class="s2">:</span><span class="se">\n\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">stack</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">pyc</span></div>

<div class="viewcode-block" id="RexExecutor.execute_code"><a class="viewcode-back" href="../../api/rez.html#rez.rex.RexExecutor.execute_code">[docs]</a>    <span class="k">def</span> <span class="nf">execute_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">isolate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute code within the execution context.</span>

<span class="sd">        Args:</span>
<span class="sd">            code (str or SourceCode): Rex code to execute.</span>
<span class="sd">            filename (str): Filename to report if there are syntax errors.</span>
<span class="sd">            isolate (bool): If True, do not affect `self.globals` by executing</span>
<span class="sd">                this code. DEPRECATED - use `self.reset_globals` instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">_apply</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compile_code</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">,</span>
                              <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
                              <span class="n">exec_namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">globals</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">isolate</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_globals</span><span class="p">():</span>
                <span class="n">_apply</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_apply</span><span class="p">()</span></div>

<div class="viewcode-block" id="RexExecutor.execute_function"><a class="viewcode-back" href="../../api/rez.html#rez.rex.RexExecutor.execute_function">[docs]</a>    <span class="k">def</span> <span class="nf">execute_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">nargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute a function object within the execution context.</span>
<span class="sd">        @returns The result of the function call.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># makes a copy of the func</span>
        <span class="kn">import</span> <span class="nn">types</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__code__</span><span class="p">,</span>
                                <span class="n">func</span><span class="o">.</span><span class="vm">__globals__</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                                <span class="n">name</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                <span class="n">argdefs</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="vm">__defaults__</span><span class="p">,</span>
                                <span class="n">closure</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="vm">__closure__</span><span class="p">)</span>
        <span class="n">fn</span><span class="o">.</span><span class="vm">__globals__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">globals</span><span class="p">)</span>

        <span class="n">exc_type</span> <span class="o">=</span> <span class="ne">Exception</span> <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">catch_rex_errors</span> <span class="k">else</span> <span class="n">_NeverError</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">nargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">RexError</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="n">exc_type</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">getfile</span>

            <span class="n">stack</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">getfile</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

            <span class="k">raise</span> <span class="n">RexError</span><span class="p">(</span><span class="s2">&quot;Failed to exec </span><span class="si">%s</span><span class="s2">:</span><span class="se">\n\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">stack</span><span class="p">))</span></div>

<div class="viewcode-block" id="RexExecutor.get_output"><a class="viewcode-back" href="../../api/rez.html#rez.rex.RexExecutor.get_output">[docs]</a>    <span class="k">def</span> <span class="nf">get_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">OutputStyle</span><span class="o">.</span><span class="n">file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the result of all previous calls to execute_code.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">get_output</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">)</span></div>

<div class="viewcode-block" id="RexExecutor.expand"><a class="viewcode-back" href="../../api/rez.html#rez.rex.RexExecutor.expand">[docs]</a>    <span class="k">def</span> <span class="nf">expand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatter</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">regex</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interpreter</span><span class="o">.</span><span class="n">ENV_VAR_REGEX</span><span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2014, Allan Johns.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>