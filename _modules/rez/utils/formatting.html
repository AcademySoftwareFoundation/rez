<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>rez.utils.formatting &mdash; Rez 2.112.0 documentation</title><link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> Rez
          </a>
              <div class="version">
                2.112
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/modules.html">1. API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../one-liners.html">2. One-Liners</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Rez</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">rez.utils.formatting</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for rez.utils.formatting</h1><div class="highlight"><pre>
<span></span><span class="c1"># SPDX-License-Identifier: Apache-2.0</span>
<span class="c1"># Copyright Contributors to the Rez Project</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Utilities related to formatting output or translating input.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>

<span class="kn">from</span> <span class="nn">string</span> <span class="kn">import</span> <span class="n">Formatter</span>
<span class="kn">from</span> <span class="nn">rez.vendor.enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">rez.vendor.version.requirement</span> <span class="kn">import</span> <span class="n">Requirement</span>
<span class="kn">from</span> <span class="nn">rez.exceptions</span> <span class="kn">import</span> <span class="n">PackageRequestError</span>
<span class="kn">from</span> <span class="nn">rez.vendor.six</span> <span class="kn">import</span> <span class="n">six</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pformat</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>


<span class="n">PACKAGE_NAME_REGSTR</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;[a-zA-Z_0-9](\.?[a-zA-Z0-9_]+)*&quot;</span>
<span class="n">PACKAGE_NAME_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^</span><span class="si">%s</span><span class="s2">\Z&quot;</span> <span class="o">%</span> <span class="n">PACKAGE_NAME_REGSTR</span><span class="p">)</span>

<span class="n">ENV_VAR_REGSTR</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;\$(\w+|\{[^}]*\})&#39;</span>
<span class="n">ENV_VAR_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">ENV_VAR_REGSTR</span><span class="p">)</span>

<span class="n">FORMAT_VAR_REGSTR</span> <span class="o">=</span> <span class="s2">&quot;{(?P&lt;var&gt;.+?)}&quot;</span>
<span class="n">FORMAT_VAR_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">FORMAT_VAR_REGSTR</span><span class="p">)</span>

<span class="c1"># package names that are invalid because they may clash with reserved dir</span>
<span class="c1"># names in some package repos (eg filesystem)</span>
<span class="c1">#</span>
<span class="n">invalid_package_names</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;__pycache__&quot;</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">is_valid_package_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">raise_error</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test the validity of a package name string.</span>

<span class="sd">    Args:</span>
<span class="sd">        name (str): Name to test.</span>
<span class="sd">        raise_error (bool): If True, raise an exception on failure</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">is_valid</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">PACKAGE_NAME_REGEX</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">invalid_package_names</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">raise_error</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_valid</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">PackageRequestError</span><span class="p">(</span><span class="s2">&quot;Not a valid package name: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">is_valid</span>


<span class="k">class</span> <span class="nc">PackageRequest</span><span class="p">(</span><span class="n">Requirement</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A package request parser.</span>

<span class="sd">    Valid requests include:</span>

<span class="sd">    * Any standard request, eg &#39;foo-1.2.3&#39;, &#39;!foo-1&#39;, etc</span>
<span class="sd">    * &quot;Ephemeral&quot; request, eg &#39;.foo-1.2.3&#39;</span>

<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; pr = PackageRequest(&quot;foo-1.3+&quot;)</span>
<span class="sd">        &gt;&gt;&gt; print(pr.name, pr.range)</span>
<span class="sd">        foo 1.3+</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PackageRequest</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="c1"># detect ephemeral package</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ephemeral</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">is_valid_package_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ephemeral</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">is_valid_package_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">StringFormatType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Behaviour of key expansion when using `ObjectStringFormatter`.&quot;&quot;&quot;</span>
    <span class="n">error</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># raise exception on unknown key</span>
    <span class="n">empty</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># expand to empty on unknown key</span>
    <span class="n">unchanged</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># leave string unchanged on unknown key</span>


<span class="k">class</span> <span class="nc">ObjectStringFormatter</span><span class="p">(</span><span class="n">Formatter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;String formatter for objects.</span>

<span class="sd">    This formatter will expand any reference to an object&#39;s attributes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">StringFormatType</span><span class="o">.</span><span class="n">error</span>
    <span class="n">empty</span> <span class="o">=</span> <span class="n">StringFormatType</span><span class="o">.</span><span class="n">empty</span>
    <span class="n">unchanged</span> <span class="o">=</span> <span class="n">StringFormatType</span><span class="o">.</span><span class="n">unchanged</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">pretty</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="n">StringFormatType</span><span class="o">.</span><span class="n">error</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a formatter.</span>

<span class="sd">        Args:</span>
<span class="sd">            instance: The object to format with.</span>
<span class="sd">            pretty: If True, references to non-string attributes such as lists</span>
<span class="sd">                are converted to basic form, with characters such as brackets</span>
<span class="sd">                and parentheses removed.</span>
<span class="sd">            expand: `StringFormatType`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instance</span> <span class="o">=</span> <span class="n">instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pretty</span> <span class="o">=</span> <span class="n">pretty</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expand</span> <span class="o">=</span> <span class="n">expand</span>

    <span class="k">def</span> <span class="nf">convert_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">conversion</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pretty</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;&#39;</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">def</span> <span class="nf">_str</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">six</span><span class="o">.</span><span class="n">PY2</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">unicode</span><span class="p">):</span>
                            <span class="k">return</span> <span class="n">x</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

                <span class="k">return</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">_str</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">Formatter</span><span class="o">.</span><span class="n">convert_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">conversion</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand</span> <span class="o">==</span> <span class="n">StringFormatType</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Formatter</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Formatter</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="n">reg</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^\.\[]+&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">reg</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">field_name</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand</span> <span class="o">==</span> <span class="n">StringFormatType</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># StringFormatType.unchanged</span>
                <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;{</span><span class="si">%s</span><span class="s2">}&quot;</span> <span class="o">%</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwds</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">key</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Check explicitly passed arguments first</span>
                    <span class="k">return</span> <span class="n">kwds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">pass</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># we deliberately do not call hasattr() first - hasattr()</span>
                    <span class="c1"># silently catches exceptions from properties.</span>
                    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">pass</span>

                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;zero length field name in format&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Formatter</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwds</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">StringFormatMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Turn any object into a string formatter.</span>

<span class="sd">    An object inheriting this mixin will have a `format` function added, that is</span>
<span class="sd">    able to format using attributes of the object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">format_expand</span> <span class="o">=</span> <span class="n">StringFormatType</span><span class="o">.</span><span class="n">error</span>
    <span class="n">format_pretty</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">pretty</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Format a string.</span>

<span class="sd">        Args:</span>
<span class="sd">            s (str): String to format, eg &quot;hello {name}&quot;</span>
<span class="sd">            pretty (bool): If True, references to non-string attributes such as</span>
<span class="sd">                lists are converted to basic form, with characters such as</span>
<span class="sd">                brackets and parenthesis removed. If None, defaults to the</span>
<span class="sd">                object&#39;s &#39;format_pretty&#39; attribute.</span>
<span class="sd">            expand (`StringFormatType`): Expansion mode. If None, will default</span>
<span class="sd">                to the object&#39;s &#39;format_expand&#39; attribute.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The formatting string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pretty</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pretty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_pretty</span>
        <span class="k">if</span> <span class="n">expand</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">expand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_expand</span>

        <span class="n">formatter</span> <span class="o">=</span> <span class="n">ObjectStringFormatter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pretty</span><span class="o">=</span><span class="n">pretty</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="n">expand</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">formatter</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">expand_abbreviations</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Expand abbreviations in a format string.</span>

<span class="sd">    If an abbreviation does not match a field, or matches multiple fields, it</span>
<span class="sd">    is left unchanged.</span>

<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; fields = (&quot;hey&quot;, &quot;there&quot;, &quot;dude&quot;)</span>
<span class="sd">        &gt;&gt;&gt; expand_abbreviations(&quot;hello {d}&quot;, fields)</span>
<span class="sd">        &#39;hello dude&#39;</span>

<span class="sd">    Args:</span>
<span class="sd">        txt (str): Format string.</span>
<span class="sd">        fields (list of str): Fields to expand to.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Expanded string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_expand</span><span class="p">(</span><span class="n">matchobj</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">matchobj</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;var&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fields</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">s</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="s2">&quot;{</span><span class="si">%s</span><span class="s2">}&quot;</span> <span class="o">%</span> <span class="n">s</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">FORMAT_VAR_REGEX</span><span class="p">,</span> <span class="n">_expand</span><span class="p">,</span> <span class="n">txt</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">expandvars</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">environ</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Expand shell variables of form $var and ${var}.</span>

<span class="sd">    Unknown variables are left unchanged.</span>

<span class="sd">    Args:</span>
<span class="sd">        text (str): String to expand.</span>
<span class="sd">        environ (dict): Environ dict to use for expansions, defaults to</span>
<span class="sd">            os.environ.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The expanded string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;$&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">text</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">environ</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">environ</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">ENV_VAR_REGEX</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">span</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">environ</span><span class="p">:</span>
            <span class="n">tail</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">j</span><span class="p">:]</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">environ</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="n">tail</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">j</span>
    <span class="k">return</span> <span class="n">text</span>


<span class="k">def</span> <span class="nf">indent</span><span class="p">(</span><span class="n">txt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Indent the given text by 4 spaces.&quot;&quot;&quot;</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;    &quot;</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">txt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">dict_to_attributes_code</span><span class="p">(</span><span class="n">dict_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given a nested dict, generate a python code equivalent.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; d = {&#39;foo&#39;: &#39;bah&#39;, &#39;colors&#39;: {&#39;red&#39;: 1, &#39;blue&#39;: 2}}</span>
<span class="sd">        &gt;&gt;&gt; print(dict_to_attributes_code(d))</span>
<span class="sd">        foo = &#39;bah&#39;</span>
<span class="sd">        colors.red = 1</span>
<span class="sd">        colors.blue = 2</span>

<span class="sd">    Returns:</span>
<span class="sd">        str.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dict_</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="n">dict_to_attributes_code</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">lines_</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines_</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">):</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value_txt</span> <span class="o">=</span> <span class="n">pformat</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">value_txt</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = </span><span class="se">\\</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
                <span class="n">value_txt</span> <span class="o">=</span> <span class="n">indent</span><span class="p">(</span><span class="n">value_txt</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">value_txt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value_txt</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">columnise</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Print rows of entries in aligned columns.&quot;&quot;&quot;</span>
    <span class="n">strs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">maxwidths</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
            <span class="n">se</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">nse</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">se</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">maxwidths</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nse</span> <span class="o">&gt;</span> <span class="n">w</span><span class="p">:</span>
                <span class="n">maxwidths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nse</span>

    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
            <span class="n">se</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">maxwidths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">padding</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">se</span><span class="p">)</span>
                <span class="n">se</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">n</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="n">se</span>
        <span class="n">strs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">strs</span>


<span class="k">def</span> <span class="nf">print_colored_columns</span><span class="p">(</span><span class="n">printer</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Like `columnise`, but with colored rows.</span>

<span class="sd">    Args:</span>
<span class="sd">        printer (`colorize.Printer`): Printer object.</span>

<span class="sd">    Note:</span>
<span class="sd">        The last entry in each row is the row color, or None for no coloring.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rows_</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">colors</span><span class="p">,</span> <span class="n">columnise</span><span class="p">(</span><span class="n">rows_</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="n">padding</span><span class="p">)):</span>
        <span class="n">printer</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>


<span class="n">time_divs</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="mi">365</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">,</span> <span class="s2">&quot;years&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">30</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">,</span> <span class="s2">&quot;months&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">7</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">,</span> <span class="s2">&quot;weeks&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">,</span> <span class="s2">&quot;days&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">3600</span><span class="p">,</span> <span class="s2">&quot;hours&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="s2">&quot;minutes&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;seconds&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">readable_time_duration</span><span class="p">(</span><span class="n">secs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert number of seconds into human readable form, eg &#39;3.2 hours&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_readable_units</span><span class="p">(</span><span class="n">secs</span><span class="p">,</span> <span class="n">time_divs</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>


<span class="n">memory_divs</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="s2">&quot;Tb&quot;</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="s2">&quot;Gb&quot;</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="s2">&quot;Mb&quot;</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="s2">&quot;Kb&quot;</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;bytes&quot;</span><span class="p">,</span> <span class="mi">1024</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">readable_memory_size</span><span class="p">(</span><span class="n">bytes_</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert number of bytes into human readable form, eg &#39;1.2 Kb&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_readable_units</span><span class="p">(</span><span class="n">bytes_</span><span class="p">,</span> <span class="n">memory_divs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_readable_units</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">divs</span><span class="p">,</span> <span class="n">plural_aware</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">unit</span> <span class="o">=</span> <span class="n">divs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="s2">&quot;0 </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">unit</span>
    <span class="n">neg</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">neg</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">value</span>

    <span class="k">for</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">threshold</span> <span class="ow">in</span> <span class="n">divs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;=</span> <span class="n">quantity</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">value</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span>
            <span class="n">rounding</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="n">threshold</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">rounding</span><span class="p">)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="mf">10.0</span>
            <span class="k">if</span> <span class="n">plural_aware</span> <span class="ow">and</span> <span class="n">f</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="n">unit</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%g</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="n">neg</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">txt</span>
    <span class="k">return</span> <span class="n">txt</span>


<span class="k">def</span> <span class="nf">get_epoch_time_from_str</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a string into epoch time. Examples of valid strings:</span>

<span class="sd">        1418350671  # already epoch time</span>
<span class="sd">        -12s        # 12 seconds ago</span>
<span class="sd">        -5.4m       # 5.4 minutes ago</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">):</span>
            <span class="n">chars</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;d&#39;</span><span class="p">:</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span>
                     <span class="s1">&#39;h&#39;</span><span class="p">:</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span>
                     <span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
                     <span class="s1">&#39;s&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">chars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">secs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span>
                <span class="n">now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
                <span class="k">return</span> <span class="nb">max</span><span class="p">((</span><span class="n">now</span> <span class="o">-</span> <span class="n">secs</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; is an unrecognised time format.&quot;</span> <span class="o">%</span> <span class="n">s</span><span class="p">)</span>


<span class="n">positional_suffix</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;th&quot;</span><span class="p">,</span> <span class="s2">&quot;st&quot;</span><span class="p">,</span> <span class="s2">&quot;nd&quot;</span><span class="p">,</span> <span class="s2">&quot;rd&quot;</span><span class="p">,</span> <span class="s2">&quot;th&quot;</span><span class="p">,</span> <span class="s2">&quot;th&quot;</span><span class="p">,</span> <span class="s2">&quot;th&quot;</span><span class="p">,</span> <span class="s2">&quot;th&quot;</span><span class="p">,</span> <span class="s2">&quot;th&quot;</span><span class="p">,</span> <span class="s2">&quot;th&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">positional_number_string</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Print the position string equivalent of a positive integer. Examples:</span>

<span class="sd">        0: zeroeth</span>
<span class="sd">        1: first</span>
<span class="sd">        2: second</span>
<span class="sd">        14: 14th</span>
<span class="sd">        21: 21st</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="n">positional_suffix</span><span class="p">[</span><span class="n">n</span> <span class="o">%</span> <span class="mi">10</span><span class="p">]</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%d%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">suffix</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">th&quot;</span> <span class="o">%</span> <span class="n">n</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;third&quot;</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;second&quot;</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;first&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;zeroeth&quot;</span>


<span class="c1"># regex used to expand user; set here to avoid recompile on every call</span>
<span class="n">EXPANDUSER_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="sa">r</span><span class="s1">&#39;(\A|\s|[</span><span class="si">{pathseps}</span><span class="s1">])~([</span><span class="si">{seps}</span><span class="s1">]|[</span><span class="si">{pathseps}</span><span class="s1">]|\s|\Z)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">seps</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s1">&#39;altsep&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)]))),</span>
        <span class="n">pathseps</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">pathsep</span> <span class="o">+</span> <span class="s1">&#39;;&#39;</span><span class="p">])))</span>
    <span class="p">)</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">expanduser</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Expand &#39;~&#39; to home directory in the given string.</span>

<span class="sd">    Note that this function deliberately differs from the builtin</span>
<span class="sd">    os.path.expanduser() on Linux systems, which expands strings such as</span>
<span class="sd">    &#39;~sclaus&#39; to that user&#39;s homedir. This is problematic in rez because the</span>
<span class="sd">    string &#39;~packagename&#39; may inadvertently convert to a homedir, if a package</span>
<span class="sd">    happens to match a username.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;~&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">path</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;nt&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;HOME&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="n">userhome</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HOME&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s1">&#39;USERPROFILE&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="n">userhome</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;USERPROFILE&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s1">&#39;HOMEPATH&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="n">drive</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HOMEDRIVE&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">userhome</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HOMEPATH&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">path</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">userhome</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_expanduser</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">EXPANDUSER_RE</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">userhome</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">path</span><span class="p">)</span>

    <span class="c1"># only replace &#39;~&#39; if it&#39;s at start of string or is preceeded by pathsep or</span>
    <span class="c1"># &#39;;&#39; or whitespace; AND, is followed either by sep, pathsep, &#39;;&#39;, &#39; &#39; or</span>
    <span class="c1"># end-of-string.</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">_expanduser</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">as_block_string</span><span class="p">(</span><span class="n">txt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a string formatted as a python block comment string, like the one</span>
<span class="sd">    you&#39;re currently reading. Special characters are escaped if necessary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">json</span>

    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">txt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
        <span class="n">line_</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">line_</span> <span class="o">=</span> <span class="n">line_</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>  <span class="c1"># drop double quotes</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line_</span><span class="p">)</span>

    <span class="k">return</span> <span class="s1">&#39;&quot;&quot;&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&quot;&quot;&quot;&#39;</span> <span class="o">%</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>


<span class="n">_header_br</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span> <span class="o">*</span> <span class="mi">80</span>
<span class="n">_header_br_minor</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">80</span>


<span class="k">def</span> <span class="nf">header_comment</span><span class="p">(</span><span class="n">executor</span><span class="p">,</span> <span class="n">txt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convenience for creating header-like comment in a rex executor.</span>

<span class="sd">    Args:</span>
<span class="sd">        executor (`RexExecutor`): Executor.</span>
<span class="sd">        txt (str): Comment text.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">executor</span><span class="o">.</span><span class="n">comment</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">executor</span><span class="o">.</span><span class="n">comment</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">executor</span><span class="o">.</span><span class="n">comment</span><span class="p">(</span><span class="n">_header_br</span><span class="p">)</span>
    <span class="n">executor</span><span class="o">.</span><span class="n">comment</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
    <span class="n">executor</span><span class="o">.</span><span class="n">comment</span><span class="p">(</span><span class="n">_header_br</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">minor_header_comment</span><span class="p">(</span><span class="n">executor</span><span class="p">,</span> <span class="n">txt</span><span class="p">):</span>
    <span class="n">executor</span><span class="o">.</span><span class="n">comment</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">executor</span><span class="o">.</span><span class="n">comment</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
    <span class="n">executor</span><span class="o">.</span><span class="n">comment</span><span class="p">(</span><span class="n">_header_br_minor</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2014, Allan Johns.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>