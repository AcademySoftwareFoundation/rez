<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>rez.resolved_context &mdash; Rez 2.112.0 documentation</title><link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> Rez
          </a>
              <div class="version">
                2.112
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/modules.html">1. API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../one-liners.html">2. One-Liners</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Rez</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">rez.resolved_context</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for rez.resolved_context</h1><div class="highlight"><pre>
<span></span><span class="c1"># SPDX-License-Identifier: Apache-2.0</span>
<span class="c1"># Copyright Contributors to the Rez Project</span>


<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">from</span> <span class="nn">rez</span> <span class="kn">import</span> <span class="n">__version__</span><span class="p">,</span> <span class="n">module_root_path</span>
<span class="kn">from</span> <span class="nn">rez.package_repository</span> <span class="kn">import</span> <span class="n">package_repository_manager</span>
<span class="kn">from</span> <span class="nn">rez.solver</span> <span class="kn">import</span> <span class="n">SolverCallbackReturn</span>
<span class="kn">from</span> <span class="nn">rez.resolver</span> <span class="kn">import</span> <span class="n">Resolver</span><span class="p">,</span> <span class="n">ResolverStatus</span>
<span class="kn">from</span> <span class="nn">rez.system</span> <span class="kn">import</span> <span class="n">system</span>
<span class="kn">from</span> <span class="nn">rez.config</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">rez.util</span> <span class="kn">import</span> <span class="n">dedup</span><span class="p">,</span> <span class="n">is_non_string_iterable</span>
<span class="kn">from</span> <span class="nn">rez.utils.sourcecode</span> <span class="kn">import</span> <span class="n">SourceCodeError</span>
<span class="kn">from</span> <span class="nn">rez.utils.colorize</span> <span class="kn">import</span> <span class="n">critical</span><span class="p">,</span> <span class="n">heading</span><span class="p">,</span> <span class="n">local</span><span class="p">,</span> <span class="n">implicit</span><span class="p">,</span> <span class="n">Printer</span><span class="p">,</span> \
    <span class="n">ephemeral</span> <span class="k">as</span> <span class="n">ephemeral_color</span>
<span class="kn">from</span> <span class="nn">rez.utils.formatting</span> <span class="kn">import</span> <span class="n">columnise</span><span class="p">,</span> <span class="n">PackageRequest</span><span class="p">,</span> <span class="n">ENV_VAR_REGEX</span><span class="p">,</span> \
    <span class="n">header_comment</span><span class="p">,</span> <span class="n">minor_header_comment</span>
<span class="kn">from</span> <span class="nn">rez.utils.data_utils</span> <span class="kn">import</span> <span class="n">deep_del</span>
<span class="kn">from</span> <span class="nn">rez.utils.filesystem</span> <span class="kn">import</span> <span class="n">TempDirs</span><span class="p">,</span> <span class="n">is_subdirectory</span><span class="p">,</span> <span class="n">canonical_path</span>
<span class="kn">from</span> <span class="nn">rez.utils.memcached</span> <span class="kn">import</span> <span class="n">pool_memcached_connections</span>
<span class="kn">from</span> <span class="nn">rez.utils.logging_</span> <span class="kn">import</span> <span class="n">print_error</span><span class="p">,</span> <span class="n">print_warning</span>
<span class="kn">from</span> <span class="nn">rez.utils.which</span> <span class="kn">import</span> <span class="n">which</span>
<span class="kn">from</span> <span class="nn">rez.rex</span> <span class="kn">import</span> <span class="n">RexExecutor</span><span class="p">,</span> <span class="n">Python</span><span class="p">,</span> <span class="n">OutputStyle</span>
<span class="kn">from</span> <span class="nn">rez.rex_bindings</span> <span class="kn">import</span> <span class="n">VersionBinding</span><span class="p">,</span> <span class="n">VariantBinding</span><span class="p">,</span> \
    <span class="n">VariantsBinding</span><span class="p">,</span> <span class="n">RequirementsBinding</span><span class="p">,</span> <span class="n">EphemeralsBinding</span><span class="p">,</span> <span class="n">intersects</span>
<span class="kn">from</span> <span class="nn">rez</span> <span class="kn">import</span> <span class="n">package_order</span>
<span class="kn">from</span> <span class="nn">rez.packages</span> <span class="kn">import</span> <span class="n">get_variant</span><span class="p">,</span> <span class="n">iter_packages</span>
<span class="kn">from</span> <span class="nn">rez.package_filter</span> <span class="kn">import</span> <span class="n">PackageFilterList</span>
<span class="kn">from</span> <span class="nn">rez.package_order</span> <span class="kn">import</span> <span class="n">PackageOrderList</span>
<span class="kn">from</span> <span class="nn">rez.package_cache</span> <span class="kn">import</span> <span class="n">PackageCache</span>
<span class="kn">from</span> <span class="nn">rez.shells</span> <span class="kn">import</span> <span class="n">create_shell</span>
<span class="kn">from</span> <span class="nn">rez.exceptions</span> <span class="kn">import</span> <span class="n">ResolvedContextError</span><span class="p">,</span> <span class="n">PackageCommandError</span><span class="p">,</span> \
    <span class="n">RezError</span><span class="p">,</span> <span class="n">_NeverError</span><span class="p">,</span> <span class="n">PackageCacheError</span><span class="p">,</span> <span class="n">PackageNotFoundError</span>
<span class="kn">from</span> <span class="nn">rez.utils.graph_utils</span> <span class="kn">import</span> <span class="n">write_dot</span><span class="p">,</span> <span class="n">write_compacted</span><span class="p">,</span> \
    <span class="n">read_graph_from_string</span>
<span class="kn">from</span> <span class="nn">rez.utils.resolve_graph</span> <span class="kn">import</span> <span class="n">failure_detail_from_graph</span>
<span class="kn">from</span> <span class="nn">rez.vendor.six</span> <span class="kn">import</span> <span class="n">six</span>
<span class="kn">from</span> <span class="nn">rez.vendor.version.version</span> <span class="kn">import</span> <span class="n">VersionRange</span>
<span class="kn">from</span> <span class="nn">rez.vendor.version.requirement</span> <span class="kn">import</span> <span class="n">Requirement</span>
<span class="kn">from</span> <span class="nn">rez.vendor.enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">rez.vendor</span> <span class="kn">import</span> <span class="n">yaml</span>
<span class="kn">from</span> <span class="nn">rez.utils</span> <span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="nn">rez.utils.yaml</span> <span class="kn">import</span> <span class="n">dump_yaml</span>
<span class="kn">from</span> <span class="nn">rez.utils.platform_</span> <span class="kn">import</span> <span class="n">platform_</span>

<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">import</span> <span class="nn">getpass</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">os.path</span>


<span class="n">basestring</span> <span class="o">=</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<div class="viewcode-block" id="RezToolsVisibility"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.RezToolsVisibility">[docs]</a><span class="k">class</span> <span class="nc">RezToolsVisibility</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Determines if/how rez cli tools are added back to PATH within a</span>
<span class="sd">    resolved environment.&quot;&quot;&quot;</span>
    <span class="n">never</span> <span class="o">=</span> <span class="mi">0</span>               <span class="c1"># Don&#39;t expose rez in resolved env</span>
    <span class="n">append</span> <span class="o">=</span> <span class="mi">1</span>              <span class="c1"># Append to PATH in resolved env</span>
    <span class="n">prepend</span> <span class="o">=</span> <span class="mi">2</span>             <span class="c1"># Prepend to PATH in resolved env</span></div>


<div class="viewcode-block" id="SuiteVisibility"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.SuiteVisibility">[docs]</a><span class="k">class</span> <span class="nc">SuiteVisibility</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Defines what suites on $PATH stay visible when a new rez environment is</span>
<span class="sd">    resolved.&quot;&quot;&quot;</span>
    <span class="n">never</span> <span class="o">=</span> <span class="mi">0</span>               <span class="c1"># Don&#39;t attempt to keep any suites visible in a new env</span>
    <span class="n">always</span> <span class="o">=</span> <span class="mi">1</span>              <span class="c1"># Keep suites visible in any new env</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="mi">2</span>              <span class="c1"># Keep only the parent suite of a tool visible</span>
    <span class="n">parent_priority</span> <span class="o">=</span> <span class="mi">3</span>     <span class="c1"># Keep all suites visible and the parent takes precedence</span></div>


<div class="viewcode-block" id="PatchLock"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.PatchLock">[docs]</a><span class="k">class</span> <span class="nc">PatchLock</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Enum to represent the &#39;lock type&#39; used when patching context objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">no_lock</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;No locking&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">lock_2</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Minor version updates only (X.*)&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">lock_3</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Patch version updates only (X.X.*)&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">lock_4</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Build version updates only (X.X.X.*)&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">lock</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Exact version&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">__order__</span> <span class="o">=</span> <span class="s2">&quot;no_lock,lock_2,lock_3,lock_4,lock&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">rank</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="n">rank</span></div>


<div class="viewcode-block" id="get_lock_request"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.get_lock_request">[docs]</a><span class="k">def</span> <span class="nf">get_lock_request</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">patch_lock</span><span class="p">,</span> <span class="n">weak</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given a package and patch lock, return the equivalent request.</span>

<span class="sd">    For example, for object &#39;foo-1.2.1&#39; and lock type &#39;lock_3&#39;, the equivalent</span>
<span class="sd">    request is &#39;~foo-1.2&#39;. This restricts updates to foo to patch-or-lower</span>
<span class="sd">    version changes only.</span>

<span class="sd">    For objects not versioned down to a given lock level, the closest possible</span>
<span class="sd">    lock is applied. So &#39;lock_3&#39; applied to &#39;foo-1&#39; would give &#39;~foo-1&#39;.</span>

<span class="sd">    Args:</span>
<span class="sd">        name (str): Package name.</span>
<span class="sd">        version (Version): Package version.</span>
<span class="sd">        patch_lock (PatchLock): Lock type to apply.</span>

<span class="sd">    Returns:</span>
<span class="sd">        `PackageRequest` object, or None if there is no equivalent request.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ch</span> <span class="o">=</span> <span class="s1">&#39;~&#39;</span> <span class="k">if</span> <span class="n">weak</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">patch_lock</span> <span class="o">==</span> <span class="n">PatchLock</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">==</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">version</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">PackageRequest</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">patch_lock</span> <span class="o">==</span> <span class="n">PatchLock</span><span class="o">.</span><span class="n">no_lock</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">version</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">version_</span> <span class="o">=</span> <span class="n">version</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">patch_lock</span><span class="o">.</span><span class="n">rank</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">-</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">version_</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">PackageRequest</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></div>


<div class="viewcode-block" id="ResolvedContext"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.ResolvedContext">[docs]</a><span class="k">class</span> <span class="nc">ResolvedContext</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A class that resolves, stores and spawns Rez environments.</span>

<span class="sd">    The main Rez entry point for creating, saving, loading and executing</span>
<span class="sd">    resolved environments. A ResolvedContext object can be saved to file and</span>
<span class="sd">    loaded at a later date, and it can reconstruct the equivalent environment</span>
<span class="sd">    at that time. It can spawn interactive and non-interactive shells, in any</span>
<span class="sd">    supported shell plugin type, such as bash and tcsh. It can also run a</span>
<span class="sd">    command within a configured python namespace, without spawning a child</span>
<span class="sd">    shell.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">serialize_version</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
    <span class="n">tmpdir_manager</span> <span class="o">=</span> <span class="n">TempDirs</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">context_tmpdir</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;rez_context_&quot;</span><span class="p">)</span>
    <span class="n">context_tracking_payload</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">context_tracking_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
    <span class="n">package_cache_present</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">local</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">local</span><span class="p">()</span>

<div class="viewcode-block" id="ResolvedContext.Callback"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.ResolvedContext.Callback">[docs]</a>    <span class="k">class</span> <span class="nc">Callback</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_fails</span><span class="p">,</span> <span class="n">time_limit</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">buf</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_fails</span> <span class="o">=</span> <span class="n">max_fails</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_limit</span> <span class="o">=</span> <span class="n">time_limit</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">callback</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>

        <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_fails</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">state</span><span class="o">.</span><span class="n">num_fails</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_fails</span><span class="p">:</span>
                <span class="n">reason</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;fail limit reached: aborted after </span><span class="si">%d</span><span class="s2"> failures&quot;</span>
                          <span class="o">%</span> <span class="n">state</span><span class="o">.</span><span class="n">num_fails</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">SolverCallbackReturn</span><span class="o">.</span><span class="n">fail</span><span class="p">,</span> <span class="n">reason</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_limit</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">secs</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span>
                <span class="k">if</span> <span class="n">secs</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_limit</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">SolverCallbackReturn</span><span class="o">.</span><span class="n">abort</span><span class="p">,</span> <span class="s2">&quot;time limit exceeded&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">SolverCallbackReturn</span><span class="o">.</span><span class="n">keep_going</span><span class="p">,</span> <span class="s1">&#39;&#39;</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package_requests</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">building</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">caching</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">package_paths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">package_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">package_orderers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_fails</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">add_implicit_packages</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">package_load_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">buf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">suppress_passive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">print_stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">package_caching</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform a package resolve, and store the result.</span>

<span class="sd">        Args:</span>
<span class="sd">            package_requests: List of strings or PackageRequest objects</span>
<span class="sd">                representing the request.</span>
<span class="sd">            verbosity: Verbosity level. One of [0,1,2].</span>
<span class="sd">            timestamp: Ignore packages released after this epoch time. Packages</span>
<span class="sd">                released at exactly this time will not be ignored.</span>
<span class="sd">            building: True if we&#39;re resolving for a build.</span>
<span class="sd">            caching: If True, cache(s) may be used to speed the resolve. If</span>
<span class="sd">                False, caches will not be used. If None, config.resolve_caching</span>
<span class="sd">                is used.</span>
<span class="sd">            package_paths: List of paths to search for pkgs, defaults to</span>
<span class="sd">                config.packages_path.</span>
<span class="sd">            package_filter (`PackageFilterBase`): Filter used to exclude certain</span>
<span class="sd">                packages. Defaults to settings from config.package_filter. Use</span>
<span class="sd">                `package_filter.no_filter` to remove all filtering.</span>
<span class="sd">            package_orderers (list of `PackageOrder`): Custom package ordering.</span>
<span class="sd">                Defaults to settings from config.package_orderers.</span>
<span class="sd">            add_implicit_packages: If True, the implicit package list defined</span>
<span class="sd">                by config.implicit_packages is appended to the request.</span>
<span class="sd">            max_fails (int): Abort the resolve if the number of failed steps is</span>
<span class="sd">                greater or equal to this number. If -1, does not abort.</span>
<span class="sd">            time_limit (int): Abort the resolve if it takes longer than this</span>
<span class="sd">                many seconds. If -1, there is no time limit.</span>
<span class="sd">            callback: See `Solver`.</span>
<span class="sd">            package_load_callback: If not None, this callable will be called</span>
<span class="sd">                prior to each package being loaded. It is passed a single</span>
<span class="sd">                `Package` object.</span>
<span class="sd">            buf (file-like object): Where to print verbose output to, defaults</span>
<span class="sd">                to stdout.</span>
<span class="sd">            suppress_passive (bool): If True, don&#39;t print debugging info that</span>
<span class="sd">                has had no effect on the solve. This argument only has an</span>
<span class="sd">                effect if `verbosity` &gt; 2.</span>
<span class="sd">            print_stats (bool): If True, print advanced solver stats at the end.</span>
<span class="sd">            package_caching (bool|None): If True, apply package caching settings</span>
<span class="sd">                as per the config. If None, enable as determined by config</span>
<span class="sd">                setting &#39;package_cache_during_build&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_path</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># resolving settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requested_timestamp</span> <span class="o">=</span> <span class="n">timestamp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">requested_timestamp</span> <span class="ow">or</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">building</span> <span class="o">=</span> <span class="n">building</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">implicit_packages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">caching</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">resolve_caching</span> <span class="k">if</span> <span class="n">caching</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">caching</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">=</span> <span class="n">verbosity</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_package_requests</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">package_requests</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                <span class="n">req</span> <span class="o">=</span> <span class="n">PackageRequest</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_package_requests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">add_implicit_packages</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">implicit_packages</span> <span class="o">=</span> <span class="p">[</span><span class="n">PackageRequest</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                                      <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">implicit_packages</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">package_paths</span> <span class="o">=</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">packages_path</span> <span class="k">if</span> <span class="n">package_paths</span> <span class="ow">is</span> <span class="kc">None</span>
                              <span class="k">else</span> <span class="n">package_paths</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">package_paths</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dedup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package_paths</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">package_filter</span> <span class="o">=</span> <span class="p">(</span><span class="n">PackageFilterList</span><span class="o">.</span><span class="n">singleton</span> <span class="k">if</span> <span class="n">package_filter</span> <span class="ow">is</span> <span class="kc">None</span>
                               <span class="k">else</span> <span class="n">package_filter</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">package_orderers</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">PackageOrderList</span><span class="o">.</span><span class="n">singleton</span> <span class="k">if</span> <span class="n">package_orderers</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="n">package_orderers</span>
        <span class="p">)</span>

        <span class="c1"># settings that affect context execution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">append_sys_path</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">package_caching</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">building</span><span class="p">:</span>
                <span class="n">package_caching</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">package_cache_during_build</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">package_caching</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">package_caching</span> <span class="o">=</span> <span class="n">package_caching</span>

        <span class="c1"># patch settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_patch_lock</span> <span class="o">=</span> <span class="n">PatchLock</span><span class="o">.</span><span class="n">no_lock</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patch_locks</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># info about env the resolve occurred in</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rez_version</span> <span class="o">=</span> <span class="n">__version__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rez_path</span> <span class="o">=</span> <span class="n">module_root_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">hostname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">platform</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">platform</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">arch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">os</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">os</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">created</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>

        <span class="c1"># resolve results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_</span> <span class="o">=</span> <span class="n">ResolverStatus</span><span class="o">.</span><span class="n">pending</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resolved_packages</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resolved_ephemerals</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failure_description</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph_string</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">from_cache</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># stats</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solve_time</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># total solve time, inclusive of load time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_time</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># total time loading packages (disk or memcache)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_loaded_packages</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># num packages loaded (disk or memcache)</span>

        <span class="c1"># the pre-resolve bindings. We store these because @late package.py</span>
        <span class="c1"># functions need them, and we cache them to avoid cost</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre_resolve_bindings</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># suite information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_suite_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suite_context_name</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># perform the solve</span>
        <span class="n">callback_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Callback</span><span class="p">(</span><span class="n">buf</span><span class="o">=</span><span class="n">buf</span><span class="p">,</span>
                                  <span class="n">max_fails</span><span class="o">=</span><span class="n">max_fails</span><span class="p">,</span>
                                  <span class="n">time_limit</span><span class="o">=</span><span class="n">time_limit</span><span class="p">,</span>
                                  <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_package_load_callback</span><span class="p">(</span><span class="n">package</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">package_load_callback</span><span class="p">:</span>
                <span class="n">package_load_callback</span><span class="p">(</span><span class="n">package</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_loaded_packages</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">requested_packages</span><span class="p">(</span><span class="n">include_implicit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">resolver</span> <span class="o">=</span> <span class="n">Resolver</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                            <span class="n">package_requests</span><span class="o">=</span><span class="n">request</span><span class="p">,</span>
                            <span class="n">package_paths</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">package_paths</span><span class="p">,</span>
                            <span class="n">package_filter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">package_filter</span><span class="p">,</span>
                            <span class="n">package_orderers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">package_orderers</span><span class="p">,</span>
                            <span class="n">timestamp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">requested_timestamp</span><span class="p">,</span>
                            <span class="n">building</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">building</span><span class="p">,</span>
                            <span class="n">caching</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">caching</span><span class="p">,</span>
                            <span class="n">callback</span><span class="o">=</span><span class="n">callback_</span><span class="p">,</span>
                            <span class="n">package_load_callback</span><span class="o">=</span><span class="n">_package_load_callback</span><span class="p">,</span>
                            <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span>
                            <span class="n">buf</span><span class="o">=</span><span class="n">buf</span><span class="p">,</span>
                            <span class="n">suppress_passive</span><span class="o">=</span><span class="n">suppress_passive</span><span class="p">,</span>
                            <span class="n">print_stats</span><span class="o">=</span><span class="n">print_stats</span><span class="p">)</span>

        <span class="n">resolver</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

        <span class="c1"># convert the results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solve_time</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">solve_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_time</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">load_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failure_description</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">failure_description</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph_</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">graph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">from_cache</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">from_cache</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_</span> <span class="o">==</span> <span class="n">ResolverStatus</span><span class="o">.</span><span class="n">solved</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resolved_packages</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">variant</span> <span class="ow">in</span> <span class="n">resolver</span><span class="o">.</span><span class="n">resolved_packages</span><span class="p">:</span>
                <span class="n">variant</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_resolved_packages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">variant</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_resolved_ephemerals</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">resolved_ephemerals</span>

        <span class="c1"># track context usage</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">context_tracking_host</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">context_tracking_context_fields</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_track_context</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;created&quot;</span><span class="p">)</span>

        <span class="c1"># update package cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_package_cache</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">requested_packages</span><span class="p">(</span><span class="n">include_implicit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">req_str</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">ResolverStatus</span><span class="o">.</span><span class="n">solved</span><span class="p">:</span>
            <span class="n">res_str</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">qualified_name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolved_packages</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2"> ==&gt; </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">req_str</span><span class="p">,</span> <span class="n">res_str</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">req_str</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">success</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if the context has been solved, False otherwise.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status_</span> <span class="o">==</span> <span class="n">ResolverStatus</span><span class="o">.</span><span class="n">solved</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the current status of the context.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ResolverStatus.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_</span>

<div class="viewcode-block" id="ResolvedContext.requested_packages"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.ResolvedContext.requested_packages">[docs]</a>    <span class="k">def</span> <span class="nf">requested_packages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_implicit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get packages in the request.</span>

<span class="sd">        Args:</span>
<span class="sd">            include_implicit (bool): If True, implicit packages are appended</span>
<span class="sd">                to the result.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of `PackageRequest` objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">include_implicit</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_package_requests</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">implicit_packages</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_package_requests</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">resolved_packages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get packages in the resolve.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of `Variant` objects, or None if the resolve failed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolved_packages</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">resolved_ephemerals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get non-conflict ephemerals in the resolve.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of `Requirement` objects, or None if the resolve failed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolved_ephemerals</span>

<div class="viewcode-block" id="ResolvedContext.set_load_path"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.ResolvedContext.set_load_path">[docs]</a>    <span class="k">def</span> <span class="nf">set_load_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the path that this context was reportedly loaded from.</span>

<span class="sd">        You may want to use this method in cases where a context is saved to</span>
<span class="sd">        disk, but you need to associate this new path with the context while it</span>
<span class="sd">        is still in use.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_path</span> <span class="o">=</span> <span class="n">path</span></div>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Equality test.</span>

<span class="sd">        Two contexts are considered equal if they have an equivalent request,</span>
<span class="sd">        and an equivalent resolve. Other details, such as timestamp, are not</span>
<span class="sd">        considered.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">ResolvedContext</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">requested_packages</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">requested_packages</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">resolved_packages</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolved_packages</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">list_</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">requested_packages</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">list_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolved_packages</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">list_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">list_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>

        <span class="n">value</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">list_</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return True if the resolve has a graph.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_string</span><span class="p">)</span>

<div class="viewcode-block" id="ResolvedContext.get_resolved_package"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.ResolvedContext.get_resolved_package">[docs]</a>    <span class="k">def</span> <span class="nf">get_resolved_package</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a `Variant` object or None if the package is not in the</span>
<span class="sd">        resolve.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pkgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resolved_packages</span> <span class="ow">or</span> <span class="p">[])</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">pkgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">pkgs</span> <span class="k">else</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="ResolvedContext.copy"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.ResolvedContext.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a shallow copy of the context.&quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">copy</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="ResolvedContext.retargeted"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.ResolvedContext.retargeted">[docs]</a>    <span class="k">def</span> <span class="nf">retargeted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package_paths</span><span class="p">,</span> <span class="n">package_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip_missing</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a retargeted copy of this context.</span>

<span class="sd">        Retargeting a context means replacing its variant references with</span>
<span class="sd">        the same variants from other package repositories.</span>

<span class="sd">        Args:</span>
<span class="sd">            package_paths: List of paths to search for pkgs to retarget to.</span>
<span class="sd">            package_names (list of str): Only retarget these packages. If None,</span>
<span class="sd">                retarget all packages.</span>
<span class="sd">            skip_missing (bool): If True, skip retargeting of variants that</span>
<span class="sd">                cannot be found in `package_paths`. By default, a</span>
<span class="sd">                `PackageNotFoundError` is raised.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ResolvecContext`: The retargeted context.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">retargeted_variants</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">pkg_repos</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">package_repository_manager</span><span class="o">.</span><span class="n">get_repository</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">package_paths</span>
        <span class="p">]</span>

        <span class="c1"># find retargeted variant for every variant in this context</span>
        <span class="k">for</span> <span class="n">src_variant</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resolved_packages</span> <span class="ow">or</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="n">package_names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">src_variant</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">package_names</span><span class="p">:</span>
                <span class="n">retargeted_variants</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">src_variant</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">found</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">for</span> <span class="n">pkg_repo</span> <span class="ow">in</span> <span class="n">pkg_repos</span><span class="p">:</span>
                <span class="n">dest_variant</span> <span class="o">=</span> <span class="n">pkg_repo</span><span class="o">.</span><span class="n">get_equivalent_variant</span><span class="p">(</span><span class="n">src_variant</span><span class="o">.</span><span class="n">resource</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dest_variant</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">skip_missing</span><span class="p">:</span>
                    <span class="n">retargeted_variants</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">src_variant</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">PackageNotFoundError</span><span class="p">(</span>
                        <span class="s2">&quot;The equivalent variant in package </span><span class="si">%s</span><span class="s2"> could not be found in any of </span><span class="si">%r</span><span class="s2">&quot;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">src_variant</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">package_paths</span><span class="p">)</span>
                    <span class="p">)</span>

            <span class="n">retargeted_variants</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dest_variant</span><span class="p">)</span>

        <span class="c1"># create the retargeted context</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s2">&quot;package_paths&quot;</span><span class="p">:</span> <span class="n">package_paths</span><span class="p">,</span>
            <span class="s2">&quot;resolved_packages&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">x</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">retargeted_variants</span>
            <span class="p">]</span>
        <span class="p">})</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">)</span></div>

    <span class="c1"># TODO: deprecate in favor of patch() method</span>
<div class="viewcode-block" id="ResolvedContext.get_patched_request"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.ResolvedContext.get_patched_request">[docs]</a>    <span class="k">def</span> <span class="nf">get_patched_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package_requests</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">package_subtractions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a &#39;patched&#39; request.</span>

<span class="sd">        A patched request is a copy of this context&#39;s request, but with some</span>
<span class="sd">        changes applied. This can then be used to create a new, &#39;patched&#39;</span>
<span class="sd">        context.</span>

<span class="sd">        New package requests override original requests based on the type -</span>
<span class="sd">        normal, conflict or weak. So &#39;foo-2&#39; overrides &#39;foo-1&#39;, &#39;!foo-2&#39;</span>
<span class="sd">        overrides &#39;!foo-1&#39; and &#39;~foo-2&#39; overrides &#39;~foo-1&#39;, but a request such</span>
<span class="sd">        as &#39;!foo-2&#39; would not replace &#39;foo-1&#39; - it would be added instead.</span>

<span class="sd">        Note that requests in `package_requests` can have the form &#39;^foo&#39;. This</span>
<span class="sd">        is another way of supplying package subtractions.</span>

<span class="sd">        Any new requests that don&#39;t override original requests are appended,</span>
<span class="sd">        in the order that they appear in `package_requests`.</span>

<span class="sd">        Args:</span>
<span class="sd">            package_requests (list of str or list of `PackageRequest`):</span>
<span class="sd">                Overriding requests.</span>
<span class="sd">            package_subtractions (list of str): Any original request with a</span>
<span class="sd">                package name in this list is removed, before the new requests</span>
<span class="sd">                are added.</span>
<span class="sd">            strict (bool): If True, the current context&#39;s resolve is used as the</span>
<span class="sd">                original request list, rather than the request.</span>
<span class="sd">            rank (int): If &gt; 1, package versions can only increase in this rank</span>
<span class="sd">                and further - for example, rank=3 means that only version patch</span>
<span class="sd">                numbers are allowed to increase, major and minor versions will</span>
<span class="sd">                not change. This is only applied to packages that have not been</span>
<span class="sd">                explicitly overridden in `package_requests`. If rank &lt;= 1, or</span>
<span class="sd">                `strict` is True, rank is ignored.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of `PackageRequest` objects that can be used to construct a</span>
<span class="sd">            new `ResolvedContext` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># assemble source request</span>
        <span class="k">if</span> <span class="n">strict</span><span class="p">:</span>
            <span class="n">request</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">variant</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolved_packages</span><span class="p">:</span>
                <span class="n">req</span> <span class="o">=</span> <span class="n">PackageRequest</span><span class="p">(</span><span class="n">variant</span><span class="o">.</span><span class="n">qualified_package_name</span><span class="p">)</span>
                <span class="n">request</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">requested_packages</span><span class="p">()[:]</span>

        <span class="c1"># convert &#39;^foo&#39;-style requests to subtractions</span>
        <span class="k">if</span> <span class="n">package_requests</span><span class="p">:</span>
            <span class="n">package_subtractions</span> <span class="o">=</span> <span class="n">package_subtractions</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="n">indexes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">req</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">package_requests</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;^&#39;</span><span class="p">):</span>
                    <span class="n">package_subtractions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                    <span class="n">indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">indexes</span><span class="p">):</span>
                <span class="k">del</span> <span class="n">package_requests</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># apply subtractions</span>
        <span class="k">if</span> <span class="n">package_subtractions</span><span class="p">:</span>
            <span class="n">request</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">request</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">package_subtractions</span><span class="p">]</span>

        <span class="c1"># apply overrides</span>
        <span class="k">if</span> <span class="n">package_requests</span><span class="p">:</span>
            <span class="n">request_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
            <span class="n">request_</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">package_requests</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                    <span class="n">req</span> <span class="o">=</span> <span class="n">PackageRequest</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">request_dict</span><span class="p">:</span>
                    <span class="n">i</span><span class="p">,</span> <span class="n">req_</span> <span class="o">=</span> <span class="n">request_dict</span><span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">req_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">req_</span><span class="o">.</span><span class="n">conflict</span> <span class="o">==</span> <span class="n">req</span><span class="o">.</span><span class="n">conflict</span><span class="p">)</span> \
                            <span class="ow">and</span> <span class="p">(</span><span class="n">req_</span><span class="o">.</span><span class="n">weak</span> <span class="o">==</span> <span class="n">req</span><span class="o">.</span><span class="n">weak</span><span class="p">):</span>
                        <span class="n">request</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">req</span>
                        <span class="k">del</span> <span class="n">request_dict</span><span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">request_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">request_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>

            <span class="n">request</span> <span class="o">+=</span> <span class="n">request_</span>

        <span class="c1"># add rank limiters</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">strict</span> <span class="ow">and</span> <span class="n">rank</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">overrides</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">package_requests</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">conflict</span><span class="p">)</span>
            <span class="n">rank_limiters</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">variant</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolved_packages</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">variant</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">overrides</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">variant</span><span class="o">.</span><span class="n">version</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">rank</span><span class="p">:</span>
                        <span class="n">version</span> <span class="o">=</span> <span class="n">variant</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">rank</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">version</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
                        <span class="n">req</span> <span class="o">=</span> <span class="s2">&quot;~</span><span class="si">%s</span><span class="s2">&lt;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">variant</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">version</span><span class="p">))</span>
                        <span class="n">rank_limiters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
            <span class="n">request</span> <span class="o">+=</span> <span class="n">rank_limiters</span>

        <span class="k">return</span> <span class="n">request</span></div>

<div class="viewcode-block" id="ResolvedContext.graph"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.ResolvedContext.graph">[docs]</a>    <span class="k">def</span> <span class="nf">graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">as_dot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the resolve graph.</span>

<span class="sd">        Args:</span>
<span class="sd">            as_dot: If True, get the graph as a dot-language string. Otherwise,</span>
<span class="sd">                a pygraph.digraph object is returned.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A string or `pygraph.digraph` object, or None if there is no graph</span>
<span class="sd">            associated with the resolve.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_graph</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">as_dot</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># reads either dot format or our compact format</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">graph_</span> <span class="o">=</span> <span class="n">read_graph_from_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_string</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_string</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_string</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">):</span>  <span class="c1"># compact format</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">graph_</span> <span class="o">=</span> <span class="n">read_graph_from_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_string</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># already in dot format. Note that this will only happen in</span>
                <span class="c1"># old rez contexts where the graph is not stored in the newer</span>
                <span class="c1"># compact format.</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_string</span>

        <span class="k">return</span> <span class="n">write_dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_</span><span class="p">)</span></div>

<div class="viewcode-block" id="ResolvedContext.save"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.ResolvedContext.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save the resolved context to file.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect_bundle</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_to_buffer</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></div>

<div class="viewcode-block" id="ResolvedContext.write_to_buffer"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.ResolvedContext.write_to_buffer">[docs]</a>    <span class="k">def</span> <span class="nf">write_to_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save the context to a buffer.&quot;&quot;&quot;</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">rxt_as_yaml</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">dump_yaml</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;: &quot;</span><span class="p">),</span>
                                 <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">buf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span></div>

<div class="viewcode-block" id="ResolvedContext.get_current"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.ResolvedContext.get_current">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_current</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the context for the current env, if there is one.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `ResolvedContext`: Current context, or None if not in a resolved env.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;REZ_RXT_FILE&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filepath</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span></div>

<div class="viewcode-block" id="ResolvedContext.is_current"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.ResolvedContext.is_current">[docs]</a>    <span class="k">def</span> <span class="nf">is_current</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            bool: True if this is the currently sourced context, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_path</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;REZ_RXT_FILE&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filepath</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_path</span> <span class="o">==</span> <span class="n">filepath</span><span class="p">)</span></div>

<div class="viewcode-block" id="ResolvedContext.load"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.ResolvedContext.load">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load a resolved context from file.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_detect_bundle</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">context</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">read_from_buffer</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

        <span class="n">context</span><span class="o">.</span><span class="n">set_load_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span></div>

<div class="viewcode-block" id="ResolvedContext.read_from_buffer"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.ResolvedContext.read_from_buffer">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">read_from_buffer</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">identifier_str</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load the context from a buffer.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_read_from_buffer</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">identifier_str</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_load_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">identifier_str</span><span class="p">)</span></div>

<div class="viewcode-block" id="ResolvedContext.get_resolve_diff"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.ResolvedContext.get_resolve_diff">[docs]</a>    <span class="k">def</span> <span class="nf">get_resolve_diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the difference between the resolve in this context and another.</span>

<span class="sd">        The difference is described from the point of view of the current context</span>
<span class="sd">        - a newer package means that the package in `other` is newer than the</span>
<span class="sd">        package in `self`.</span>

<span class="sd">        Diffs can only be compared if their package search paths match, an error</span>
<span class="sd">        is raised otherwise.</span>

<span class="sd">        The diff is expressed in packages, not variants - the specific variant</span>
<span class="sd">        of a package is ignored.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A dict containing:</span>
<span class="sd">            - &#39;newer_packages&#39;: A dict containing items:</span>
<span class="sd">              - package name (str);</span>
<span class="sd">              - List of `Package` objects. These are the packages up to and</span>
<span class="sd">                including the newer package in `self`, in ascending order.</span>
<span class="sd">            - &#39;older_packages&#39;: A dict containing:</span>
<span class="sd">              - package name (str);</span>
<span class="sd">              - List of `Package` objects. These are the packages down to and</span>
<span class="sd">                including the older package in `self`, in descending order.</span>
<span class="sd">            - &#39;added_packages&#39;: Set of `Package` objects present in `self` but</span>
<span class="sd">               not in `other`;</span>
<span class="sd">            - &#39;removed_packages&#39;: Set of `Package` objects present in `other`,</span>
<span class="sd">               but not in `self`.</span>

<span class="sd">            If any item (&#39;added_packages&#39; etc) is empty, it is not added to the</span>
<span class="sd">            resulting dict. Thus, an empty dict is returned if there is no</span>
<span class="sd">            difference between contexts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_paths</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">package_paths</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">difflib</span> <span class="kn">import</span> <span class="n">ndiff</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">ndiff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package_paths</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">package_paths</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ResolvedContextError</span><span class="p">(</span><span class="s2">&quot;Cannot diff resolves, package search &quot;</span>
                                       <span class="s2">&quot;paths differ:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">diff</span><span class="p">))</span>

        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self_pkgs_</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">parent</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolved_packages</span><span class="p">)</span>
        <span class="n">other_pkgs_</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">parent</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">_resolved_packages</span><span class="p">)</span>
        <span class="n">self_pkgs</span> <span class="o">=</span> <span class="n">self_pkgs_</span> <span class="o">-</span> <span class="n">other_pkgs_</span>
        <span class="n">other_pkgs</span> <span class="o">=</span> <span class="n">other_pkgs_</span> <span class="o">-</span> <span class="n">self_pkgs_</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">self_pkgs</span> <span class="ow">or</span> <span class="n">other_pkgs</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">d</span>

        <span class="n">self_fams</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">self_pkgs</span><span class="p">)</span>
        <span class="n">other_fams</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">other_pkgs</span><span class="p">)</span>

        <span class="n">newer_packages</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">older_packages</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">added_packages</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">removed_packages</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="n">self_pkgs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pkg</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">other_fams</span><span class="p">:</span>
                <span class="n">removed_packages</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">other_pkg</span> <span class="o">=</span> <span class="n">other_fams</span><span class="p">[</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">other_pkg</span><span class="o">.</span><span class="n">version</span> <span class="o">&gt;</span> <span class="n">pkg</span><span class="o">.</span><span class="n">version</span><span class="p">:</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">VersionRange</span><span class="o">.</span><span class="n">as_span</span><span class="p">(</span><span class="n">lower_version</span><span class="o">=</span><span class="n">pkg</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
                                             <span class="n">upper_version</span><span class="o">=</span><span class="n">other_pkg</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
                    <span class="n">it</span> <span class="o">=</span> <span class="n">iter_packages</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">range_</span><span class="o">=</span><span class="n">r</span><span class="p">)</span>
                    <span class="n">pkgs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
                    <span class="n">newer_packages</span><span class="p">[</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pkgs</span>
                <span class="k">elif</span> <span class="n">other_pkg</span><span class="o">.</span><span class="n">version</span> <span class="o">&lt;</span> <span class="n">pkg</span><span class="o">.</span><span class="n">version</span><span class="p">:</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">VersionRange</span><span class="o">.</span><span class="n">as_span</span><span class="p">(</span><span class="n">lower_version</span><span class="o">=</span><span class="n">other_pkg</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
                                             <span class="n">upper_version</span><span class="o">=</span><span class="n">pkg</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
                    <span class="n">it</span> <span class="o">=</span> <span class="n">iter_packages</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">range_</span><span class="o">=</span><span class="n">r</span><span class="p">)</span>
                    <span class="n">pkgs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">older_packages</span><span class="p">[</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pkgs</span>

        <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="n">other_pkgs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pkg</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self_fams</span><span class="p">:</span>
                <span class="n">added_packages</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">newer_packages</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="s2">&quot;newer_packages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newer_packages</span>
        <span class="k">if</span> <span class="n">older_packages</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="s2">&quot;older_packages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">older_packages</span>
        <span class="k">if</span> <span class="n">added_packages</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="s2">&quot;added_packages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">added_packages</span>
        <span class="k">if</span> <span class="n">removed_packages</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="s2">&quot;removed_packages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">removed_packages</span>
        <span class="k">return</span> <span class="n">d</span></div>

<div class="viewcode-block" id="ResolvedContext.print_info"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.ResolvedContext.print_info">[docs]</a>    <span class="nd">@pool_memcached_connections</span>
    <span class="k">def</span> <span class="nf">print_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">source_order</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">show_resolved_uris</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prints a message summarising the contents of the resolved context.</span>

<span class="sd">        Args:</span>
<span class="sd">            buf (file-like object): Where to print this info to.</span>
<span class="sd">            verbosity (bool): Verbose mode.</span>
<span class="sd">            source_order (bool): If True, print resolved packages in the order</span>
<span class="sd">                they are sourced, rather than alphabetical order.</span>
<span class="sd">            show_resolved_uris (bool): By default, resolved packages have their</span>
<span class="sd">                &#39;root&#39; property listed, or their &#39;uri&#39; if &#39;root&#39; is None. Use</span>
<span class="sd">                this option to list &#39;uri&#39; regardless.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_pr</span> <span class="o">=</span> <span class="n">Printer</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_rt</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">verbosity</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%a</span><span class="s2"> %b </span><span class="si">%d</span><span class="s2"> %H:%M:%S %Z %Y&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">s</span> <span class="o">+</span> <span class="s2">&quot; (</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%a</span><span class="s2"> %b </span><span class="si">%d</span><span class="s2"> %H:%M:%S %Y&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ResolverStatus</span><span class="o">.</span><span class="n">failed</span><span class="p">,</span> <span class="n">ResolverStatus</span><span class="o">.</span><span class="n">aborted</span><span class="p">):</span>
            <span class="n">res_status</span> <span class="o">=</span> <span class="s2">&quot;resolve failed,&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res_status</span> <span class="o">=</span> <span class="s2">&quot;resolved&quot;</span>

        <span class="n">t_str</span> <span class="o">=</span> <span class="n">_rt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">created</span><span class="p">)</span>
        <span class="n">_pr</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> by </span><span class="si">%s</span><span class="s2">@</span><span class="si">%s</span><span class="s2">, on </span><span class="si">%s</span><span class="s2">, using Rez v</span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">res_status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">t_str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rez_version</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">requested_timestamp</span><span class="p">:</span>
            <span class="n">t_str</span> <span class="o">=</span> <span class="n">_rt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">requested_timestamp</span><span class="p">)</span>
            <span class="n">_pr</span><span class="p">(</span><span class="s2">&quot;packages released after </span><span class="si">%s</span><span class="s2"> were ignored&quot;</span> <span class="o">%</span> <span class="n">t_str</span><span class="p">)</span>
        <span class="n">_pr</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">verbosity</span><span class="p">:</span>
            <span class="n">_pr</span><span class="p">(</span><span class="s2">&quot;search paths:&quot;</span><span class="p">,</span> <span class="n">heading</span><span class="p">)</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_paths</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">package_repository_manager</span><span class="o">.</span><span class="n">are_same</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">local_packages_path</span><span class="p">):</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;(local)&quot;</span>
                    <span class="n">col</span> <span class="o">=</span> <span class="n">local</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">col</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">path</span><span class="p">,</span> <span class="n">label</span><span class="p">))</span>
                <span class="n">colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">colors</span><span class="p">,</span> <span class="n">columnise</span><span class="p">(</span><span class="n">rows</span><span class="p">)):</span>
                <span class="n">_pr</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
            <span class="n">_pr</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_filter</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_filter</span><span class="o">.</span><span class="n">to_pod</span><span class="p">()</span>
                <span class="n">txt</span> <span class="o">=</span> <span class="n">dump_yaml</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">_pr</span><span class="p">(</span><span class="s2">&quot;package filters:&quot;</span><span class="p">,</span> <span class="n">heading</span><span class="p">)</span>
                <span class="n">_pr</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
                <span class="n">_pr</span><span class="p">()</span>

        <span class="n">_pr</span><span class="p">(</span><span class="s2">&quot;requested packages:&quot;</span><span class="p">,</span> <span class="n">heading</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">request</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_package_requests</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="p">),</span> <span class="s2">&quot;(ephemeral)&quot;</span><span class="p">))</span>
                <span class="n">colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ephemeral_color</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="p">),</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
                <span class="n">colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">request</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">implicit_packages</span><span class="p">:</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="p">),</span> <span class="s2">&quot;(implicit)&quot;</span><span class="p">))</span>
            <span class="n">colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">implicit</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">colors</span><span class="p">,</span> <span class="n">columnise</span><span class="p">(</span><span class="n">rows</span><span class="p">)):</span>
            <span class="n">_pr</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
        <span class="n">_pr</span><span class="p">()</span>

        <span class="c1"># show resolved, or not</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ResolverStatus</span><span class="o">.</span><span class="n">failed</span><span class="p">,</span> <span class="n">ResolverStatus</span><span class="o">.</span><span class="n">aborted</span><span class="p">):</span>
            <span class="n">_pr</span><span class="p">(</span><span class="s2">&quot;The context failed to resolve:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure_description</span><span class="p">,</span> <span class="n">critical</span><span class="p">)</span>

            <span class="n">_pr</span><span class="p">()</span>
            <span class="n">_pr</span><span class="p">(</span><span class="n">failure_detail_from_graph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">(</span><span class="n">as_dot</span><span class="o">=</span><span class="kc">False</span><span class="p">)))</span>
            <span class="n">_pr</span><span class="p">()</span>
            <span class="n">_pr</span><span class="p">(</span><span class="s2">&quot;To see a graph of the failed resolution, add --fail-graph &quot;</span>
                <span class="s2">&quot;in your rez-env or rez-build command.&quot;</span><span class="p">)</span>
            <span class="n">_pr</span><span class="p">()</span>

            <span class="k">return</span>

        <span class="n">_pr</span><span class="p">(</span><span class="s2">&quot;resolved packages:&quot;</span><span class="p">,</span> <span class="n">heading</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">resolved_packages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolved_packages</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">source_order</span><span class="p">:</span>
            <span class="n">resolved_packages</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">resolved_packages</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">is_current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_current</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="n">resolved_packages</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">col</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">location</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># check for retargeted variant root (ie package caching)</span>
            <span class="n">pkg_root</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">root</span>

            <span class="k">if</span> <span class="n">is_current</span><span class="p">:</span>
                <span class="n">uname</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;REZ_&quot;</span> <span class="o">+</span> <span class="n">uname</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;_ORIG_ROOT&quot;</span><span class="p">):</span>
                    <span class="n">pkg_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span>
                        <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;_ROOT&quot;</span><span class="p">,</span>  <span class="c1"># will point to cache</span>
                        <span class="n">pkg</span><span class="o">.</span><span class="n">root</span>  <span class="c1"># in case some joker deletes the env-var!</span>
                    <span class="p">)</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;cached&quot;</span><span class="p">)</span>

            <span class="c1"># print root/uri</span>
            <span class="k">if</span> <span class="n">show_resolved_uris</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">pkg</span><span class="o">.</span><span class="n">root</span><span class="p">:</span>
                <span class="n">location</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">.</span><span class="n">uri</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">location</span> <span class="o">=</span> <span class="n">pkg_root</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pkg_root</span><span class="p">):</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;NOT FOUND&#39;</span><span class="p">)</span>
                    <span class="n">col</span> <span class="o">=</span> <span class="n">critical</span>

            <span class="k">if</span> <span class="n">pkg</span><span class="o">.</span><span class="n">is_local</span><span class="p">:</span>
                <span class="n">t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">)</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">local</span>

            <span class="n">t</span> <span class="o">=</span> <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pkg</span><span class="o">.</span><span class="n">qualified_package_name</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>
            <span class="n">colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

        <span class="c1"># add ephemerals to end of resolved packages list</span>
        <span class="n">ephemerals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolved_ephemerals</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">ephemerals</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ephemerals</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">ephemerals</span><span class="p">:</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">str</span><span class="p">(</span><span class="n">req</span><span class="p">),</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s2">&quot;(ephemeral)&quot;</span><span class="p">))</span>
            <span class="n">colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ephemeral_color</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">colors</span><span class="p">,</span> <span class="n">columnise</span><span class="p">(</span><span class="n">rows</span><span class="p">)):</span>
            <span class="n">_pr</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbosity</span><span class="p">:</span>
            <span class="n">_pr</span><span class="p">()</span>
            <span class="n">actual_solve_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solve_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_time</span>
            <span class="n">_pr</span><span class="p">(</span><span class="s2">&quot;resolve details:&quot;</span><span class="p">,</span> <span class="n">heading</span><span class="p">)</span>
            <span class="n">_pr</span><span class="p">(</span><span class="s2">&quot;load time:         </span><span class="si">%.02f</span><span class="s2"> secs&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_time</span><span class="p">)</span>
            <span class="n">_pr</span><span class="p">(</span><span class="s2">&quot;solve time:        </span><span class="si">%.02f</span><span class="s2"> secs&quot;</span> <span class="o">%</span> <span class="n">actual_solve_time</span><span class="p">)</span>
            <span class="n">_pr</span><span class="p">(</span><span class="s2">&quot;packages queried:  </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_loaded_packages</span><span class="p">)</span>
            <span class="n">_pr</span><span class="p">(</span><span class="s2">&quot;from cache:        </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_cache</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_path</span><span class="p">:</span>
                <span class="n">_pr</span><span class="p">(</span><span class="s2">&quot;rxt file:          </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">_pr</span><span class="p">()</span>
            <span class="n">_pr</span><span class="p">(</span><span class="s2">&quot;tools:&quot;</span><span class="p">,</span> <span class="n">heading</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_tools</span><span class="p">(</span><span class="n">buf</span><span class="o">=</span><span class="n">buf</span><span class="p">)</span></div>

<div class="viewcode-block" id="ResolvedContext.print_tools"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.ResolvedContext.print_tools">[docs]</a>    <span class="k">def</span> <span class="nf">print_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tools</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">_pr</span> <span class="o">=</span> <span class="n">Printer</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
        <span class="n">conflicts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_conflicting_tools</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;TOOL&quot;</span><span class="p">,</span> <span class="s2">&quot;PACKAGE&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s2">&quot;----&quot;</span><span class="p">,</span> <span class="s2">&quot;-------&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]]</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">variant</span><span class="p">,</span> <span class="n">tools</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">pkg_str</span> <span class="o">=</span> <span class="n">variant</span><span class="o">.</span><span class="n">qualified_package_name</span>
            <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tools</span><span class="p">):</span>
                <span class="n">col</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">tool</span><span class="p">,</span> <span class="n">pkg_str</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">conflicts</span><span class="p">:</span>
                    <span class="n">col</span> <span class="o">=</span> <span class="n">critical</span>
                    <span class="n">row</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;(in conflict)&quot;</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="n">colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">colors</span><span class="p">,</span> <span class="n">columnise</span><span class="p">(</span><span class="n">rows</span><span class="p">)):</span>
            <span class="n">_pr</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span></div>

<div class="viewcode-block" id="ResolvedContext.print_resolve_diff"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.ResolvedContext.print_resolve_diff">[docs]</a>    <span class="k">def</span> <span class="nf">print_resolve_diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">heading</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print the difference between the resolve of two contexts.</span>

<span class="sd">        Args:</span>
<span class="sd">            other (`ResolvedContext`): Context to compare to.</span>
<span class="sd">            heading: One of:</span>
<span class="sd">                - None: Do not display a heading;</span>
<span class="sd">                - True: Display the filename of each context as a heading, if</span>
<span class="sd">                  both contexts have a filepath;</span>
<span class="sd">                - 2-tuple: Use the given two strings as headings - the first is</span>
<span class="sd">                  the heading for `self`, the second for `other`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_resolve_diff</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">d</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">heading</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_path</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">load_path</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_path</span><span class="p">)</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">load_path</span><span class="p">)</span>
            <span class="n">heading</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">heading</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">heading</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">])</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">heading</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">heading</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>

        <span class="n">newer_packages</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;newer_packages&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">older_packages</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;older_packages&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">added_packages</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;added_packages&quot;</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
        <span class="n">removed_packages</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;removed_packages&quot;</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">newer_packages</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">pkgs</span> <span class="ow">in</span> <span class="n">newer_packages</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">this_pkg</span> <span class="o">=</span> <span class="n">pkgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">other_pkg</span> <span class="o">=</span> <span class="n">pkgs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">diff_str</span> <span class="o">=</span> <span class="s2">&quot;(+</span><span class="si">%d</span><span class="s2"> versions)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pkgs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">this_pkg</span><span class="o">.</span><span class="n">qualified_name</span><span class="p">,</span>
                            <span class="n">other_pkg</span><span class="o">.</span><span class="n">qualified_name</span><span class="p">,</span>
                            <span class="n">diff_str</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">older_packages</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">pkgs</span> <span class="ow">in</span> <span class="n">older_packages</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">this_pkg</span> <span class="o">=</span> <span class="n">pkgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">other_pkg</span> <span class="o">=</span> <span class="n">pkgs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">diff_str</span> <span class="o">=</span> <span class="s2">&quot;(-</span><span class="si">%d</span><span class="s2"> versions)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pkgs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">this_pkg</span><span class="o">.</span><span class="n">qualified_name</span><span class="p">,</span>
                            <span class="n">other_pkg</span><span class="o">.</span><span class="n">qualified_name</span><span class="p">,</span>
                            <span class="n">diff_str</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">added_packages</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">added_packages</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">pkg</span><span class="o">.</span><span class="n">qualified_name</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">removed_packages</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">removed_packages</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pkg</span><span class="o">.</span><span class="n">qualified_name</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">columnise</span><span class="p">(</span><span class="n">rows</span><span class="p">)))</span></div>

    <span class="k">def</span> <span class="nf">_on_success</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">nargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_</span> <span class="o">==</span> <span class="n">ResolverStatus</span><span class="o">.</span><span class="n">solved</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">nargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ResolvedContextError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot perform operation in a failed context&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_check</span>

<div class="viewcode-block" id="ResolvedContext.get_dependency_graph"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.ResolvedContext.get_dependency_graph">[docs]</a>    <span class="nd">@_on_success</span>
    <span class="k">def</span> <span class="nf">get_dependency_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">as_dot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate the dependency graph.</span>

<span class="sd">        The dependency graph is a simpler subset of the resolve graph. It</span>
<span class="sd">        contains package name nodes connected directly to their dependencies.</span>
<span class="sd">        Weak references and conflict requests are not included in the graph.</span>
<span class="sd">        The dependency graph does not show conflicts.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `pygraph.digraph` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">rez.vendor.pygraph.classes.digraph</span> <span class="kn">import</span> <span class="n">digraph</span>

        <span class="c1"># add nodes</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">variant</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolved_packages</span><span class="p">:</span>
            <span class="n">nodes</span><span class="p">[</span><span class="n">variant</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">variant</span><span class="o">.</span><span class="n">qualified_package_name</span>
        <span class="k">for</span> <span class="n">ephemeral</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolved_ephemerals</span><span class="p">:</span>
            <span class="n">nodes</span><span class="p">[</span><span class="n">ephemeral</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ephemeral</span><span class="p">)</span>

        <span class="c1"># add edges</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">variant</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolved_packages</span><span class="p">:</span>
            <span class="n">nodes</span><span class="p">[</span><span class="n">variant</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">variant</span><span class="o">.</span><span class="n">qualified_package_name</span>
            <span class="k">for</span> <span class="n">request</span> <span class="ow">in</span> <span class="n">variant</span><span class="o">.</span><span class="n">get_requires</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">conflict</span><span class="p">:</span>
                    <span class="n">edges</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">variant</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

        <span class="n">g</span> <span class="o">=</span> <span class="n">digraph</span><span class="p">()</span>
        <span class="n">node_color</span> <span class="o">=</span> <span class="s2">&quot;#AAFFAA&quot;</span>
        <span class="n">node_fontsize</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;fontsize&quot;</span><span class="p">,</span> <span class="n">node_fontsize</span><span class="p">),</span>
                 <span class="p">(</span><span class="s2">&quot;fillcolor&quot;</span><span class="p">,</span> <span class="n">node_color</span><span class="p">),</span>
                 <span class="p">(</span><span class="s2">&quot;style&quot;</span><span class="p">,</span> <span class="s2">&quot;filled&quot;</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">qname</span> <span class="ow">in</span> <span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="n">attrs</span> <span class="o">+</span> <span class="p">[(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">qname</span><span class="p">)])</span>
        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">as_dot</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">write_dot</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">g</span></div>

<div class="viewcode-block" id="ResolvedContext.validate"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.ResolvedContext.validate">[docs]</a>    <span class="nd">@_on_success</span>
    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate the context.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolved_packages</span><span class="p">:</span>
                <span class="n">pkg</span><span class="o">.</span><span class="n">validate_data</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">RezError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ResolvedContextError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span></div>

<div class="viewcode-block" id="ResolvedContext.get_environ"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.ResolvedContext.get_environ">[docs]</a>    <span class="nd">@_on_success</span>
    <span class="k">def</span> <span class="nf">get_environ</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_environ</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the environ dict resulting from interpreting this context.</span>

<span class="sd">        @param parent_environ Environment to interpret the context within,</span>
<span class="sd">            defaults to os.environ if None.</span>
<span class="sd">        @returns The environment dict generated by this context, when</span>
<span class="sd">            interpreted in a python rex interpreter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">interp</span> <span class="o">=</span> <span class="n">Python</span><span class="p">(</span><span class="n">target_environ</span><span class="o">=</span><span class="p">{},</span> <span class="n">passive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">executor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_executor</span><span class="p">(</span><span class="n">interp</span><span class="p">,</span> <span class="n">parent_environ</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_execute</span><span class="p">(</span><span class="n">executor</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">executor</span><span class="o">.</span><span class="n">get_output</span><span class="p">()</span></div>

<div class="viewcode-block" id="ResolvedContext.get_key"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.ResolvedContext.get_key">[docs]</a>    <span class="nd">@_on_success</span>
    <span class="k">def</span> <span class="nf">get_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">request_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a data key value for each resolved package.</span>

<span class="sd">        Args:</span>
<span class="sd">            key (str): String key of property, eg &#39;tools&#39;.</span>
<span class="sd">            request_only (bool): If True, only return the key from resolved</span>
<span class="sd">                packages that were also present in the request.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict of {pkg-name: (variant, value)}.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">requested_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_package_requests</span>
                           <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">conflict</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolved_packages</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">request_only</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">requested_names</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">values</span><span class="p">[</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">values</span></div>

<div class="viewcode-block" id="ResolvedContext.get_tools"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.ResolvedContext.get_tools">[docs]</a>    <span class="nd">@_on_success</span>
    <span class="k">def</span> <span class="nf">get_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the commandline tools available in the context.</span>

<span class="sd">        Args:</span>
<span class="sd">            request_only: If True, only return the tools from resolved packages</span>
<span class="sd">                that were also present in the request.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict of {pkg-name: (variant, [tools])}.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_key</span><span class="p">(</span><span class="s2">&quot;tools&quot;</span><span class="p">,</span> <span class="n">request_only</span><span class="o">=</span><span class="n">request_only</span><span class="p">)</span></div>

<div class="viewcode-block" id="ResolvedContext.get_tool_variants"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.ResolvedContext.get_tool_variants">[docs]</a>    <span class="nd">@_on_success</span>
    <span class="k">def</span> <span class="nf">get_tool_variants</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tool_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the variant(s) that provide the named tool.</span>

<span class="sd">        If there are more than one variants, the tool is in conflict, and Rez</span>
<span class="sd">        does not know which variant&#39;s tool is actually exposed.</span>

<span class="sd">        Args:</span>
<span class="sd">            tool_name(str): Name of the tool to search for.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Set of `Variant` objects. If no variant provides the tool, an</span>
<span class="sd">            empty set is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">variants</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">tools_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tools</span><span class="p">(</span><span class="n">request_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">variant</span><span class="p">,</span> <span class="n">tools</span> <span class="ow">in</span> <span class="n">tools_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">tool_name</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">:</span>
                <span class="n">variants</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">variant</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">variants</span></div>

<div class="viewcode-block" id="ResolvedContext.get_conflicting_tools"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.ResolvedContext.get_conflicting_tools">[docs]</a>    <span class="nd">@_on_success</span>
    <span class="k">def</span> <span class="nf">get_conflicting_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns tools of the same name provided by more than one package.</span>

<span class="sd">        Args:</span>
<span class="sd">            request_only: If True, only return the key from resolved packages</span>
<span class="sd">                that were also present in the request.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict of {tool-name: set([Variant])}.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

        <span class="n">tool_sets</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
        <span class="n">tools_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tools</span><span class="p">(</span><span class="n">request_only</span><span class="o">=</span><span class="n">request_only</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">variant</span><span class="p">,</span> <span class="n">tools</span> <span class="ow">in</span> <span class="n">tools_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">:</span>
                <span class="n">tool_sets</span><span class="p">[</span><span class="n">tool</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">variant</span><span class="p">)</span>

        <span class="n">conflicts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tool_sets</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">conflicts</span></div>

<div class="viewcode-block" id="ResolvedContext.get_shell_code"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.ResolvedContext.get_shell_code">[docs]</a>    <span class="nd">@_on_success</span>
    <span class="k">def</span> <span class="nf">get_shell_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent_environ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">OutputStyle</span><span class="o">.</span><span class="n">file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the shell code resulting from intepreting this context.</span>

<span class="sd">        Args:</span>
<span class="sd">            shell (str): Shell type, for eg &#39;bash&#39;. If None, the current shell</span>
<span class="sd">                type is used.</span>
<span class="sd">            parent_environ (dict): Environment to interpret the context within,</span>
<span class="sd">                defaults to os.environ if None.</span>
<span class="sd">            style (): Style to format shell code in.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">executor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_executor</span><span class="p">(</span><span class="n">interpreter</span><span class="o">=</span><span class="n">create_shell</span><span class="p">(</span><span class="n">shell</span><span class="p">),</span>
                                         <span class="n">parent_environ</span><span class="o">=</span><span class="n">parent_environ</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_path</span><span class="p">):</span>
            <span class="n">executor</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">REZ_RXT_FILE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_path</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_execute</span><span class="p">(</span><span class="n">executor</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">executor</span><span class="o">.</span><span class="n">get_output</span><span class="p">(</span><span class="n">style</span><span class="p">)</span></div>

<div class="viewcode-block" id="ResolvedContext.get_actions"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.ResolvedContext.get_actions">[docs]</a>    <span class="nd">@_on_success</span>
    <span class="k">def</span> <span class="nf">get_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_environ</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the list of rex.Action objects resulting from interpreting this</span>
<span class="sd">        context. This is provided mainly for testing purposes.</span>

<span class="sd">        Args:</span>
<span class="sd">            parent_environ Environment to interpret the context within,</span>
<span class="sd">                defaults to os.environ if None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list of rex.Action subclass instances.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">interp</span> <span class="o">=</span> <span class="n">Python</span><span class="p">(</span><span class="n">target_environ</span><span class="o">=</span><span class="p">{},</span> <span class="n">passive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">executor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_executor</span><span class="p">(</span><span class="n">interp</span><span class="p">,</span> <span class="n">parent_environ</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_execute</span><span class="p">(</span><span class="n">executor</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">executor</span><span class="o">.</span><span class="n">actions</span></div>

<div class="viewcode-block" id="ResolvedContext.apply"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.ResolvedContext.apply">[docs]</a>    <span class="nd">@_on_success</span>
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_environ</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply the context to the current python session.</span>

<span class="sd">        Note that this updates os.environ and possibly sys.path, if</span>
<span class="sd">        `parent_environ` is not provided.</span>

<span class="sd">        Args:</span>
<span class="sd">            parent_environ: Environment to interpret the context within,</span>
<span class="sd">                defaults to os.environ if None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">interpreter</span> <span class="o">=</span> <span class="n">Python</span><span class="p">(</span><span class="n">target_environ</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
        <span class="n">executor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_executor</span><span class="p">(</span><span class="n">interpreter</span><span class="p">,</span> <span class="n">parent_environ</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_execute</span><span class="p">(</span><span class="n">executor</span><span class="p">)</span>
        <span class="n">interpreter</span><span class="o">.</span><span class="n">apply_environ</span><span class="p">()</span></div>

<div class="viewcode-block" id="ResolvedContext.which"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.ResolvedContext.which">[docs]</a>    <span class="nd">@_on_success</span>
    <span class="k">def</span> <span class="nf">which</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">parent_environ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find a program in the resolved environment.</span>

<span class="sd">        Args:</span>
<span class="sd">            cmd: String name of the program to find.</span>
<span class="sd">            parent_environ: Environment to interpret the context within,</span>
<span class="sd">                defaults to os.environ if None.</span>
<span class="sd">            fallback: If True, and the program is not found in the context,</span>
<span class="sd">                the current environment will then be searched.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Path to the program, or None if the program was not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_environ</span><span class="p">(</span><span class="n">parent_environ</span><span class="o">=</span><span class="n">parent_environ</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fallback</span> <span class="ow">and</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">path</span></div>

<div class="viewcode-block" id="ResolvedContext.execute_command"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.ResolvedContext.execute_command">[docs]</a>    <span class="nd">@_on_success</span>
    <span class="k">def</span> <span class="nf">execute_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">parent_environ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">Popen_args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run a command within a resolved context.</span>

<span class="sd">        This applies the context to a python environ dict, then runs a</span>
<span class="sd">        subprocess in that namespace. This is not a fully configured subshell -</span>
<span class="sd">        shell-specific commands such as aliases will not be applied. To execute</span>
<span class="sd">        a command within a subshell instead, use execute_shell().</span>

<span class="sd">        Warning:</span>
<span class="sd">            This runs a command in a configured environ dict only, not in a true</span>
<span class="sd">            shell. To do that, call `execute_shell` using the `command` keyword</span>
<span class="sd">            argument.</span>

<span class="sd">        Args:</span>
<span class="sd">            args: Command arguments, can be a string.</span>
<span class="sd">            parent_environ: Environment to interpret the context within,</span>
<span class="sd">                defaults to os.environ if None.</span>
<span class="sd">            Popen_args: Args to pass to subprocess.Popen.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A subprocess.Popen object.</span>

<span class="sd">        Note:</span>
<span class="sd">            This does not alter the current python session.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">parent_environ</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">):</span>
            <span class="n">target_environ</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">target_environ</span> <span class="o">=</span> <span class="n">parent_environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">interpreter</span> <span class="o">=</span> <span class="n">Python</span><span class="p">(</span><span class="n">target_environ</span><span class="o">=</span><span class="n">target_environ</span><span class="p">)</span>

        <span class="n">executor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_executor</span><span class="p">(</span><span class="n">interpreter</span><span class="p">,</span> <span class="n">parent_environ</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_execute</span><span class="p">(</span><span class="n">executor</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">interpreter</span><span class="o">.</span><span class="n">subprocess</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">Popen_args</span><span class="p">)</span></div>

<div class="viewcode-block" id="ResolvedContext.execute_rex_code"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.ResolvedContext.execute_rex_code">[docs]</a>    <span class="nd">@_on_success</span>
    <span class="k">def</span> <span class="nf">execute_rex_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">parent_environ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">Popen_args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run some rex code in the context.</span>

<span class="sd">        Note:</span>
<span class="sd">            This is just a convenience form of `execute_shell`.</span>

<span class="sd">        Args:</span>
<span class="sd">            code (str): Rex code to execute.</span>
<span class="sd">            filename (str): Filename to report if there are syntax errors.</span>
<span class="sd">            shell: Shell type, for eg &#39;bash&#39;. If None, the current shell type</span>
<span class="sd">                is used.</span>
<span class="sd">            parent_environ: Environment to run the shell process in, if None</span>
<span class="sd">                then the current environment is used.</span>
<span class="sd">            Popen_args: args to pass to the shell process object constructor.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `subprocess.Popen` object for the shell process.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">_actions_callback</span><span class="p">(</span><span class="n">executor</span><span class="p">):</span>
            <span class="n">executor</span><span class="o">.</span><span class="n">execute_code</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_shell</span><span class="p">(</span><span class="n">shell</span><span class="o">=</span><span class="n">shell</span><span class="p">,</span>
                                  <span class="n">parent_environ</span><span class="o">=</span><span class="n">parent_environ</span><span class="p">,</span>
                                  <span class="n">command</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>  <span class="c1"># don&#39;t run any command</span>
                                  <span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                  <span class="n">post_actions_callback</span><span class="o">=</span><span class="n">_actions_callback</span><span class="p">,</span>
                                  <span class="o">**</span><span class="n">Popen_args</span><span class="p">)</span></div>

<div class="viewcode-block" id="ResolvedContext.execute_shell"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.ResolvedContext.execute_shell">[docs]</a>    <span class="nd">@_on_success</span>
    <span class="k">def</span> <span class="nf">execute_shell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent_environ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rcfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">norc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">block</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">actions_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">post_actions_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">context_filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start_new_session</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">detached</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">pre_command</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">Popen_args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Spawn a possibly-interactive shell.</span>

<span class="sd">        Args:</span>
<span class="sd">            shell: Shell type, for eg &#39;bash&#39;. If None, the current shell type</span>
<span class="sd">                is used.</span>
<span class="sd">            parent_environ: Environment to run the shell process in, if None</span>
<span class="sd">                then the current environment is used.</span>
<span class="sd">            rcfile: Specify a file to source instead of shell startup files.</span>
<span class="sd">            norc: If True, skip shell startup files, if possible.</span>
<span class="sd">            stdin: If True, read commands from stdin, in a non-interactive</span>
<span class="sd">                shell.</span>
<span class="sd">            command: If not None, execute this command in a non-interactive shell.</span>
<span class="sd">                If an empty string or list, don&#39;t run a command, but don&#39;t open</span>
<span class="sd">                an interactive shell either. Can be a list of args.</span>
<span class="sd">            quiet: If True, skip the welcome message in interactive shells.</span>
<span class="sd">            block: If True, block until the shell is terminated. If False,</span>
<span class="sd">                return immediately. If None, will default to blocking if the</span>
<span class="sd">                shell is interactive.</span>
<span class="sd">            actions_callback: Callback with signature (RexExecutor). This lets</span>
<span class="sd">                the user append custom actions to the context, such as setting</span>
<span class="sd">                extra environment variables. Callback is run prior to context Rex</span>
<span class="sd">                execution.</span>
<span class="sd">            post_actions_callback: Callback with signature (RexExecutor). This lets</span>
<span class="sd">                the user append custom actions to the context, such as setting</span>
<span class="sd">                extra environment variables. Callback is run after context Rex</span>
<span class="sd">                execution.</span>
<span class="sd">            context_filepath: If provided, the context file will be written</span>
<span class="sd">                here, rather than to the default location (which is in a</span>
<span class="sd">                tempdir). If you use this arg, you are responsible for cleaning</span>
<span class="sd">                up the file.</span>
<span class="sd">            start_new_session: If True, change the process group of the target</span>
<span class="sd">                process. Note that this may override the Popen_args keyword</span>
<span class="sd">                &#39;preexec_fn&#39;.</span>
<span class="sd">            detached: If True, open a separate terminal. Note that this may</span>
<span class="sd">                override the `pre_command` argument.</span>
<span class="sd">            pre_command: Command to inject before the shell command itself. This</span>
<span class="sd">                is for internal use.</span>
<span class="sd">            Popen_args: args to pass to the shell process object constructor.</span>

<span class="sd">        Returns:</span>
<span class="sd">            If blocking: A 3-tuple of (returncode, stdout, stderr);</span>
<span class="sd">            If non-blocking - A subprocess.Popen object for the shell process.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sh</span> <span class="o">=</span> <span class="n">create_shell</span><span class="p">(</span><span class="n">shell</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_non_string_iterable</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
            <span class="n">command</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

        <span class="c1"># start a new session if specified</span>
        <span class="k">if</span> <span class="n">start_new_session</span><span class="p">:</span>
            <span class="n">Popen_args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">new_session_popen_args</span><span class="p">)</span>

        <span class="c1"># open a separate terminal if specified</span>
        <span class="k">if</span> <span class="n">detached</span><span class="p">:</span>
            <span class="n">term_cmd</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">terminal_emulator_command</span>
            <span class="k">if</span> <span class="n">term_cmd</span><span class="p">:</span>
                <span class="n">pre_command</span> <span class="o">=</span> <span class="n">term_cmd</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

        <span class="c1"># block if the shell is likely to be interactive</span>
        <span class="k">if</span> <span class="n">block</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">block</span> <span class="o">=</span> <span class="ow">not</span> <span class="p">(</span><span class="n">command</span> <span class="ow">or</span> <span class="n">stdin</span><span class="p">)</span>

        <span class="c1"># context and rxt files. If running detached, don&#39;t cleanup files, because</span>
        <span class="c1"># rez-env returns too early and deletes the tmp files before the detached</span>
        <span class="c1"># process can use them</span>
        <span class="n">tmpdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir_manager</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">cleanup</span><span class="o">=</span><span class="ow">not</span> <span class="n">detached</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_path</span><span class="p">):</span>
            <span class="n">rxt_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rxt_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">,</span> <span class="s2">&quot;context.rxt&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">rxt_file</span><span class="p">)</span>

        <span class="n">context_file</span> <span class="o">=</span> <span class="n">context_filepath</span> <span class="ow">or</span> \
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">,</span> <span class="s2">&quot;context.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">sh</span><span class="o">.</span><span class="n">file_extension</span><span class="p">())</span>

        <span class="c1"># interpret this context and write out the native context (shell script) file</span>
        <span class="n">executor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_executor</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">parent_environ</span><span class="p">)</span>
        <span class="n">executor</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">REZ_RXT_FILE</span> <span class="o">=</span> <span class="n">rxt_file</span>
        <span class="n">executor</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">REZ_CONTEXT_FILE</span> <span class="o">=</span> <span class="n">context_file</span>

        <span class="k">if</span> <span class="n">actions_callback</span><span class="p">:</span>
            <span class="n">header_comment</span><span class="p">(</span><span class="n">executor</span><span class="p">,</span> <span class="s2">&quot;pre-actions-callback&quot;</span><span class="p">)</span>
            <span class="n">actions_callback</span><span class="p">(</span><span class="n">executor</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_execute</span><span class="p">(</span><span class="n">executor</span><span class="p">)</span>

        <span class="n">executor</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">REZ_SHELL_INIT_TIMESTAMP</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
        <span class="n">executor</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">REZ_SHELL_INTERACTIVE</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span> <span class="k">if</span> <span class="n">command</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;0&quot;</span>

        <span class="k">if</span> <span class="n">post_actions_callback</span><span class="p">:</span>
            <span class="n">header_comment</span><span class="p">(</span><span class="n">executor</span><span class="p">,</span> <span class="s2">&quot;post-actions-callback&quot;</span><span class="p">)</span>
            <span class="n">post_actions_callback</span><span class="p">(</span><span class="n">executor</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_execute_bundle_post_actions_callback</span><span class="p">(</span><span class="n">executor</span><span class="p">)</span>

        <span class="c1"># write out the native context file</span>
        <span class="n">context_code</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">get_output</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">context_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">context_code</span><span class="p">)</span>

        <span class="n">quiet</span> <span class="o">=</span> <span class="n">quiet</span> <span class="ow">or</span> \
            <span class="p">(</span><span class="n">RezToolsVisibility</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">rez_tools_visibility</span><span class="p">]</span> <span class="o">==</span> <span class="n">RezToolsVisibility</span><span class="o">.</span><span class="n">never</span><span class="p">)</span>

        <span class="c1"># spawn the shell subprocess</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">spawn_shell</span><span class="p">(</span><span class="n">context_file</span><span class="p">,</span>
                           <span class="n">tmpdir</span><span class="p">,</span>
                           <span class="n">rcfile</span><span class="o">=</span><span class="n">rcfile</span><span class="p">,</span>
                           <span class="n">norc</span><span class="o">=</span><span class="n">norc</span><span class="p">,</span>
                           <span class="n">stdin</span><span class="o">=</span><span class="n">stdin</span><span class="p">,</span>
                           <span class="n">command</span><span class="o">=</span><span class="n">command</span><span class="p">,</span>
                           <span class="n">env</span><span class="o">=</span><span class="n">parent_environ</span><span class="p">,</span>
                           <span class="n">quiet</span><span class="o">=</span><span class="n">quiet</span><span class="p">,</span>
                           <span class="n">pre_command</span><span class="o">=</span><span class="n">pre_command</span><span class="p">,</span>
                           <span class="o">**</span><span class="n">Popen_args</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">block</span><span class="p">:</span>
            <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">p</span></div>

<div class="viewcode-block" id="ResolvedContext.get_resolve_as_exact_requests"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.ResolvedContext.get_resolve_as_exact_requests">[docs]</a>    <span class="nd">@_on_success</span>
    <span class="k">def</span> <span class="nf">get_resolve_as_exact_requests</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert to a package request list of exact resolved package versions.</span>

<span class="sd">            &gt;&gt;&gt; r = ResolvedContext([&#39;foo&#39;]</span>
<span class="sd">            &gt;&gt;&gt; r.get_resolve_as_exact_requests()</span>
<span class="sd">            [&#39;foo==1.2.3&#39;, &#39;bah==1.0.1&#39;, &#39;python==2.7.12&#39;]</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of `PackageRequest`: Context as a list of exact version</span>
<span class="sd">            requests.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">to_req</span><span class="p">(</span><span class="n">variant</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">PackageRequest</span><span class="p">(</span><span class="n">variant</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">as_exact_requirement</span><span class="p">())</span>

        <span class="k">return</span> <span class="nb">map</span><span class="p">(</span><span class="n">to_req</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolved_packages</span><span class="p">)</span></div>

<div class="viewcode-block" id="ResolvedContext.to_dict"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.ResolvedContext.to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert context to dict containing only builtin types.</span>

<span class="sd">        Args:</span>
<span class="sd">            fields (list of str): If present, only write these fields into the</span>
<span class="sd">                dict. This can be used to avoid constructing expensive fields</span>
<span class="sd">                (such as &#39;graph&#39;) for some cases.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Dictified context.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span> <span class="nf">_add</span><span class="p">(</span><span class="n">field</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">fields</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">_add</span><span class="p">(</span><span class="s2">&quot;resolved_packages&quot;</span><span class="p">):</span>
            <span class="n">resolved_packages</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resolved_packages</span> <span class="ow">or</span> <span class="p">[]):</span>
                <span class="n">resolved_packages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;resolved_packages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resolved_packages</span>

            <span class="c1"># since serialization version 4.7</span>
            <span class="k">for</span> <span class="n">handle</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;resolved_packages&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_adjust_variant_for_bundling</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">_add</span><span class="p">(</span><span class="s2">&quot;resolved_ephemerals&quot;</span><span class="p">):</span>
            <span class="n">resolved_ephemerals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ephemeral</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resolved_ephemerals</span> <span class="ow">or</span> <span class="p">[]):</span>
                <span class="n">resolved_ephemerals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ephemeral</span><span class="p">))</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;resolved_ephemerals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resolved_ephemerals</span>

        <span class="k">if</span> <span class="n">_add</span><span class="p">(</span><span class="s2">&quot;serialize_version&quot;</span><span class="p">):</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;serialize_version&quot;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">ResolvedContext</span><span class="o">.</span><span class="n">serialize_version</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">_add</span><span class="p">(</span><span class="s2">&quot;patch_locks&quot;</span><span class="p">):</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;patch_locks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">patch_locks</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">_add</span><span class="p">(</span><span class="s2">&quot;package_orderers&quot;</span><span class="p">):</span>
            <span class="n">package_orderers</span> <span class="o">=</span> <span class="p">[</span><span class="n">package_order</span><span class="o">.</span><span class="n">to_pod</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package_orderers</span> <span class="ow">or</span> <span class="p">[])]</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;package_orderers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">package_orderers</span> <span class="ow">or</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">_add</span><span class="p">(</span><span class="s2">&quot;package_filter&quot;</span><span class="p">):</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;package_filter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_filter</span><span class="o">.</span><span class="n">to_pod</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">_add</span><span class="p">(</span><span class="s2">&quot;graph&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_string</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_string</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">):</span>
                <span class="n">graph_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_string</span>  <span class="c1"># already in compact format</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">()</span>
                <span class="n">graph_str</span> <span class="o">=</span> <span class="n">write_compacted</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;graph&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">graph_str</span>

        <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span>
            <span class="n">requested_timestamp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">requested_timestamp</span><span class="p">,</span>
            <span class="n">building</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">building</span><span class="p">,</span>
            <span class="n">caching</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">caching</span><span class="p">,</span>
            <span class="n">implicit_packages</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">implicit_packages</span><span class="p">)),</span>
            <span class="n">package_requests</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_package_requests</span><span class="p">)),</span>
            <span class="n">package_paths</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">package_paths</span><span class="p">,</span>

            <span class="n">append_sys_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">append_sys_path</span><span class="p">,</span>
            <span class="n">package_caching</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">package_caching</span><span class="p">,</span>

            <span class="n">default_patch_lock</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_patch_lock</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>

            <span class="n">rez_version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rez_version</span><span class="p">,</span>
            <span class="n">rez_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rez_path</span><span class="p">,</span>
            <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
            <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
            <span class="n">platform</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">platform</span><span class="p">,</span>
            <span class="n">arch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">arch</span><span class="p">,</span>
            <span class="n">os</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">os</span><span class="p">,</span>
            <span class="n">created</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">created</span><span class="p">,</span>

            <span class="n">parent_suite_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_suite_path</span><span class="p">,</span>
            <span class="n">suite_context_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">suite_context_name</span><span class="p">,</span>

            <span class="n">status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">status_</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">failure_description</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">failure_description</span><span class="p">,</span>

            <span class="n">from_cache</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">from_cache</span><span class="p">,</span>
            <span class="n">solve_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solve_time</span><span class="p">,</span>
            <span class="n">load_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">load_time</span><span class="p">,</span>
            <span class="n">num_loaded_packages</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_loaded_packages</span>
        <span class="p">))</span>

        <span class="k">if</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="ResolvedContext.from_dict"><a class="viewcode-back" href="../../api/rez.html#rez.resolved_context.ResolvedContext.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">identifier_str</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load a `ResolvedContext` from a dict.</span>

<span class="sd">        Args:</span>
<span class="sd">            d (dict): Dict containing context data.</span>
<span class="sd">            identifier_str (str): String identifying the context, this is only</span>
<span class="sd">                used to display in an error string if a serialization version</span>
<span class="sd">                mismatch is detected.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `ResolvedContext` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check serialization version</span>
        <span class="k">def</span> <span class="nf">_print_version</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">value</span><span class="p">)</span>

        <span class="n">toks</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;serialize_version&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="n">load_ver</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">toks</span><span class="p">)</span>
        <span class="n">curr_ver</span> <span class="o">=</span> <span class="n">ResolvedContext</span><span class="o">.</span><span class="n">serialize_version</span>

        <span class="k">if</span> <span class="n">load_ver</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">curr_ver</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;The context&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">identifier_str</span><span class="p">:</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">identifier_str</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;was written by a newer version of Rez. The load may &quot;</span>
                       <span class="s2">&quot;fail (serialize version </span><span class="si">%d</span><span class="s2"> &gt; </span><span class="si">%d</span><span class="s2">)&quot;</span>
                       <span class="o">%</span> <span class="p">(</span><span class="n">_print_version</span><span class="p">(</span><span class="n">load_ver</span><span class="p">),</span> <span class="n">_print_version</span><span class="p">(</span><span class="n">curr_ver</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

        <span class="c1"># create and init the context</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">ResolvedContext</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">ResolvedContext</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">load_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">r</span><span class="o">.</span><span class="n">pre_resolve_bindings</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">r</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span>
        <span class="n">r</span><span class="o">.</span><span class="n">building</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;building&quot;</span><span class="p">]</span>
        <span class="n">r</span><span class="o">.</span><span class="n">caching</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;caching&quot;</span><span class="p">]</span>
        <span class="n">r</span><span class="o">.</span><span class="n">implicit_packages</span> <span class="o">=</span> <span class="p">[</span><span class="n">PackageRequest</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;implicit_packages&quot;</span><span class="p">]]</span>
        <span class="n">r</span><span class="o">.</span><span class="n">_package_requests</span> <span class="o">=</span> <span class="p">[</span><span class="n">PackageRequest</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;package_requests&quot;</span><span class="p">]]</span>
        <span class="n">r</span><span class="o">.</span><span class="n">package_paths</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;package_paths&quot;</span><span class="p">]</span>

        <span class="n">r</span><span class="o">.</span><span class="n">rez_version</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;rez_version&quot;</span><span class="p">]</span>
        <span class="n">r</span><span class="o">.</span><span class="n">rez_path</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;rez_path&quot;</span><span class="p">]</span>
        <span class="n">r</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span>
        <span class="n">r</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;host&quot;</span><span class="p">]</span>
        <span class="n">r</span><span class="o">.</span><span class="n">platform</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;platform&quot;</span><span class="p">]</span>
        <span class="n">r</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;arch&quot;</span><span class="p">]</span>
        <span class="n">r</span><span class="o">.</span><span class="n">os</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;os&quot;</span><span class="p">]</span>
        <span class="n">r</span><span class="o">.</span><span class="n">created</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;created&quot;</span><span class="p">]</span>
        <span class="n">r</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;verbosity&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">r</span><span class="o">.</span><span class="n">status_</span> <span class="o">=</span> <span class="n">ResolverStatus</span><span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]]</span>
        <span class="n">r</span><span class="o">.</span><span class="n">failure_description</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;failure_description&quot;</span><span class="p">]</span>

        <span class="n">r</span><span class="o">.</span><span class="n">solve_time</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;solve_time&quot;</span><span class="p">]</span>
        <span class="n">r</span><span class="o">.</span><span class="n">load_time</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;load_time&quot;</span><span class="p">]</span>

        <span class="n">r</span><span class="o">.</span><span class="n">graph_string</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;graph&quot;</span><span class="p">]</span>
        <span class="n">r</span><span class="o">.</span><span class="n">graph_</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">r</span><span class="o">.</span><span class="n">_resolved_packages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">d_</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;resolved_packages&quot;</span><span class="p">]:</span>
            <span class="n">variant_handle</span> <span class="o">=</span> <span class="n">d_</span>
            <span class="k">if</span> <span class="n">load_ver</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                <span class="c1"># -- SINCE SERIALIZE VERSION 4.0</span>
                <span class="kn">from</span> <span class="nn">rez.utils.backcompat</span> <span class="kn">import</span> <span class="n">convert_old_variant_handle</span>
                <span class="n">variant_handle</span> <span class="o">=</span> <span class="n">convert_old_variant_handle</span><span class="p">(</span><span class="n">variant_handle</span><span class="p">)</span>

            <span class="c1"># -- SINCE SERIALIZE VERSION 4.7</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_adjust_variant_for_bundling</span><span class="p">(</span><span class="n">variant_handle</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">variant</span> <span class="o">=</span> <span class="n">get_variant</span><span class="p">(</span><span class="n">variant_handle</span><span class="p">)</span>
            <span class="n">variant</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="n">r</span><span class="o">.</span><span class="n">_resolved_packages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">variant</span><span class="p">)</span>

        <span class="c1"># -- SINCE SERIALIZE VERSION 1</span>

        <span class="n">r</span><span class="o">.</span><span class="n">requested_timestamp</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;requested_timestamp&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># -- SINCE SERIALIZE VERSION 2</span>

        <span class="n">r</span><span class="o">.</span><span class="n">parent_suite_path</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parent_suite_path&quot;</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">suite_context_name</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;suite_context_name&quot;</span><span class="p">)</span>

        <span class="c1"># -- SINCE SERIALIZE VERSION 3</span>

        <span class="n">r</span><span class="o">.</span><span class="n">default_patch_lock</span> <span class="o">=</span> <span class="n">PatchLock</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default_patch_lock&quot;</span><span class="p">,</span> <span class="s2">&quot;no_lock&quot;</span><span class="p">)]</span>
        <span class="n">patch_locks</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;patch_locks&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">r</span><span class="o">.</span><span class="n">patch_locks</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">PatchLock</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">patch_locks</span><span class="p">)</span>

        <span class="c1"># -- SINCE SERIALIZE VERSION 4.0</span>

        <span class="n">r</span><span class="o">.</span><span class="n">from_cache</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;from_cache&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># -- SINCE SERIALIZE VERSION 4.1</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;package_filter&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">r</span><span class="o">.</span><span class="n">package_filter</span> <span class="o">=</span> <span class="n">PackageFilterList</span><span class="o">.</span><span class="n">from_pod</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># -- SINCE SERIALIZE VERSION 4.2</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;package_orderers&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">package_orderers</span> <span class="o">=</span> <span class="p">[</span><span class="n">package_order</span><span class="o">.</span><span class="n">from_pod</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">package_orderers</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># -- SINCE SERIALIZE VERSION 4.3</span>

        <span class="n">r</span><span class="o">.</span><span class="n">num_loaded_packages</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_loaded_packages&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># -- SINCE SERIALIZE VERSION 4.4</span>

        <span class="n">r</span><span class="o">.</span><span class="n">append_sys_path</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;append_sys_path&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># -- SINCE SERIALIZE VERSION 4.5</span>

        <span class="n">r</span><span class="o">.</span><span class="n">package_caching</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;package_caching&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># -- SINCE SERIALIZE VERSION 4.6</span>

        <span class="n">r</span><span class="o">.</span><span class="n">_resolved_ephemerals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">eph_str</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resolved_ephemerals&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">req</span> <span class="o">=</span> <span class="n">Requirement</span><span class="p">(</span><span class="n">eph_str</span><span class="p">)</span>
            <span class="n">r</span><span class="o">.</span><span class="n">_resolved_ephemerals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>

        <span class="c1"># &lt;END SERIALIZATION&gt;</span>

        <span class="c1"># track context usage</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">context_tracking_host</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">context_tracking_context_fields</span><span class="p">)</span>

            <span class="n">r</span><span class="o">.</span><span class="n">_track_context</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;sourced&quot;</span><span class="p">)</span>

        <span class="c1"># update package cache</span>
        <span class="n">r</span><span class="o">.</span><span class="n">_update_package_cache</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">r</span></div>

    <span class="k">def</span> <span class="nf">_execute_bundle_post_actions_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">executor</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        In bundles, you can drop a &#39;post_commands.py&#39; file (rex) alongside the</span>
<span class="sd">        &#39;bundle.yaml&#39; file, and it will be sourced after all package commands.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_path</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect_bundle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_path</span><span class="p">):</span>
            <span class="n">bundle_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bundle_path</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">bundle_dir</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">rex_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bundle_dir</span><span class="p">,</span> <span class="s2">&quot;post_commands.py&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">rex_filepath</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="c1"># load the rex code an execute it within the executor</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">rex_filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">rex_py</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="n">header_comment</span><span class="p">(</span><span class="n">executor</span><span class="p">,</span> <span class="s2">&quot;bundle post-commands&quot;</span><span class="p">)</span>
        <span class="n">executor</span><span class="o">.</span><span class="n">execute_code</span><span class="p">(</span><span class="n">rex_py</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">_detect_bundle</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">bundle_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="n">bundle_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s2">&quot;bundle.yaml&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">bundle_filepath</span><span class="p">):</span>
                <span class="n">bundle_path</span> <span class="o">=</span> <span class="n">base_dir</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">bundle_path</span><span class="p">:</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">local</span><span class="o">.</span><span class="n">bundle_path</span> <span class="o">=</span> <span class="n">bundle_path</span>

            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">delattr</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">local</span><span class="p">,</span> <span class="s2">&quot;bundle_path&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_get_bundle_path</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">local</span><span class="p">,</span> <span class="s2">&quot;bundle_path&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_adjust_variant_for_bundling</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">out</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deals with making variant pkg repo ref relative/nonrelative to take</span>
<span class="sd">        bundling into account.</span>

<span class="sd">        Note: Alters `handle` in-place.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bundle_path</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_bundle_path</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bundle_path</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">vars_</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;variables&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">vars_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;repository_type&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;filesystem&quot;</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">repo_path</span> <span class="o">=</span> <span class="n">vars_</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span>

        <span class="c1"># serializing out, make repo relative</span>
        <span class="k">if</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">repo_path</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">is_subdirectory</span><span class="p">(</span><span class="n">repo_path</span><span class="p">,</span> <span class="n">bundle_path</span><span class="p">):</span>
                <span class="n">vars_</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">repo_path</span><span class="p">),</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">bundle_path</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="c1"># serializing in, make repo absolute</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">repo_path</span><span class="p">):</span>
                <span class="k">return</span>

            <span class="c1"># Must make canonical otherwise a symlinked path will cause it not</span>
            <span class="c1"># to match the repo location, which is always canonical.</span>
            <span class="c1">#</span>
            <span class="n">location</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bundle_path</span><span class="p">,</span> <span class="n">repo_path</span><span class="p">)</span>
            <span class="n">location</span> <span class="o">=</span> <span class="n">canonical_path</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">platform_</span><span class="p">)</span>
            <span class="n">vars_</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">location</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_get_package_cache</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="n">package_cache_present</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PackageCache</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">cache_packages_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">PackageCacheError</span><span class="p">:</span>
            <span class="n">print_warning</span><span class="p">(</span>
                <span class="s2">&quot;Package caching disabled (dir </span><span class="si">%s</span><span class="s2"> does not exist)&quot;</span><span class="p">,</span>
                <span class="n">config</span><span class="o">.</span><span class="n">cache_packages_path</span>
            <span class="p">)</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">package_cache_present</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_update_package_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_caching</span> <span class="ow">or</span> \
                <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">cache_packages_path</span> <span class="ow">or</span> \
                <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">write_package_cache</span> <span class="ow">or</span> \
                <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># see PackageCache.add_variants_async</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">system</span><span class="o">.</span><span class="n">is_production_rez_install</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">pkgcache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_package_cache</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pkgcache</span><span class="p">:</span>
            <span class="n">pkgcache</span><span class="o">.</span><span class="n">add_variants_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resolved_packages</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_init_context_tracking_payload_base</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">context_tracking_payload</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># note that this is the version of rez used to source the context,</span>
            <span class="c1"># which may not match the version used to _create_ the context</span>
            <span class="c1">#</span>
            <span class="s2">&quot;rez_version&quot;</span><span class="p">:</span> <span class="n">__version__</span><span class="p">,</span>

            <span class="s2">&quot;host&quot;</span><span class="p">:</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">(),</span>
            <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">context_tracking_extra_fields</span> <span class="ow">or</span> <span class="p">{})</span>

        <span class="c1"># remove fields with unexpanded env-vars, or empty string</span>
        <span class="k">def</span> <span class="nf">_del</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">basestring</span><span class="p">)</span>
                <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">value</span> <span class="ow">or</span> <span class="n">ENV_VAR_REGEX</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">deep_del</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">_del</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">cls</span><span class="o">.</span><span class="n">context_tracking_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">context_tracking_payload</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">context_tracking_payload</span> <span class="o">=</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">_track_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context_data</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
        <span class="c1"># create message payload</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>
            <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="n">context_data</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_init_context_tracking_payload_base</span><span class="p">()</span>
        <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context_tracking_payload</span><span class="p">)</span>

        <span class="c1"># publish message</span>
        <span class="n">routing_key</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">config</span><span class="o">.</span><span class="n">context_tracking_amqp</span><span class="p">[</span><span class="s2">&quot;exchange_routing_key&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">action</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">rez.utils.amqp</span> <span class="kn">import</span> <span class="n">publish_message</span>

            <span class="n">publish_message</span><span class="p">(</span>
                <span class="n">host</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">context_tracking_host</span><span class="p">,</span>
                <span class="n">amqp_settings</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">context_tracking_amqp</span><span class="p">,</span>
                <span class="n">routing_key</span><span class="o">=</span><span class="n">routing_key</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                <span class="n">block</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">print_error</span><span class="p">(</span>
                <span class="s2">&quot;Context tracking failed: </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">e</span>
            <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_read_from_buffer</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">identifier_str</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">content</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">):</span>  <span class="c1"># assume json content</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">FullLoader</span><span class="p">)</span>

        <span class="n">context</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">identifier_str</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_load_error</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">exc_name</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Failed to load context&quot;</span>
        <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot; from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">path</span>
        <span class="k">raise</span> <span class="n">ResolvedContextError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">exc_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_set_parent_suite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">suite_path</span><span class="p">,</span> <span class="n">context_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_suite_path</span> <span class="o">=</span> <span class="n">suite_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suite_context_name</span> <span class="o">=</span> <span class="n">context_name</span>

    <span class="k">def</span> <span class="nf">_create_executor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interpreter</span><span class="p">,</span> <span class="n">parent_environ</span><span class="p">):</span>
        <span class="n">parent_vars</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">all_parent_variables</span> \
            <span class="k">else</span> <span class="n">config</span><span class="o">.</span><span class="n">parent_variables</span>

        <span class="k">return</span> <span class="n">RexExecutor</span><span class="p">(</span><span class="n">interpreter</span><span class="o">=</span><span class="n">interpreter</span><span class="p">,</span>
                           <span class="n">parent_environ</span><span class="o">=</span><span class="n">parent_environ</span><span class="p">,</span>
                           <span class="n">parent_variables</span><span class="o">=</span><span class="n">parent_vars</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_pre_resolve_bindings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_resolve_bindings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pre_resolve_bindings</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="n">system</span><span class="p">,</span>
                <span class="s2">&quot;building&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">building</span><span class="p">,</span>
                <span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="n">RequirementsBinding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_package_requests</span><span class="p">),</span>
                <span class="s2">&quot;implicits&quot;</span><span class="p">:</span> <span class="n">RequirementsBinding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">implicit_packages</span><span class="p">),</span>
                <span class="s2">&quot;intersects&quot;</span><span class="p">:</span> <span class="n">intersects</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_resolve_bindings</span>

    <span class="nd">@pool_memcached_connections</span>
    <span class="k">def</span> <span class="nf">_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">executor</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Bind various info to the execution context</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">normalized</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">executor</span><span class="o">.</span><span class="n">normalize_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="n">resolved_pkgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolved_packages</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">ephemerals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolved_ephemerals</span> <span class="ow">or</span> <span class="p">[]</span>

        <span class="n">request_str</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_package_requests</span><span class="p">)</span>
        <span class="n">implicit_str</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">implicit_packages</span><span class="p">)</span>
        <span class="n">resolve_str</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">qualified_package_name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">resolved_pkgs</span><span class="p">)</span>
        <span class="n">local_packages_str</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">qualified_package_name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">resolved_pkgs</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">is_local</span><span class="p">)</span>
        <span class="n">req_timestamp_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">requested_timestamp</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">package_paths_str</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">interpreter</span><span class="o">.</span><span class="n">pathsep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">normalized</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_paths</span>
        <span class="p">)</span>

        <span class="n">header_comment</span><span class="p">(</span><span class="n">executor</span><span class="p">,</span> <span class="s2">&quot;system setup&quot;</span><span class="p">)</span>

        <span class="n">executor</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="s2">&quot;REZ_USED&quot;</span><span class="p">,</span> <span class="n">normalized</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rez_path</span><span class="p">))</span>
        <span class="n">executor</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="s2">&quot;REZ_USED_VERSION&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rez_version</span><span class="p">)</span>
        <span class="n">executor</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="s2">&quot;REZ_USED_TIMESTAMP&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">))</span>
        <span class="n">executor</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="s2">&quot;REZ_USED_REQUESTED_TIMESTAMP&quot;</span><span class="p">,</span> <span class="n">req_timestamp_str</span><span class="p">)</span>
        <span class="n">executor</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="s2">&quot;REZ_USED_REQUEST&quot;</span><span class="p">,</span> <span class="n">request_str</span><span class="p">)</span>
        <span class="n">executor</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="s2">&quot;REZ_USED_IMPLICIT_PACKAGES&quot;</span><span class="p">,</span> <span class="n">implicit_str</span><span class="p">)</span>
        <span class="n">executor</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="s2">&quot;REZ_USED_RESOLVE&quot;</span><span class="p">,</span> <span class="n">resolve_str</span><span class="p">)</span>
        <span class="n">executor</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="s2">&quot;REZ_USED_PACKAGES_PATH&quot;</span><span class="p">,</span> <span class="n">package_paths_str</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ephemerals</span><span class="p">:</span>
            <span class="n">eph_resolve_str</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ephemerals</span><span class="p">)</span>
            <span class="n">executor</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="s2">&quot;REZ_USED_EPH_RESOLVE&quot;</span><span class="p">,</span> <span class="n">eph_resolve_str</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">local_packages_str</span><span class="p">:</span>
            <span class="n">executor</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="s2">&quot;REZ_USED_LOCAL_RESOLVE&quot;</span><span class="p">,</span> <span class="n">local_packages_str</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">building</span><span class="p">:</span>
            <span class="n">executor</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="s2">&quot;REZ_BUILD_ENV&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">)</span>

        <span class="c1"># rez-1 environment variables, set in backwards compatibility mode</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">rez_1_environment_variables</span> <span class="ow">and</span> \
                <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">disable_rez_1_compatibility</span><span class="p">:</span>
            <span class="n">request_str_</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">request_str</span><span class="p">,</span> <span class="n">implicit_str</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">executor</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="s2">&quot;REZ_VERSION&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rez_version</span><span class="p">)</span>
            <span class="n">executor</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="s2">&quot;REZ_PATH&quot;</span><span class="p">,</span> <span class="n">normalized</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rez_path</span><span class="p">))</span>
            <span class="n">executor</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="s2">&quot;REZ_REQUEST&quot;</span><span class="p">,</span> <span class="n">request_str_</span><span class="p">)</span>
            <span class="n">executor</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="s2">&quot;REZ_RESOLVE&quot;</span><span class="p">,</span> <span class="n">resolve_str</span><span class="p">)</span>
            <span class="n">executor</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="s2">&quot;REZ_RAW_REQUEST&quot;</span><span class="p">,</span> <span class="n">request_str_</span><span class="p">)</span>
            <span class="n">executor</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="s2">&quot;REZ_RESOLVE_MODE&quot;</span><span class="p">,</span> <span class="s2">&quot;latest&quot;</span><span class="p">)</span>

        <span class="c1"># create variant bindings. Note that here we remap root for cases where</span>
        <span class="c1"># the variant has been cached into the package cache</span>
        <span class="c1">#</span>
        <span class="n">variant_bindings</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_caching</span> <span class="ow">and</span> \
                <span class="n">config</span><span class="o">.</span><span class="n">cache_packages_path</span> <span class="ow">and</span> \
                <span class="n">config</span><span class="o">.</span><span class="n">read_package_cache</span><span class="p">:</span>
            <span class="n">pkgcache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_package_cache</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pkgcache</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="n">resolved_pkgs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pkgcache</span><span class="p">:</span>
                <span class="n">cached_root</span> <span class="o">=</span> <span class="n">pkgcache</span><span class="o">.</span><span class="n">get_cached_root</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cached_root</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">variant_binding</span> <span class="o">=</span> <span class="n">VariantBinding</span><span class="p">(</span>
                <span class="n">pkg</span><span class="p">,</span> <span class="n">cached_root</span><span class="o">=</span><span class="n">cached_root</span><span class="p">,</span> <span class="n">interpreter</span><span class="o">=</span><span class="n">executor</span><span class="o">.</span><span class="n">interpreter</span>
            <span class="p">)</span>
            <span class="n">variant_bindings</span><span class="p">[</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">variant_binding</span>

        <span class="c1"># binds objects such as &#39;request&#39;, which are accessible before a resolve</span>
        <span class="n">pre_resolve_bindings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pre_resolve_bindings</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pre_resolve_bindings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">executor</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

        <span class="n">executor</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;resolve&quot;</span><span class="p">,</span> <span class="n">VariantsBinding</span><span class="p">(</span><span class="n">variant_bindings</span><span class="p">))</span>
        <span class="n">executor</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;ephemerals&quot;</span><span class="p">,</span> <span class="n">EphemeralsBinding</span><span class="p">(</span><span class="n">ephemerals</span><span class="p">))</span>

        <span class="c1">#</span>
        <span class="c1"># -- apply each resolved package to the execution context</span>
        <span class="c1">#</span>

        <span class="n">header_comment</span><span class="p">(</span><span class="n">executor</span><span class="p">,</span> <span class="s2">&quot;package variables&quot;</span><span class="p">)</span>

        <span class="c1"># TODO this is not having any effect. Below, a RexError is getting</span>
        <span class="c1"># raised on bad commands code, not a SourceCodeError</span>
        <span class="n">exc_type</span> <span class="o">=</span> <span class="n">SourceCodeError</span> <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">catch_rex_errors</span> <span class="k">else</span> <span class="n">_NeverError</span>

        <span class="c1"># set basic package variables and create per-package bindings</span>
        <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="n">resolved_pkgs</span><span class="p">:</span>
            <span class="n">minor_header_comment</span><span class="p">(</span><span class="n">executor</span><span class="p">,</span> <span class="s2">&quot;variables for package </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pkg</span><span class="o">.</span><span class="n">qualified_name</span><span class="p">)</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;REZ_&quot;</span> <span class="o">+</span> <span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>

            <span class="n">executor</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;_VERSION&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
            <span class="n">major_version</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">version</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">minor_version</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">version</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">patch_version</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">version</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">executor</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;_MAJOR_VERSION&quot;</span><span class="p">,</span> <span class="n">major_version</span><span class="p">)</span>
            <span class="n">executor</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;_MINOR_VERSION&quot;</span><span class="p">,</span> <span class="n">minor_version</span><span class="p">)</span>
            <span class="n">executor</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;_PATCH_VERSION&quot;</span><span class="p">,</span> <span class="n">patch_version</span><span class="p">)</span>
            <span class="n">executor</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;_BASE&quot;</span><span class="p">,</span> <span class="n">normalized</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">base</span><span class="p">))</span>

            <span class="n">variant_binding</span> <span class="o">=</span> <span class="n">variant_bindings</span><span class="p">[</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">variant_binding</span><span class="o">.</span><span class="n">_is_in_package_cache</span><span class="p">():</span>
                <span class="c1"># set to cached payload rather than original</span>
                <span class="n">executor</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;_ROOT&quot;</span><span class="p">,</span> <span class="n">variant_binding</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
                <span class="c1"># store extra var to indicate that root retarget occurred</span>
                <span class="n">executor</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;_ORIG_ROOT&quot;</span><span class="p">,</span> <span class="n">normalized</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">root</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">executor</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;_ROOT&quot;</span><span class="p">,</span> <span class="n">normalized</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">root</span><span class="p">))</span>

        <span class="c1"># package commands</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;pre_commands&quot;</span><span class="p">,</span> <span class="s2">&quot;commands&quot;</span><span class="p">,</span> <span class="s2">&quot;post_commands&quot;</span><span class="p">):</span>
            <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="n">resolved_pkgs</span><span class="p">:</span>
                <span class="n">commands</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">commands</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">header_comment</span><span class="p">(</span><span class="n">executor</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

                <span class="n">minor_header_comment</span><span class="p">(</span><span class="n">executor</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> from package </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">pkg</span><span class="o">.</span><span class="n">qualified_name</span><span class="p">))</span>
                <span class="n">variant_binding</span> <span class="o">=</span> <span class="n">variant_bindings</span><span class="p">[</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

                <span class="n">executor</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s1">&#39;this&#39;</span><span class="p">,</span> <span class="n">variant_binding</span><span class="p">)</span>
                <span class="n">executor</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">,</span> <span class="n">VersionBinding</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
                <span class="n">executor</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s1">&#39;root&#39;</span><span class="p">,</span> <span class="n">variant_binding</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
                <span class="n">executor</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s1">&#39;base&#39;</span><span class="p">,</span> <span class="n">normalized</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">base</span><span class="p">))</span>

                <span class="n">exc</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">commands</span><span class="o">.</span><span class="n">set_package</span><span class="p">(</span><span class="n">pkg</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">executor</span><span class="o">.</span><span class="n">execute_code</span><span class="p">(</span><span class="n">commands</span><span class="p">,</span> <span class="n">isolate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">exc_type</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">exc</span> <span class="o">=</span> <span class="n">e</span>

                <span class="k">if</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;Error in </span><span class="si">%s</span><span class="s2"> in package </span><span class="si">%r</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">pkg</span><span class="o">.</span><span class="n">uri</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="n">exc</span><span class="o">.</span><span class="n">short_msg</span>

                    <span class="k">raise</span> <span class="n">PackageCommandError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># clear bindings from last variant. Note that we could&#39;ve used</span>
        <span class="c1"># executor.reset_globals to do this, however manually clearing the last</span>
        <span class="c1"># bindings avoid lots of dict copies and updates.</span>
        <span class="c1">#</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;this&quot;</span><span class="p">,</span> <span class="s2">&quot;version&quot;</span><span class="p">,</span> <span class="s2">&quot;root&quot;</span><span class="p">,</span> <span class="s2">&quot;base&quot;</span><span class="p">):</span>
            <span class="n">executor</span><span class="o">.</span><span class="n">unbind</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># set variables per ephemeral</span>
        <span class="c1"># for eph &#39;.foo-1.2&#39; for eg, $REZ_EPH_FOO_REQUEST=&quot;1.2&quot;</span>
        <span class="k">if</span> <span class="n">ephemerals</span><span class="p">:</span>
            <span class="n">header_comment</span><span class="p">(</span><span class="n">executor</span><span class="p">,</span> <span class="s2">&quot;ephemeral variables&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">eph_req</span> <span class="ow">in</span> <span class="n">ephemerals</span><span class="p">:</span>
                <span class="n">uname</span> <span class="o">=</span> <span class="n">eph_req</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
                <span class="n">varname</span> <span class="o">=</span> <span class="s2">&quot;REZ_EPH_&quot;</span> <span class="o">+</span> <span class="n">uname</span> <span class="o">+</span> <span class="s2">&quot;_REQUEST&quot;</span>
                <span class="n">executor</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">eph_req</span><span class="o">.</span><span class="n">range</span><span class="p">))</span>

        <span class="n">header_comment</span><span class="p">(</span><span class="n">executor</span><span class="p">,</span> <span class="s2">&quot;post system setup&quot;</span><span class="p">)</span>

        <span class="c1"># append suite paths based on suite visibility setting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_append_suite_paths</span><span class="p">(</span><span class="n">executor</span><span class="p">)</span>

        <span class="c1"># append system paths</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_sys_path</span><span class="p">:</span>
            <span class="n">executor</span><span class="o">.</span><span class="n">append_system_paths</span><span class="p">()</span>

        <span class="c1"># add rez path so that rez commandline tools are still available within</span>
        <span class="c1"># the resolved environment</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">RezToolsVisibility</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">rez_tools_visibility</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">RezToolsVisibility</span><span class="o">.</span><span class="n">append</span><span class="p">:</span>
            <span class="n">executor</span><span class="o">.</span><span class="n">append_rez_path</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">RezToolsVisibility</span><span class="o">.</span><span class="n">prepend</span><span class="p">:</span>
            <span class="n">executor</span><span class="o">.</span><span class="n">prepend_rez_path</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_append_suite_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">executor</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">rez.suite</span> <span class="kn">import</span> <span class="n">Suite</span>

        <span class="n">mode</span> <span class="o">=</span> <span class="n">SuiteVisibility</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">suite_visibility</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">SuiteVisibility</span><span class="o">.</span><span class="n">never</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">visible_suite_paths</span> <span class="o">=</span> <span class="n">Suite</span><span class="o">.</span><span class="n">visible_suite_paths</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">visible_suite_paths</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">suite_paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">SuiteVisibility</span><span class="o">.</span><span class="n">always</span><span class="p">:</span>
            <span class="n">suite_paths</span> <span class="o">=</span> <span class="n">visible_suite_paths</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_suite_path</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">SuiteVisibility</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
                <span class="n">suite_paths</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_suite_path</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">SuiteVisibility</span><span class="o">.</span><span class="n">parent_priority</span><span class="p">:</span>
                <span class="n">pop_parent</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">parent_index</span> <span class="o">=</span> <span class="n">visible_suite_paths</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_suite_path</span><span class="p">)</span>
                    <span class="n">pop_parent</span> <span class="o">=</span> <span class="n">visible_suite_paths</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">parent_index</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">suite_paths</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">pop_parent</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_suite_path</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">suite_paths</span><span class="p">:</span>
            <span class="n">tools_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;bin&quot;</span><span class="p">)</span>
            <span class="n">executor</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">PATH</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tools_path</span><span class="p">)</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2014, Allan Johns.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>